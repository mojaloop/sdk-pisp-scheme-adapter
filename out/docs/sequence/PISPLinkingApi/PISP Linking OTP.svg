<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="7019px" preserveAspectRatio="none" style="width:4807px;height:7019px;" version="1.1" viewBox="0 0 4807 7019" width="4807px" zoomAndPan="magnify"><defs><filter height="300%" id="f1xo8zv985jk6o" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="151" x="2324.75" y="28.708">PISP Linking OTP</text><rect fill="#DDDDDD" height="6972.8438" style="stroke:#A80036;stroke-width:1.0;" width="1122.5" x="484.5" y="40.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="180" x="955.75" y="53.02">PISP tp-scheme-adapter</text><rect fill="#DDDDDD" height="6972.8438" style="stroke:#A80036;stroke-width:1.0;" width="920.5" x="2022" y="40.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="67" x="2448.75" y="53.02">Mojaloop</text><rect fill="#DDDDDD" height="6972.8438" style="stroke:#A80036;stroke-width:1.0;" width="658" x="3213" y="40.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="186" x="3449" y="53.02">DFSP tp-scheme-adapter</text><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="1632.5625" style="stroke:#A80036;stroke-width:1.0;" width="10" x="71.5" y="202.7813"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="4741.6328" style="stroke:#A80036;stroke-width:1.0;" width="10" x="71.5" y="2224.8672"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="1632.5625" style="stroke:#A80036;stroke-width:1.0;" width="10" x="550.5" y="202.7813"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="4741.6328" style="stroke:#A80036;stroke-width:1.0;" width="10" x="550.5" y="2224.8672"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="402.6563" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1026.5" y="461.375"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="133.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1026.5" y="1672.6797"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="209.1953" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1026.5" y="2407.7969"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="618.7188" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1026.5" y="3647.5703"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="91.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1026.5" y="6728.1719"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="58.2656" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1536.5" y="1643.5469"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="100.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1536.5" y="3576.3047"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="100.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1536.5" y="6656.9063"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="347.5234" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="574.7734"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="332.3906" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="1340.2891"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="196.1953" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="2479.0625"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="297.7266" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="3378.9766"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="485.0547" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="3977.0313"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="954.9766" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="4717.4141"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="297.7266" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="6459.5781"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="652.7188" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2400.5" y="5077.9375"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="233.9297" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2841.5" y="5701.5234"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="133.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3273.5" y="893.1641"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="133.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3273.5" y="2646.125"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="166.6641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3273.5" y="4295.4219"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="175.6641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3273.5" y="5496.7266"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="175.6641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3273.5" y="5759.7891"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="587.7188" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3789.5" y="1026.6953"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="767.5156" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3789.5" y="2779.6563"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="641.9844" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3789.5" y="4399.8203"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="984.5156" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3789.5" y="5643.2578"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="180.0625" style="stroke:#A80036;stroke-width:1.0;" width="10" x="4297.5" y="1097.9609"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="279.3281" style="stroke:#000000;stroke-width:2.0;" width="1861" x="2016" y="6025.7188"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="76" x2="76" y1="95.3828" y2="6975.5"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="555.5" x2="555.5" y1="95.3828" y2="6975.5"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1031.5" x2="1031.5" y1="95.3828" y2="6975.5"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1541" x2="1541" y1="95.3828" y2="6975.5"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="2057" x2="2057" y1="95.3828" y2="6975.5"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="2405.5" x2="2405.5" y1="95.3828" y2="6975.5"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="2846.5" x2="2846.5" y1="95.3828" y2="6975.5"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="3278" x2="3278" y1="95.3828" y2="6975.5"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="3794" x2="3794" y1="95.3828" y2="6975.5"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="4302" x2="4302" y1="95.3828" y2="6975.5"/><rect fill="#FEFECE" filter="url(#f1xo8zv985jk6o)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="109" x="20" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="95" x="27" y="80.0811">PISP Backend</text><rect fill="#FEFECE" filter="url(#f1xo8zv985jk6o)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="109" x="20" y="6974.5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="95" x="27" y="6994.4951">PISP Backend</text><rect fill="#FEFECE" filter="url(#f1xo8zv985jk6o)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="130" x="488.5" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="116" x="495.5" y="80.0811">outbound-server</text><rect fill="#FEFECE" filter="url(#f1xo8zv985jk6o)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="130" x="488.5" y="6974.5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="116" x="495.5" y="6994.4951">outbound-server</text><rect fill="#FEFECE" filter="url(#f1xo8zv985jk6o)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="134" x="962.5" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="120" x="969.5" y="80.0811">PISPLinkingModel</text><rect fill="#FEFECE" filter="url(#f1xo8zv985jk6o)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="134" x="962.5" y="6974.5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="120" x="969.5" y="6994.4951">PISPLinkingModel</text><rect fill="#FEFECE" filter="url(#f1xo8zv985jk6o)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="119" x="1480" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="105" x="1487" y="80.0811">inbound-server</text><rect fill="#FEFECE" filter="url(#f1xo8zv985jk6o)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="119" x="1480" y="6974.5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="105" x="1487" y="6994.4951">inbound-server</text><rect fill="#FEFECE" filter="url(#f1xo8zv985jk6o)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="59" x="2026" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="45" x="2033" y="80.0811">Switch</text><rect fill="#FEFECE" filter="url(#f1xo8zv985jk6o)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="59" x="2026" y="6974.5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="45" x="2033" y="6994.4951">Switch</text><rect fill="#FEFECE" filter="url(#f1xo8zv985jk6o)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="100" x="2353.5" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="86" x="2360.5" y="80.0811">Auth Service</text><rect fill="#FEFECE" filter="url(#f1xo8zv985jk6o)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="100" x="2353.5" y="6974.5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="86" x="2360.5" y="6994.4951">Auth Service</text><rect fill="#FEFECE" filter="url(#f1xo8zv985jk6o)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="180" x="2754.5" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="166" x="2761.5" y="80.0811">Account Lookup Service</text><rect fill="#FEFECE" filter="url(#f1xo8zv985jk6o)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="180" x="2754.5" y="6974.5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="166" x="2761.5" y="6994.4951">Account Lookup Service</text><rect fill="#FEFECE" filter="url(#f1xo8zv985jk6o)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="119" x="3217" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="105" x="3224" y="80.0811">inbound-server</text><rect fill="#FEFECE" filter="url(#f1xo8zv985jk6o)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="119" x="3217" y="6974.5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="105" x="3224" y="6994.4951">inbound-server</text><rect fill="#FEFECE" filter="url(#f1xo8zv985jk6o)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="141" x="3722" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="127" x="3729" y="80.0811">DFSPLinkingModel</text><rect fill="#FEFECE" filter="url(#f1xo8zv985jk6o)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="141" x="3722" y="6974.5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="127" x="3729" y="6994.4951">DFSPLinkingModel</text><rect fill="#FEFECE" filter="url(#f1xo8zv985jk6o)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="181" x="4210" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="167" x="4217" y="80.0811">DFSPAuthorizeSimulator</text><rect fill="#FEFECE" filter="url(#f1xo8zv985jk6o)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="181" x="4210" y="6974.5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="167" x="4217" y="6994.4951">DFSPAuthorizeSimulator</text><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="1632.5625" style="stroke:#A80036;stroke-width:1.0;" width="10" x="71.5" y="202.7813"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="4741.6328" style="stroke:#A80036;stroke-width:1.0;" width="10" x="71.5" y="2224.8672"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="1632.5625" style="stroke:#A80036;stroke-width:1.0;" width="10" x="550.5" y="202.7813"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="4741.6328" style="stroke:#A80036;stroke-width:1.0;" width="10" x="550.5" y="2224.8672"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="402.6563" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1026.5" y="461.375"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="133.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1026.5" y="1672.6797"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="209.1953" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1026.5" y="2407.7969"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="618.7188" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1026.5" y="3647.5703"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="91.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1026.5" y="6728.1719"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="58.2656" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1536.5" y="1643.5469"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="100.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1536.5" y="3576.3047"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="100.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1536.5" y="6656.9063"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="347.5234" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="574.7734"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="332.3906" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="1340.2891"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="196.1953" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="2479.0625"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="297.7266" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="3378.9766"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="485.0547" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="3977.0313"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="954.9766" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="4717.4141"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="297.7266" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="6459.5781"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="652.7188" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2400.5" y="5077.9375"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="233.9297" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2841.5" y="5701.5234"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="133.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3273.5" y="893.1641"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="133.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3273.5" y="2646.125"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="166.6641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3273.5" y="4295.4219"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="175.6641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3273.5" y="5496.7266"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="175.6641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3273.5" y="5759.7891"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="587.7188" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3789.5" y="1026.6953"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="767.5156" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3789.5" y="2779.6563"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="641.9844" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3789.5" y="4399.8203"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="984.5156" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3789.5" y="5643.2578"/><rect fill="#FFFFFF" filter="url(#f1xo8zv985jk6o)" height="180.0625" style="stroke:#A80036;stroke-width:1.0;" width="10" x="4297.5" y="1097.9609"/><rect fill="#EEEEEE" filter="url(#f1xo8zv985jk6o)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="4800.5" x="0" y="125.9492"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="4800.5" y1="125.9492" y2="125.9492"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="4800.5" y1="128.9492" y2="128.9492"/><rect fill="#EEEEEE" filter="url(#f1xo8zv985jk6o)" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="189" x="2305.75" y="115.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="170" x="2311.75" y="131.4497">Request Consent - OTP</text><rect fill="#FBFB77" filter="url(#f1xo8zv985jk6o)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="485" x="81" y="153.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="477" x="85" y="169.5825">PISP presents accounts to user. User selects one or more accounts to link.</text><polygon fill="#A80036" points="538.5,198.7813,548.5,202.7813,538.5,206.7813,542.5,202.7813" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="81.5" x2="544.5" y1="202.7813" y2="202.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="88.5" y="197.7153">REQUEST-CONSENT-1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="246.5" y="197.7153">POST /linking/request-consent</text><rect fill="#ADD8E6" filter="url(#f1xo8zv985jk6o)" height="144" style="stroke:#A80036;stroke-width:1.0;" width="570" x="86" y="215.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="90" y="231.8481">POST /linking/request-consent</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="90" y="246.981">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="98" y="262.1138">accounts: [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="507" x="106" y="277.2466">{ accountNickname: "XXXXXXnt", id: "dfspa.username.1234", currency: "ZAR" },</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="546" x="106" y="292.3794">{ accountNickname: "SpeXXXXXXXXnt", id: "dfspa.username.5678", currency: "USD" }</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="9" x="98" y="307.5122">],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="541" x="98" y="322.645">userId: "username1234", // so the dfsp can associate this request with GET /accounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="204" x="98" y="337.7778">callbackURI: 'pisp-app://callback'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="90" y="352.9106">}</text><line style="stroke:#A80036;stroke-width:1.0;" x1="560.5" x2="602.5" y1="386.1094" y2="386.1094"/><line style="stroke:#A80036;stroke-width:1.0;" x1="602.5" x2="602.5" y1="386.1094" y2="399.1094"/><line style="stroke:#A80036;stroke-width:1.0;" x1="561.5" x2="602.5" y1="399.1094" y2="399.1094"/><polygon fill="#A80036" points="571.5,395.1094,561.5,399.1094,571.5,403.1094,567.5,399.1094" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="567.5" y="381.0435">REQUEST-CONSENT-2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="186" x="725.5" y="381.0435">const model = await create()</text><rect fill="#FBFB77" filter="url(#f1xo8zv985jk6o)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="79" x="565" y="412.1094"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="569" y="428.1763">state: start</text><polygon fill="#A80036" points="1014.5,457.375,1024.5,461.375,1014.5,465.375,1018.5,461.375" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="560.5" x2="1020.5" y1="461.375" y2="461.375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="567.5" y="456.3091">REQUEST-CONSENT-3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="156" x="725.5" y="456.3091">model.requestConsent()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1036.5" x2="1078.5" y1="490.5078" y2="490.5078"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1078.5" x2="1078.5" y1="490.5078" y2="503.5078"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1037.5" x2="1078.5" y1="503.5078" y2="503.5078"/><polygon fill="#A80036" points="1047.5,499.5078,1037.5,503.5078,1047.5,507.5078,1043.5,503.5078" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="1043.5" y="485.4419">REQUEST-CONSENT-4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="277" x="1201.5" y="485.4419">ThirdpartyRequests.postConsentRequests()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1036.5" x2="1078.5" y1="532.6406" y2="532.6406"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1078.5" x2="1078.5" y1="532.6406" y2="545.6406"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1037.5" x2="1078.5" y1="545.6406" y2="545.6406"/><polygon fill="#A80036" points="1047.5,541.6406,1037.5,545.6406,1047.5,549.6406,1043.5,545.6406" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="1043.5" y="527.5747">REQUEST-CONSENT-5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="209" x="1201.5" y="527.5747">const consentRequestId = uuid()</text><polygon fill="#A80036" points="2040.5,570.7734,2050.5,574.7734,2040.5,578.7734,2044.5,574.7734" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1036.5" x2="2046.5" y1="574.7734" y2="574.7734"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="1043.5" y="569.7075">REQUEST-CONSENT-6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="152" x="1201.5" y="569.7075">POST /consentRequests</text><rect fill="#ADD8E6" filter="url(#f1xo8zv985jk6o)" height="250" style="stroke:#A80036;stroke-width:1.0;" width="358" x="1041" y="587.7734"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="152" x="1045" y="603.8403">POST /consentRequests</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="1045" y="618.9731">FSIOP-Source: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="1045" y="634.106">FSIOP-Destination: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1045" y="649.2388">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154" x="1053" y="664.3716">consentRequestId: 6789</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154" x="1053" y="679.5044">userId: "username1234"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66" x="1053" y="694.6372">scopes: [{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="1061" y="709.77">accountId: 'dfspa.username.1234',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="1061" y="724.9028">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="1061" y="740.0356">accountId: 'dfspa.username.5678',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="1061" y="755.1685">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="17" x="1053" y="770.3013">}],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="208" x="1053" y="785.4341">// model will add `authChannels`</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="1053" y="800.5669">authChannels: ["WEB", "OTP"],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="216" x="1053" y="815.6997">callbackURI: 'pisp-app://callback...'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1045" y="830.8325">}</text><polygon fill="#A80036" points="1042.5,860.0313,1032.5,864.0313,1042.5,868.0313,1038.5,864.0313" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1036.5" x2="2051.5" y1="864.0313" y2="864.0313"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="1048.5" y="858.9653">REQUEST-CONSENT-7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="1206.5" y="858.9653">202 Accepted</text><polygon fill="#A80036" points="3261.5,889.1641,3271.5,893.1641,3261.5,897.1641,3265.5,893.1641" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2062.5" x2="3267.5" y1="893.1641" y2="893.1641"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="2069.5" y="888.0981">REQUEST-CONSENT-8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="152" x="2227.5" y="888.0981">POST /consentRequests</text><polygon fill="#A80036" points="2068.5,918.2969,2058.5,922.2969,2068.5,926.2969,2064.5,922.2969" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2062.5" x2="3272.5" y1="922.2969" y2="922.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="2074.5" y="917.231">REQUEST-CONSENT-9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2232.5" y="917.231">202 Accepted</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3283.5" x2="3325.5" y1="951.4297" y2="951.4297"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3325.5" x2="3325.5" y1="951.4297" y2="964.4297"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3284.5" x2="3325.5" y1="964.4297" y2="964.4297"/><polygon fill="#A80036" points="3294.5,960.4297,3284.5,964.4297,3294.5,968.4297,3290.5,964.4297" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="3290.5" y="946.3638">REQUEST-CONSENT-10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="186" x="3457.5" y="946.3638">const model = await create()</text><rect fill="#FBFB77" filter="url(#f1xo8zv985jk6o)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="79" x="3288" y="977.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="3292" y="993.4966">state: start</text><polygon fill="#A80036" points="3777.5,1022.6953,3787.5,1026.6953,3777.5,1030.6953,3781.5,1026.6953" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3278.5" x2="3783.5" y1="1026.6953" y2="1026.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="3285.5" y="1021.6294">REQUEST-CONSENT-11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="156" x="3452.5" y="1021.6294">model.requestConsent()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3841.5" y1="1055.8281" y2="1055.8281"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3841.5" x2="3841.5" y1="1055.8281" y2="1068.8281"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3800.5" x2="3841.5" y1="1068.8281" y2="1068.8281"/><polygon fill="#A80036" points="3810.5,1064.8281,3800.5,1068.8281,3810.5,1072.8281,3806.5,1068.8281" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="3806.5" y="1050.7622">REQUEST-CONSENT-12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="317" x="3973.5" y="1050.7622">DFSPBackendRequests.validateConsentRequest()</text><polygon fill="#A80036" points="4285.5,1093.9609,4295.5,1097.9609,4285.5,1101.9609,4289.5,1097.9609" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="4291.5" y1="1097.9609" y2="1097.9609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="3806.5" y="1092.895">REQUEST-CONSENT-13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="98" x="3973.5" y="1092.895">POST /sendOTP</text><rect fill="#ADD8E6" filter="url(#f1xo8zv985jk6o)" height="98" style="stroke:#A80036;stroke-width:1.0;" width="204" x="3804" y="1110.9609"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="98" x="3808" y="1127.0278">POST /sendOTP</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3808" y="1142.1606">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="3816" y="1157.2935">consentRequestId: 6789,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="188" x="3816" y="1172.4263">username: "username.1234",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="109" x="3816" y="1187.5591">message: "0987"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3808" y="1202.6919">}</text><line style="stroke:#A80036;stroke-width:1.0;" x1="4307.5" x2="4349.5" y1="1235.8906" y2="1235.8906"/><line style="stroke:#A80036;stroke-width:1.0;" x1="4349.5" x2="4349.5" y1="1235.8906" y2="1248.8906"/><line style="stroke:#A80036;stroke-width:1.0;" x1="4308.5" x2="4349.5" y1="1248.8906" y2="1248.8906"/><polygon fill="#A80036" points="4318.5,1244.8906,4308.5,1248.8906,4318.5,1252.8906,4314.5,1248.8906" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="4314.5" y="1230.8247">REQUEST-CONSENT-14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="307" x="4481.5" y="1230.8247">take action on TTK for defined rule for username</text><polygon fill="#A80036" points="3810.5,1274.0234,3800.5,1278.0234,3810.5,1282.0234,3806.5,1278.0234" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3804.5" x2="4301.5" y1="1278.0234" y2="1278.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="3816.5" y="1272.9575">REQUEST-CONSENT-15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="3983.5" y="1272.9575">200 OK</text><rect fill="#FBFB77" filter="url(#f1xo8zv985jk6o)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="280" x="3804" y="1291.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="272" x="3808" y="1307.0903">state: consentRequestValidatedAndStored</text><polygon fill="#A80036" points="2073.5,1336.2891,2063.5,1340.2891,2073.5,1344.2891,2069.5,1340.2891" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2067.5" x2="3788.5" y1="1340.2891" y2="1340.2891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="2079.5" y="1335.2231">REQUEST-CONSENT-16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="179" x="2246.5" y="1335.2231">PUT /consentRequests/6789</text><rect fill="#ADD8E6" filter="url(#f1xo8zv985jk6o)" height="234" style="stroke:#A80036;stroke-width:1.0;" width="380" x="3404" y="1353.2891"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="179" x="3408" y="1369.356">PUT /consentRequests/6789</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="3408" y="1384.4888">FSIOP-Source: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="3408" y="1399.6216">FSIOP-Destination: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3408" y="1414.7544">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154" x="3416" y="1429.8872">consentRequestId: 6789</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66" x="3416" y="1445.02">scopes: [{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="3424" y="1460.1528">accountId: 'dfspa.username.1234',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="3424" y="1475.2856">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="3424" y="1490.4185">accountId: 'dfspa.username.5678',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="3424" y="1505.5513">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="17" x="3416" y="1520.6841">}],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="364" x="3416" y="1535.8169">authChannels: ["OTP"], // updated with the channel in use</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="3416" y="1550.9497">callbackURI: 'pisp-app://callback...',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="197" x="3416" y="1566.0825">// note: no authURI for OTP flow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3408" y="1581.2153">}</text><polygon fill="#A80036" points="3782.5,1610.4141,3792.5,1614.4141,3782.5,1618.4141,3786.5,1614.4141" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2062.5" x2="3788.5" y1="1614.4141" y2="1614.4141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="2069.5" y="1609.3481">REQUEST-CONSENT-17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="96" x="2236.5" y="1609.3481">202 ACCEPTED</text><polygon fill="#A80036" points="1557.5,1639.5469,1547.5,1643.5469,1557.5,1647.5469,1553.5,1643.5469" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1551.5" x2="2051.5" y1="1643.5469" y2="1643.5469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1563.5" y="1638.481">REQUEST-CONSENT-18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="179" x="1730.5" y="1638.481">PUT /consentRequests/6789</text><polygon fill="#A80036" points="2045.5,1668.6797,2055.5,1672.6797,2045.5,1676.6797,2049.5,1672.6797" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1546.5" x2="2051.5" y1="1672.6797" y2="1672.6797"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1553.5" y="1667.6138">REQUEST-CONSENT-19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="1720.5" y="1667.6138">200 OK</text><polygon fill="#A80036" points="1047.5,1697.8125,1037.5,1701.8125,1047.5,1705.8125,1043.5,1701.8125" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1041.5" x2="1540.5" y1="1701.8125" y2="1701.8125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1053.5" y="1696.7466">REQUEST-CONSENT-20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="230" x="1220.5" y="1696.7466">Consent Request response recieved</text><rect fill="#FBFB77" filter="url(#f1xo8zv985jk6o)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="338" x="1041" y="1714.8125"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="330" x="1045" y="1730.8794">state: OTPAuthenticationChannelResponseRecieved</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1036.5" x2="1078.5" y1="1764.0781" y2="1764.0781"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1078.5" x2="1078.5" y1="1764.0781" y2="1777.0781"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1037.5" x2="1078.5" y1="1777.0781" y2="1777.0781"/><polygon fill="#A80036" points="1047.5,1773.0781,1037.5,1777.0781,1047.5,1781.0781,1043.5,1777.0781" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1043.5" y="1759.0122">REQUEST-CONSENT-21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="108" x="1210.5" y="1759.0122">this.saveToKVS()</text><polygon fill="#A80036" points="571.5,1802.2109,561.5,1806.2109,571.5,1810.2109,567.5,1806.2109" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="565.5" x2="1030.5" y1="1806.2109" y2="1806.2109"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="577.5" y="1801.145">REQUEST-CONSENT-22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="202" x="744.5" y="1801.145">return Authentication Response</text><polygon fill="#A80036" points="87.5,1831.3438,77.5,1835.3438,87.5,1839.3438,83.5,1835.3438" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="81.5" x2="554.5" y1="1835.3438" y2="1835.3438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="93.5" y="1830.2778">REQUEST-CONSENT-23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="209" x="260.5" y="1830.2778">200 OK Authentication Response</text><rect fill="#ADD8E6" filter="url(#f1xo8zv985jk6o)" height="234" style="stroke:#A80036;stroke-width:1.0;" width="465" x="85" y="1848.3438"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="89" y="1864.4106">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="128" x="97" y="1879.5435">channelResponse: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154" x="105" y="1894.6763">consentRequestId: 6789</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66" x="105" y="1909.8091">scopes: [{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="113" y="1924.9419">accountId: 'dfspa.username.1234',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="113" y="1940.0747">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="113" y="1955.2075">accountId: 'dfspa.username.5678',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="113" y="1970.3403">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="17" x="105" y="1985.4731">}],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="145" x="105" y="2000.606">authChannels: ["OTP"],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="105" y="2015.7388">callbackURI: 'pisp-app://callback...',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="441" x="105" y="2030.8716">authURI: 'dfspa.com/authorize?consentRequestId=6789' // this is new</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="12" x="97" y="2046.0044">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="391" x="97" y="2061.1372">currentState="OTPAuthenticationChannelResponseRecieved"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="89" y="2076.27">}</text><path d="M5,2093.3359 L5,2118.3359 L4375,2118.3359 L4375,2103.3359 L4365,2093.3359 L5,2093.3359 " fill="#FBFB77" filter="url(#f1xo8zv985jk6o)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M4365,2093.3359 L4365,2103.3359 L4375,2103.3359 L4365,2093.3359 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="609" x="1879" y="2110.4028">The DFSP is expected to send an OTP to the end user which will be used in the next linking step.</text><rect fill="#EEEEEE" filter="url(#f1xo8zv985jk6o)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="4800.5" x="0" y="2148.0352"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="4800.5" y1="2148.0352" y2="2148.0352"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="4800.5" y1="2151.0352" y2="2151.0352"/><rect fill="#EEEEEE" filter="url(#f1xo8zv985jk6o)" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="397" x="2201.75" y="2137.4688"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="378" x="2207.75" y="2153.5356">Authentication+Grant Consent+Register Credential</text><rect fill="#FBFB77" filter="url(#f1xo8zv985jk6o)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="503" x="81" y="2175.6016"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="495" x="85" y="2191.6685">PISP has obtained authToken from end-user(OTP) or through a callback(Web).</text><polygon fill="#A80036" points="538.5,2220.8672,548.5,2224.8672,538.5,2228.8672,542.5,2224.8672" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="81.5" x2="544.5" y1="2224.8672" y2="2224.8672"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="88.5" y="2219.8013">AUTHENTICATION-1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="312" x="231.5" y="2219.8013">POST /linking/request-consent/6789/authenticate</text><rect fill="#ADD8E6" filter="url(#f1xo8zv985jk6o)" height="68" style="stroke:#A80036;stroke-width:1.0;" width="320" x="86" y="2237.8672"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="312" x="90" y="2253.9341">POST /linking/request-consent/6789/authenticate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="90" y="2269.0669">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="98" y="2284.1997">authToken: '123456'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="90" y="2299.3325">}</text><line style="stroke:#A80036;stroke-width:1.0;" x1="560.5" x2="602.5" y1="2332.5313" y2="2332.5313"/><line style="stroke:#A80036;stroke-width:1.0;" x1="602.5" x2="602.5" y1="2332.5313" y2="2345.5313"/><line style="stroke:#A80036;stroke-width:1.0;" x1="561.5" x2="602.5" y1="2345.5313" y2="2345.5313"/><polygon fill="#A80036" points="571.5,2341.5313,561.5,2345.5313,571.5,2349.5313,567.5,2345.5313" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="567.5" y="2327.4653">AUTHENTICATION-2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="309" x="710.5" y="2327.4653">const model = await loadFromKVS({key: 6789})</text><rect fill="#FBFB77" filter="url(#f1xo8zv985jk6o)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="648" x="565" y="2358.5313"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="640" x="569" y="2374.5981">state: webAuthenticationChannelResponseRecieved or OTPAuthenticationChannelResponseRecieved</text><polygon fill="#A80036" points="1014.5,2403.7969,1024.5,2407.7969,1014.5,2411.7969,1018.5,2407.7969" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="560.5" x2="1020.5" y1="2407.7969" y2="2407.7969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="567.5" y="2402.731">AUTHENTICATION-3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="710.5" y="2402.731">model.authenticate()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1036.5" x2="1078.5" y1="2436.9297" y2="2436.9297"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1078.5" x2="1078.5" y1="2436.9297" y2="2449.9297"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1037.5" x2="1078.5" y1="2449.9297" y2="2449.9297"/><polygon fill="#A80036" points="1047.5,2445.9297,1037.5,2449.9297,1047.5,2453.9297,1043.5,2449.9297" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="1043.5" y="2431.8638">AUTHENTICATION-4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="285" x="1186.5" y="2431.8638">ThirdpartyRequests.patchConsentRequests()</text><polygon fill="#A80036" points="2040.5,2475.0625,2050.5,2479.0625,2040.5,2483.0625,2044.5,2479.0625" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1036.5" x2="2046.5" y1="2479.0625" y2="2479.0625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="1043.5" y="2473.9966">AUTHENTICATION-5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="197" x="1186.5" y="2473.9966">PATCH /consentRequests/6789</text><rect fill="#ADD8E6" filter="url(#f1xo8zv985jk6o)" height="98" style="stroke:#A80036;stroke-width:1.0;" width="205" x="1041" y="2492.0625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="197" x="1045" y="2508.1294">PATCH /consentRequests/6789</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="1045" y="2523.2622">FSIOP-Source: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="1045" y="2538.395">FSIOP-Destination: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1045" y="2553.5278">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="1053" y="2568.6606">authToken: '124356'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1045" y="2583.7935">}</text><polygon fill="#A80036" points="1042.5,2612.9922,1032.5,2616.9922,1042.5,2620.9922,1038.5,2616.9922" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1036.5" x2="2051.5" y1="2616.9922" y2="2616.9922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="1048.5" y="2611.9263">AUTHENTICATION-6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="1191.5" y="2611.9263">202 Accepted</text><polygon fill="#A80036" points="3261.5,2642.125,3271.5,2646.125,3261.5,2650.125,3265.5,2646.125" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2062.5" x2="3267.5" y1="2646.125" y2="2646.125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="2069.5" y="2641.0591">AUTHENTICATION-7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="197" x="2212.5" y="2641.0591">PATCH /consentRequests/6789</text><polygon fill="#A80036" points="2068.5,2671.2578,2058.5,2675.2578,2068.5,2679.2578,2064.5,2675.2578" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2062.5" x2="3272.5" y1="2675.2578" y2="2675.2578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="2074.5" y="2670.1919">AUTHENTICATION-8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2217.5" y="2670.1919">202 Accepted</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3283.5" x2="3325.5" y1="2704.3906" y2="2704.3906"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3325.5" x2="3325.5" y1="2704.3906" y2="2717.3906"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3284.5" x2="3325.5" y1="2717.3906" y2="2717.3906"/><polygon fill="#A80036" points="3294.5,2713.3906,3284.5,2717.3906,3294.5,2721.3906,3290.5,2717.3906" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="3290.5" y="2699.3247">AUTHENTICATION-9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="309" x="3433.5" y="2699.3247">const model = await loadFromKVS({key: 6789})</text><rect fill="#FBFB77" filter="url(#f1xo8zv985jk6o)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="280" x="3288" y="2730.3906"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="272" x="3292" y="2746.4575">state: consentRequestValidatedAndStored</text><polygon fill="#A80036" points="3777.5,2775.6563,3787.5,2779.6563,3777.5,2783.6563,3781.5,2779.6563" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3278.5" x2="3783.5" y1="2779.6563" y2="2779.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3285.5" y="2774.5903">AUTHENTICATION-10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="172" x="3437.5" y="2774.5903">model.validateAuthToken()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3841.5" y1="2808.7891" y2="2808.7891"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3841.5" x2="3841.5" y1="2808.7891" y2="2821.7891"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3800.5" x2="3841.5" y1="2821.7891" y2="2821.7891"/><polygon fill="#A80036" points="3810.5,2817.7891,3800.5,2821.7891,3810.5,2825.7891,3806.5,2821.7891" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3806.5" y="2803.7231">AUTHENTICATION-11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="280" x="3958.5" y="2803.7231">DFSPBackendRequests.validateAuthToken()</text><rect fill="#ADD8E6" filter="url(#f1xo8zv985jk6o)" height="204" style="stroke:#A80036;stroke-width:1.0;" width="504" x="3804" y="2834.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="312" x="3808" y="2850.856">Do we need two backend endpoints for validating</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="408" x="3808" y="2865.9888">web authTokens and OTP authTokens? Or is a DFSP expected to</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="248" x="3808" y="2881.1216">validate both cases with one endpoint?</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="0" x="3812" y="2896.2544"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="160" x="3808" y="2911.3872">POST /validateAuthToken</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3808" y="2926.52">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="160" x="3816" y="2941.6528">consentRequestId: '6789'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="251" x="3816" y="2956.7856">authChannel: model.data.authChannel,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="3816" y="2971.9185">authToken: '124356'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3808" y="2987.0513">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="0" x="3812" y="3002.1841"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="238" x="3808" y="3017.3169">For now we will just use one endpoint.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="496" x="3808" y="3032.4497">The DFSP should be able to infer the method based on the consentRequestId.</text><rect fill="#FBFB77" filter="url(#f1xo8zv985jk6o)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="176" x="3804" y="3049.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="168" x="3808" y="3065.5825">state: authTokenValidated</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3841.5" y1="3098.7813" y2="3098.7813"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3841.5" x2="3841.5" y1="3098.7813" y2="3111.7813"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3800.5" x2="3841.5" y1="3111.7813" y2="3111.7813"/><polygon fill="#A80036" points="3810.5,3107.7813,3800.5,3111.7813,3810.5,3115.7813,3806.5,3111.7813" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3806.5" y="3093.7153">AUTHENTICATION-12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="157" x="3958.5" y="3093.7153">const consentId = uuid()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3841.5" y1="3140.9141" y2="3140.9141"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3841.5" x2="3841.5" y1="3140.9141" y2="3153.9141"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3800.5" x2="3841.5" y1="3153.9141" y2="3153.9141"/><polygon fill="#A80036" points="3810.5,3149.9141,3800.5,3153.9141,3810.5,3157.9141,3806.5,3153.9141" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3806.5" y="3135.8481">AUTHENTICATION-13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="141" x="3958.5" y="3135.8481">model.grantConsent()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3841.5" y1="3183.0469" y2="3183.0469"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3841.5" x2="3841.5" y1="3183.0469" y2="3196.0469"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3800.5" x2="3841.5" y1="3196.0469" y2="3196.0469"/><polygon fill="#A80036" points="3810.5,3192.0469,3800.5,3196.0469,3810.5,3200.0469,3806.5,3196.0469" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3806.5" y="3177.981">AUTHENTICATION-14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="225" x="3958.5" y="3177.981">ThirdpartyRequests.postConsents()</text><rect fill="#FBFB77" filter="url(#f1xo8zv985jk6o)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="152" x="3804" y="3209.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="144" x="3808" y="3225.1138">state: consentGranted</text><rect fill="#ADD8E6" filter="url(#f1xo8zv985jk6o)" height="68" style="stroke:#A80036;stroke-width:1.0;" width="495" x="3804" y="3242.1797"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="484" x="3808" y="3258.2466">It's important to save the model with the consentId from this point onwards!</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="458" x="3808" y="3273.3794">Requests will not contain a consentRequestId in the upcoming requests.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="487" x="3808" y="3288.5122">This may require changing `PersistentModel` to have a secondary key it can</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="3808" y="3303.645">store the model with.</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3841.5" y1="3336.8438" y2="3336.8438"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3841.5" x2="3841.5" y1="3336.8438" y2="3349.8438"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3800.5" x2="3841.5" y1="3349.8438" y2="3349.8438"/><polygon fill="#A80036" points="3810.5,3345.8438,3800.5,3349.8438,3810.5,3353.8438,3806.5,3349.8438" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3806.5" y="3331.7778">AUTHENTICATION-15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="223" x="3958.5" y="3331.7778">this.saveToKVS({key: '1a2b3c4d'})</text><polygon fill="#A80036" points="2073.5,3374.9766,2063.5,3378.9766,2073.5,3382.9766,2069.5,3378.9766" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2067.5" x2="3788.5" y1="3378.9766" y2="3378.9766"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2079.5" y="3373.9106">AUTHENTICATION-16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100" x="2231.5" y="3373.9106">POST /consents</text><rect fill="#ADD8E6" filter="url(#f1xo8zv985jk6o)" height="129" style="stroke:#A80036;stroke-width:1.0;" width="191" x="3593" y="3391.9766"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100" x="3597" y="3408.0435">POST /consents</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="130" x="3597" y="3423.1763">FSIOP-Source: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="157" x="3597" y="3438.3091">FSIOP-Destination: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3597" y="3453.4419">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="133" x="3605" y="3468.5747">consentId: 1a2b3c4d</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154" x="3605" y="3483.7075">consentRequestId: 6789</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="175" x="3605" y="3498.8403">scopes: model.data.scopes</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3597" y="3513.9731">}</text><polygon fill="#A80036" points="3782.5,3543.1719,3792.5,3547.1719,3782.5,3551.1719,3786.5,3547.1719" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2062.5" x2="3788.5" y1="3547.1719" y2="3547.1719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2069.5" y="3542.106">AUTHENTICATION-17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="96" x="2221.5" y="3542.106">202 ACCEPTED</text><polygon fill="#A80036" points="1557.5,3572.3047,1547.5,3576.3047,1557.5,3580.3047,1553.5,3576.3047" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1551.5" x2="2051.5" y1="3576.3047" y2="3576.3047"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1563.5" y="3571.2388">AUTHENTICATION-18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100" x="1715.5" y="3571.2388">POST /consents</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1546.5" x2="1588.5" y1="3605.4375" y2="3605.4375"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1588.5" x2="1588.5" y1="3605.4375" y2="3618.4375"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1547.5" x2="1588.5" y1="3618.4375" y2="3618.4375"/><polygon fill="#A80036" points="1557.5,3614.4375,1547.5,3618.4375,1557.5,3622.4375,1553.5,3618.4375" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1553.5" y="3600.3716">AUTHENTICATION-19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="309" x="1705.5" y="3600.3716">const model = await loadFromKVS({key: 6789})</text><polygon fill="#A80036" points="1047.5,3643.5703,1037.5,3647.5703,1047.5,3651.5703,1043.5,3647.5703" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1041.5" x2="1535.5" y1="3647.5703" y2="3647.5703"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1053.5" y="3642.5044">AUTHENTICATION-20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="168" x="1205.5" y="3642.5044">model.registerCredential()</text><polygon fill="#A80036" points="2045.5,3672.7031,2055.5,3676.7031,2045.5,3680.7031,2049.5,3676.7031" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1541.5" x2="2051.5" y1="3676.7031" y2="3676.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1548.5" y="3671.6372">AUTHENTICATION-21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="1700.5" y="3671.6372">202 Accepted</text><rect fill="#FBFB77" filter="url(#f1xo8zv985jk6o)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="157" x="1041" y="3689.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="149" x="1045" y="3705.77">state: consentRecieved</text><rect fill="#ADD8E6" filter="url(#f1xo8zv985jk6o)" height="68" style="stroke:#A80036;stroke-width:1.0;" width="495" x="1041" y="3722.8359"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="484" x="1045" y="3738.9028">It's important to save the model with the consentId from this point onwards!</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="458" x="1045" y="3754.0356">Requests will not contain a consentRequestId in the upcoming requests.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="487" x="1045" y="3769.1685">This may require changing `PersistentModel` to have a secondary key it can</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="1045" y="3784.3013">store the model with.</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1036.5" x2="1078.5" y1="3817.5" y2="3817.5"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1078.5" x2="1078.5" y1="3817.5" y2="3830.5"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1037.5" x2="1078.5" y1="3830.5" y2="3830.5"/><polygon fill="#A80036" points="1047.5,3826.5,1037.5,3830.5,1047.5,3834.5,1043.5,3830.5" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1043.5" y="3812.4341">AUTHENTICATION-22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="1195.5" y="3812.4341">const challenge = deriveChallenge(consentRequest)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1036.5" x2="1078.5" y1="3859.6328" y2="3859.6328"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1078.5" x2="1078.5" y1="3859.6328" y2="3872.6328"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1037.5" x2="1078.5" y1="3872.6328" y2="3872.6328"/><polygon fill="#A80036" points="1047.5,3868.6328,1037.5,3872.6328,1047.5,3876.6328,1043.5,3872.6328" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1043.5" y="3854.5669">AUTHENTICATION-23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="223" x="1195.5" y="3854.5669">this.saveToKVS({key: '1a2b3c4d'})</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1036.5" x2="1078.5" y1="3901.7656" y2="3901.7656"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1078.5" x2="1078.5" y1="3901.7656" y2="3914.7656"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1037.5" x2="1078.5" y1="3914.7656" y2="3914.7656"/><polygon fill="#A80036" points="1047.5,3910.7656,1037.5,3914.7656,1047.5,3918.7656,1043.5,3914.7656" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1043.5" y="3896.6997">AUTHENTICATION-24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="218" x="1195.5" y="3896.6997">ThirdpartyRequests.putConsents()</text><rect fill="#FBFB77" filter="url(#f1xo8zv985jk6o)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="174" x="1041" y="3927.7656"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="166" x="1045" y="3943.8325">state: signedConsentSent</text><polygon fill="#A80036" points="2040.5,3973.0313,2050.5,3977.0313,2040.5,3981.0313,2044.5,3977.0313" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1036.5" x2="2046.5" y1="3977.0313" y2="3977.0313"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1043.5" y="3971.9653">AUTHENTICATION-25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="1195.5" y="3971.9653">PUT /consents/1a2b3c4d</text><rect fill="#ADD8E6" filter="url(#f1xo8zv985jk6o)" height="250" style="stroke:#A80036;stroke-width:1.0;" width="358" x="1041" y="3990.0313"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="1045" y="4006.0981">PUT /consents/1a2b3c4d</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="1045" y="4021.231">FSIOP-Source: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="1045" y="4036.3638">FSIOP-Destination: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1045" y="4051.4966">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66" x="1053" y="4066.6294">scopes: [{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="1061" y="4081.7622">accountId: 'dfspa.username.1234',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="1061" y="4096.895">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="1061" y="4112.0278">accountId: 'dfspa.username.5678',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="1061" y="4127.1606">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="17" x="1053" y="4142.2935">}],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="1053" y="4157.4263">credential: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="145" x="1061" y="4172.5591">credentialType: "FIDO",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="121" x="1061" y="4187.6919">status: "PENDING",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="183" x="1061" y="4202.8247">payload: PublicKeyCredential</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1053" y="4217.9575">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1045" y="4233.0903">}</text><polygon fill="#A80036" points="1042.5,4262.2891,1032.5,4266.2891,1042.5,4270.2891,1038.5,4266.2891" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1036.5" x2="2051.5" y1="4266.2891" y2="4266.2891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1048.5" y="4261.2231">AUTHENTICATION-26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="1200.5" y="4261.2231">202 Accepted</text><polygon fill="#A80036" points="3261.5,4291.4219,3271.5,4295.4219,3261.5,4299.4219,3265.5,4295.4219" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2062.5" x2="3267.5" y1="4295.4219" y2="4295.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2069.5" y="4290.356">AUTHENTICATION-27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="2221.5" y="4290.356">PUT /consents/1a2b3c4d</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3283.5" x2="3325.5" y1="4324.5547" y2="4324.5547"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3325.5" x2="3325.5" y1="4324.5547" y2="4337.5547"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3284.5" x2="3325.5" y1="4337.5547" y2="4337.5547"/><polygon fill="#A80036" points="3294.5,4333.5547,3284.5,4337.5547,3294.5,4341.5547,3290.5,4337.5547" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3290.5" y="4319.4888">AUTHENTICATION-28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="340" x="3442.5" y="4319.4888">const model = await loadFromKVS({key: 1a2b3c4d})</text><rect fill="#FBFB77" filter="url(#f1xo8zv985jk6o)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="201" x="3288" y="4350.5547"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="193" x="3292" y="4366.6216">state: signedConsentReceived</text><polygon fill="#A80036" points="3777.5,4395.8203,3787.5,4399.8203,3777.5,4403.8203,3781.5,4399.8203" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3283.5" x2="3783.5" y1="4399.8203" y2="4399.8203"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3290.5" y="4394.7544">AUTHENTICATION-29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="201" x="3442.5" y="4394.7544">model.validateSignedConsent()</text><rect fill="#FBFB77" filter="url(#f1xo8zv985jk6o)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="264" x="3288" y="4412.8203"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="256" x="3292" y="4428.8872">state: pendingRegistrationAndValidation</text><polygon fill="#A80036" points="2068.5,4458.0859,2058.5,4462.0859,2068.5,4466.0859,2064.5,4462.0859" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2062.5" x2="3277.5" y1="4462.0859" y2="4462.0859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2074.5" y="4457.02">AUTHENTICATION-30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2226.5" y="4457.02">202 Accepted</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3841.5" y1="4491.2188" y2="4491.2188"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3841.5" x2="3841.5" y1="4491.2188" y2="4504.2188"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3800.5" x2="3841.5" y1="4504.2188" y2="4504.2188"/><polygon fill="#A80036" points="3810.5,4500.2188,3800.5,4504.2188,3810.5,4508.2188,3806.5,4504.2188" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3806.5" y="4486.1528">AUTHENTICATION-31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="144" x="3958.5" y="4486.1528">Check signed consent.</text><rect fill="#ADD8E6" filter="url(#f1xo8zv985jk6o)" height="98" style="stroke:#A80036;stroke-width:1.0;" width="530" x="3804" y="4517.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="522" x="3808" y="4533.2856">Does this need a backend request or can the scheme adapter check the consent.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="0" x="3812" y="4548.4185"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="462" x="3808" y="4563.5513">Yes and No. We're keeping it as this for now (default to just talking to the</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="488" x="3808" y="4578.6841">auth service), but ideally we would open up a config option that would allow a</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="481" x="3808" y="4593.8169">DFSP to specify whether or not the DFSP Backend should receive a callback</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="366" x="3808" y="4608.9497">asking them to validate the credential before proceeding.</text><rect fill="#FBFB77" filter="url(#f1xo8zv985jk6o)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="199" x="3804" y="4626.0156"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="3808" y="4642.0825">state: signedConsentChecked</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3841.5" y1="4675.2813" y2="4675.2813"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3841.5" x2="3841.5" y1="4675.2813" y2="4688.2813"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3800.5" x2="3841.5" y1="4688.2813" y2="4688.2813"/><polygon fill="#A80036" points="3810.5,4684.2813,3800.5,4688.2813,3810.5,4692.2813,3806.5,4688.2813" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3806.5" y="4670.2153">AUTHENTICATION-32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="208" x="3958.5" y="4670.2153">model.validateWithAuthService()</text><polygon fill="#A80036" points="2073.5,4713.4141,2063.5,4717.4141,2073.5,4721.4141,2069.5,4717.4141" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2067.5" x2="3788.5" y1="4717.4141" y2="4717.4141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2079.5" y="4712.3481">AUTHENTICATION-33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="167" x="2231.5" y="4712.3481">POST /consents/1a2b3c4d</text><rect fill="#ADD8E6" filter="url(#f1xo8zv985jk6o)" height="250" style="stroke:#A80036;stroke-width:1.0;" width="358" x="3426" y="4730.4141"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="167" x="3430" y="4746.481">POST /consents/1a2b3c4d</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="130" x="3430" y="4761.6138">FSIOP-Source: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="201" x="3430" y="4776.7466">FSIOP-Destination: central-auth</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3430" y="4791.8794">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66" x="3438" y="4807.0122">scopes: [{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="3446" y="4822.145">accountId: 'dfspa.username.1234',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="3446" y="4837.2778">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="3446" y="4852.4106">accountId: 'dfspa.username.5678',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="3446" y="4867.5435">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="17" x="3438" y="4882.6763">}],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="3438" y="4897.8091">credential: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="145" x="3446" y="4912.9419">credentialType: "FIDO",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="121" x="3446" y="4928.0747">status: "PENDING",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="183" x="3446" y="4943.2075">payload: PublicKeyCredential</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3438" y="4958.3403">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3430" y="4973.4731">}</text><polygon fill="#A80036" points="3777.5,5002.6719,3787.5,5006.6719,3777.5,5010.6719,3781.5,5006.6719" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2062.5" x2="3783.5" y1="5006.6719" y2="5006.6719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2069.5" y="5001.606">AUTHENTICATION-34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2221.5" y="5001.606">202 Accepted</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3841.5" y1="5040.8047" y2="5040.8047"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3841.5" x2="3841.5" y1="5040.8047" y2="5053.8047"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3794.5" x2="3841.5" y1="5053.8047" y2="5053.8047"/><polygon fill="#A80036" points="3804.5,5049.8047,3794.5,5053.8047,3804.5,5057.8047,3800.5,5053.8047" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3806.5" y="5035.7388">AUTHENTICATION-35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="108" x="3958.5" y="5035.7388">this.saveToKVS()</text><polygon fill="#A80036" points="2388.5,5073.9375,2398.5,5077.9375,2388.5,5081.9375,2392.5,5077.9375" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2062.5" x2="2394.5" y1="5077.9375" y2="5077.9375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2069.5" y="5072.8716">AUTHENTICATION-36</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="167" x="2221.5" y="5072.8716">POST /consents/1a2b3c4d</text><polygon fill="#A80036" points="2073.5,5103.0703,2063.5,5107.0703,2073.5,5111.0703,2069.5,5107.0703" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2067.5" x2="2399.5" y1="5107.0703" y2="5107.0703"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2079.5" y="5102.0044">AUTHENTICATION-37</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2231.5" y="5102.0044">202 Accepted</text><line style="stroke:#A80036;stroke-width:1.0;" x1="2410.5" x2="2452.5" y1="5136.2031" y2="5136.2031"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2452.5" x2="2452.5" y1="5136.2031" y2="5149.2031"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2411.5" x2="2452.5" y1="5149.2031" y2="5149.2031"/><polygon fill="#A80036" points="2421.5,5145.2031,2411.5,5149.2031,2421.5,5153.2031,2417.5,5149.2031" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2417.5" y="5131.1372">AUTHENTICATION-38</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="98" x="2569.5" y="5131.1372">Check consent.</text><polygon fill="#A80036" points="2073.5,5174.3359,2063.5,5178.3359,2073.5,5182.3359,2069.5,5178.3359" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2067.5" x2="2399.5" y1="5178.3359" y2="5178.3359"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2079.5" y="5173.27">AUTHENTICATION-39</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="2231.5" y="5173.27">PUT /consents/1a2b3c4d</text><rect fill="#ADD8E6" filter="url(#f1xo8zv985jk6o)" height="250" style="stroke:#A80036;stroke-width:1.0;" width="358" x="2037" y="5191.3359"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="2041" y="5207.4028">PUT /consents/1a2b3c4d</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="173" x="2041" y="5222.5356">FSIOP-Source: central-auth</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="2041" y="5237.6685">FSIOP-Destination: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2041" y="5252.8013">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66" x="2049" y="5267.9341">scopes: [{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="2057" y="5283.0669">accountId: 'dfspa.username.1234',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="2057" y="5298.1997">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="2057" y="5313.3325">accountId: 'dfspa.username.5678',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="2057" y="5328.4653">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="17" x="2049" y="5343.5981">}],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="2049" y="5358.731">credential: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="145" x="2057" y="5373.8638">credentialType: "FIDO",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="118" x="2057" y="5388.9966">status: "VERIFIED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="183" x="2057" y="5404.1294">payload: PublicKeyCredential</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2049" y="5419.2622">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2041" y="5434.395">}</text><polygon fill="#A80036" points="2388.5,5463.5938,2398.5,5467.5938,2388.5,5471.5938,2392.5,5467.5938" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2062.5" x2="2394.5" y1="5467.5938" y2="5467.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2069.5" y="5462.5278">AUTHENTICATION-40</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="2221.5" y="5462.5278">200 OK</text><polygon fill="#A80036" points="3261.5,5492.7266,3271.5,5496.7266,3261.5,5500.7266,3265.5,5496.7266" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2062.5" x2="3267.5" y1="5496.7266" y2="5496.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2069.5" y="5491.6606">AUTHENTICATION-41</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="2221.5" y="5491.6606">PUT /consents/1a2b3c4d</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3283.5" x2="3325.5" y1="5525.8594" y2="5525.8594"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3325.5" x2="3325.5" y1="5525.8594" y2="5538.8594"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3284.5" x2="3325.5" y1="5538.8594" y2="5538.8594"/><polygon fill="#A80036" points="3294.5,5534.8594,3284.5,5538.8594,3294.5,5542.8594,3290.5,5538.8594" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3290.5" y="5520.7935">AUTHENTICATION-42</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="340" x="3442.5" y="5520.7935">const model = await loadFromKVS({key: 1a2b3c4d})</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3283.5" x2="3325.5" y1="5567.9922" y2="5567.9922"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3325.5" x2="3325.5" y1="5567.9922" y2="5580.9922"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3284.5" x2="3325.5" y1="5580.9922" y2="5580.9922"/><polygon fill="#A80036" points="3294.5,5576.9922,3284.5,5580.9922,3294.5,5584.9922,3290.5,5580.9922" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3290.5" y="5562.9263">AUTHENTICATION-43</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="180" x="3442.5" y="5562.9263">consentResponseRecieved()</text><rect fill="#FBFB77" filter="url(#f1xo8zv985jk6o)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="219" x="3288" y="5593.9922"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="211" x="3292" y="5610.0591">state: consentResponseRecieved</text><polygon fill="#A80036" points="3777.5,5639.2578,3787.5,5643.2578,3777.5,5647.2578,3781.5,5643.2578" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3283.5" x2="3783.5" y1="5643.2578" y2="5643.2578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3290.5" y="5638.1919">AUTHENTICATION-44</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="202" x="3442.5" y="5638.1919">Auth Service response recieved</text><polygon fill="#A80036" points="2068.5,5668.3906,2058.5,5672.3906,2068.5,5676.3906,2064.5,5672.3906" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2062.5" x2="3277.5" y1="5672.3906" y2="5672.3906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2074.5" y="5667.3247">AUTHENTICATION-45</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="2226.5" y="5667.3247">200 OK</text><polygon fill="#A80036" points="2829.5,5697.5234,2839.5,5701.5234,2829.5,5705.5234,2833.5,5701.5234" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2410.5" x2="2835.5" y1="5701.5234" y2="5701.5234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2417.5" y="5696.4575">AUTHENTICATION-46</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="260" x="2569.5" y="5696.4575">POST /participants/CONSENTS/1a2b3c4d</text><polygon fill="#A80036" points="2416.5,5726.6563,2406.5,5730.6563,2416.5,5734.6563,2412.5,5730.6563" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2410.5" x2="2840.5" y1="5730.6563" y2="5730.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2422.5" y="5725.5903">AUTHENTICATION-47</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2574.5" y="5725.5903">202 Accepted</text><polygon fill="#A80036" points="3261.5,5755.7891,3271.5,5759.7891,3261.5,5763.7891,3265.5,5759.7891" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2851.5" x2="3267.5" y1="5759.7891" y2="5759.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2858.5" y="5754.7231">AUTHENTICATION-48</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="251" x="3010.5" y="5754.7231">PUT /participants/CONSENTS/1a2b3c4d</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3283.5" x2="3325.5" y1="5788.9219" y2="5788.9219"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3325.5" x2="3325.5" y1="5788.9219" y2="5801.9219"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3284.5" x2="3325.5" y1="5801.9219" y2="5801.9219"/><polygon fill="#A80036" points="3294.5,5797.9219,3284.5,5801.9219,3294.5,5805.9219,3290.5,5801.9219" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3290.5" y="5783.856">AUTHENTICATION-49</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="340" x="3442.5" y="5783.856">const model = await loadFromKVS({key: 1a2b3c4d})</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3283.5" x2="3325.5" y1="5831.0547" y2="5831.0547"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3325.5" x2="3325.5" y1="5831.0547" y2="5844.0547"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3284.5" x2="3325.5" y1="5844.0547" y2="5844.0547"/><polygon fill="#A80036" points="3294.5,5840.0547,3284.5,5844.0547,3294.5,5848.0547,3290.5,5844.0547" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3290.5" y="5825.9888">AUTHENTICATION-50</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="197" x="3442.5" y="5825.9888">participantResponseRecieved()</text><rect fill="#FBFB77" filter="url(#f1xo8zv985jk6o)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="243" x="3288" y="5857.0547"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="235" x="3292" y="5873.1216">state: participantsResponseRecieved</text><polygon fill="#A80036" points="3777.5,5902.3203,3787.5,5906.3203,3777.5,5910.3203,3781.5,5906.3203" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3283.5" x2="3783.5" y1="5906.3203" y2="5906.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3290.5" y="5901.2544">AUTHENTICATION-51</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="189" x="3442.5" y="5901.2544">Participant response recieved</text><polygon fill="#A80036" points="2857.5,5931.4531,2847.5,5935.4531,2857.5,5939.4531,2853.5,5935.4531" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2851.5" x2="3277.5" y1="5935.4531" y2="5935.4531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2863.5" y="5930.3872">AUTHENTICATION-52</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="3015.5" y="5930.3872">200 Accepted</text><rect fill="#FBFB77" filter="url(#f1xo8zv985jk6o)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="253" x="3804" y="5948.4531"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="245" x="3808" y="5964.52">state: consentRegisteredAndValidated</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3841.5" y1="5997.7188" y2="5997.7188"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3841.5" x2="3841.5" y1="5997.7188" y2="6010.7188"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3800.5" x2="3841.5" y1="6010.7188" y2="6010.7188"/><polygon fill="#A80036" points="3810.5,6006.7188,3800.5,6010.7188,3810.5,6014.7188,3806.5,6010.7188" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3806.5" y="5992.6528">AUTHENTICATION-53</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="151" x="3958.5" y="5992.6528">model.finalizeConsent()</text><path d="M2016,6025.7188 L2093,6025.7188 L2093,6032.7188 L2083,6042.7188 L2016,6042.7188 L2016,6025.7188 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="279.3281" style="stroke:#000000;stroke-width:2.0;" width="1861" x="2016" y="6025.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="32" x="2031" y="6038.7856">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="116" x="2108" y="6037.9292">[for each scope in</text><text fill="#000000" font-family="monospace" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="105" x="2228" y="6037.9292">Consents.scopes</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="5" x="2333" y="6037.9292">]</text><polygon fill="#A80036" points="2068.5,6059.9844,2058.5,6063.9844,2068.5,6067.9844,2064.5,6063.9844" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2062.5" x2="3788.5" y1="6063.9844" y2="6063.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2074.5" y="6058.9185">AUTHENTICATION-54</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="376" x="2226.5" y="6058.9185">POST /participants/THIRD_PARTY_LINK/dfsp.username.5678</text><polygon fill="#A80036" points="3777.5,6089.1172,3787.5,6093.1172,3777.5,6097.1172,3781.5,6093.1172" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2057.5" x2="3783.5" y1="6093.1172" y2="6093.1172"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2064.5" y="6088.0513">AUTHENTICATION-55</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2216.5" y="6088.0513">202 Accepted</text><polygon fill="#A80036" points="2834.5,6118.25,2844.5,6122.25,2834.5,6126.25,2838.5,6122.25" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2057.5" x2="2840.5" y1="6122.25" y2="6122.25"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2064.5" y="6117.1841">AUTHENTICATION-56</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="376" x="2216.5" y="6117.1841">POST /participants/THIRD_PARTY_LINK/dfsp.username.5678</text><polygon fill="#A80036" points="2068.5,6147.3828,2058.5,6151.3828,2068.5,6155.3828,2064.5,6151.3828" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2062.5" x2="2845.5" y1="6151.3828" y2="6151.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2074.5" y="6146.3169">AUTHENTICATION-57</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2226.5" y="6146.3169">202 Accepted</text><polygon fill="#A80036" points="2068.5,6176.5156,2058.5,6180.5156,2068.5,6184.5156,2064.5,6180.5156" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2062.5" x2="2845.5" y1="6180.5156" y2="6180.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2074.5" y="6175.4497">AUTHENTICATION-58</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="367" x="2226.5" y="6175.4497">PUT /participants/THIRD_PARTY_LINK/dfsp.username.5678</text><polygon fill="#A80036" points="2834.5,6205.6484,2844.5,6209.6484,2834.5,6213.6484,2838.5,6209.6484" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2057.5" x2="2840.5" y1="6209.6484" y2="6209.6484"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2064.5" y="6204.5825">AUTHENTICATION-59</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="2216.5" y="6204.5825">200 OK</text><polygon fill="#A80036" points="3266.5,6234.7813,3276.5,6238.7813,3266.5,6242.7813,3270.5,6238.7813" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2057.5" x2="3272.5" y1="6238.7813" y2="6238.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2064.5" y="6233.7153">AUTHENTICATION-60</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="367" x="2216.5" y="6233.7153">PUT /participants/THIRD_PARTY_LINK/dfsp.username.5678</text><polygon fill="#A80036" points="2068.5,6263.9141,2058.5,6267.9141,2068.5,6271.9141,2064.5,6267.9141" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2062.5" x2="3277.5" y1="6267.9141" y2="6267.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2074.5" y="6262.8481">AUTHENTICATION-61</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="2226.5" y="6262.8481">200 OK</text><polygon fill="#A80036" points="3777.5,6293.0469,3787.5,6297.0469,3777.5,6301.0469,3781.5,6297.0469" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3278.5" x2="3783.5" y1="6297.0469" y2="6297.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3285.5" y="6291.981">AUTHENTICATION-62</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="189" x="3437.5" y="6291.981">Participant response recieved</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3841.5" y1="6333.1797" y2="6333.1797"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3841.5" x2="3841.5" y1="6333.1797" y2="6346.1797"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3800.5" x2="3841.5" y1="6346.1797" y2="6346.1797"/><polygon fill="#A80036" points="3810.5,6342.1797,3800.5,6346.1797,3810.5,6350.1797,3806.5,6346.1797" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3806.5" y="6328.1138">AUTHENTICATION-63</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="3958.5" y="6328.1138">await Promise.all()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3841.5" y1="6375.3125" y2="6375.3125"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3841.5" x2="3841.5" y1="6375.3125" y2="6388.3125"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3800.5" x2="3841.5" y1="6388.3125" y2="6388.3125"/><polygon fill="#A80036" points="3810.5,6384.3125,3800.5,6388.3125,3810.5,6392.3125,3806.5,6388.3125" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3806.5" y="6370.2466">AUTHENTICATION-64</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="201" x="3958.5" y="6370.2466">state: PISPDFSPLinkEstablished</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3841.5" y1="6417.4453" y2="6417.4453"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3841.5" x2="3841.5" y1="6417.4453" y2="6430.4453"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3800.5" x2="3841.5" y1="6430.4453" y2="6430.4453"/><polygon fill="#A80036" points="3810.5,6426.4453,3800.5,6430.4453,3810.5,6434.4453,3806.5,6430.4453" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3806.5" y="6412.3794">AUTHENTICATION-65</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="203" x="3958.5" y="6412.3794">model.notifyVerificationToPISP()</text><polygon fill="#A80036" points="2073.5,6455.5781,2063.5,6459.5781,2073.5,6463.5781,2069.5,6459.5781" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2067.5" x2="3788.5" y1="6459.5781" y2="6459.5781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2079.5" y="6454.5122">AUTHENTICATION-66</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="176" x="2231.5" y="6454.5122">PATCH /consents/1a2b3c4d</text><rect fill="#ADD8E6" filter="url(#f1xo8zv985jk6o)" height="129" style="stroke:#A80036;stroke-width:1.0;" width="184" x="3600" y="6472.5781"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="176" x="3604" y="6488.645">PATCH /consents/1a2b3c4d</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="130" x="3604" y="6503.7778">FSIOP-Source: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="157" x="3604" y="6518.9106">FSIOP-Destination: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3604" y="6534.0435">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="3612" y="6549.1763">credential: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="3620" y="6564.3091">status: "VERIFIED"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3612" y="6579.4419">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3604" y="6594.5747">}</text><polygon fill="#A80036" points="3782.5,6623.7734,3792.5,6627.7734,3782.5,6631.7734,3786.5,6627.7734" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2062.5" x2="3788.5" y1="6627.7734" y2="6627.7734"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2069.5" y="6622.7075">AUTHENTICATION-67</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="2221.5" y="6622.7075">200 OK</text><polygon fill="#A80036" points="1557.5,6652.9063,1547.5,6656.9063,1557.5,6660.9063,1553.5,6656.9063" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1551.5" x2="2051.5" y1="6656.9063" y2="6656.9063"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1563.5" y="6651.8403">AUTHENTICATION-68</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="176" x="1715.5" y="6651.8403">PATCH /consents/1a2b3c4d</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1546.5" x2="1588.5" y1="6686.0391" y2="6686.0391"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1588.5" x2="1588.5" y1="6686.0391" y2="6699.0391"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1547.5" x2="1588.5" y1="6699.0391" y2="6699.0391"/><polygon fill="#A80036" points="1557.5,6695.0391,1547.5,6699.0391,1557.5,6703.0391,1553.5,6699.0391" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1553.5" y="6680.9731">AUTHENTICATION-69</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="340" x="1705.5" y="6680.9731">const model = await loadFromKVS({key: 1a2b3c4d})</text><polygon fill="#A80036" points="1047.5,6724.1719,1037.5,6728.1719,1047.5,6732.1719,1043.5,6728.1719" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1041.5" x2="1535.5" y1="6728.1719" y2="6728.1719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1053.5" y="6723.106">AUTHENTICATION-70</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="172" x="1205.5" y="6723.106">Verified Response recieved</text><polygon fill="#A80036" points="2045.5,6753.3047,2055.5,6757.3047,2045.5,6761.3047,2049.5,6757.3047" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1541.5" x2="2051.5" y1="6757.3047" y2="6757.3047"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1548.5" y="6752.2388">AUTHENTICATION-71</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="1700.5" y="6752.2388">200 OK</text><rect fill="#FBFB77" filter="url(#f1xo8zv985jk6o)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="148" x="1041" y="6770.3047"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="140" x="1045" y="6786.3716">state: accountsLinked</text><polygon fill="#A80036" points="571.5,6815.5703,561.5,6819.5703,571.5,6823.5703,567.5,6819.5703" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="565.5" x2="1030.5" y1="6819.5703" y2="6819.5703"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="577.5" y="6814.5044">AUTHENTICATION-72</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="206" x="729.5" y="6814.5044">return Accounts linked response</text><polygon fill="#A80036" points="92.5,6844.7031,82.5,6848.7031,92.5,6852.7031,88.5,6848.7031" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="86.5" x2="549.5" y1="6848.7031" y2="6848.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="98.5" y="6843.6372">AUTHENTICATION-73</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154" x="250.5" y="6843.6372">200 OK Accounts Linked</text><rect fill="#ADD8E6" filter="url(#f1xo8zv985jk6o)" height="98" style="stroke:#A80036;stroke-width:1.0;" width="217" x="328" y="6861.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="332" y="6877.77">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="340" y="6892.9028">credential: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="348" y="6908.0356">status: "VERIFIED"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="340" y="6923.1685">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="201" x="340" y="6938.3013">currentState="accountsLinked"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="332" y="6953.4341">}</text><!--MD5=[297a5489c6d712afef6c01b21f2c9ff7]
@startuml

title PISP Linking OTP

participant "PISP Backend" as PISP
box "PISP tp-scheme-adapter"
  participant "outbound-server" as PISP_TP_OUT
  participant "PISPLinkingModel" as PISP_LM
  participant "inbound-server" as PISP_TP_IN
end box
box "Mojaloop"
    participant Switch
    participant "Auth Service" as AUTH
    participant "Account Lookup Service" as ALS
end box
box "DFSP tp-scheme-adapter"
  participant "inbound-server" as DFSP_TP_IN
  participant "DFSPLinkingModel" as DFSP_LM
end box
participant DFSPAuthorizeSimulator

== Request Consent - OTP ==
autonumber 1 "<b>REQUEST-CONSENT-#</b>"
rnote right of PISP
PISP presents accounts to user. User selects one or more accounts to link.
end note
PISP -> PISP_TP_OUT: POST /linking/request-consent
rnote right of PISP #LightBlue
POST /linking/request-consent
{
  accounts: [
    { accountNickname: "XXXXXXnt", id: "dfspa.username.1234", currency: "ZAR" },
    { accountNickname: "SpeXXXXXXXXnt", id: "dfspa.username.5678", currency: "USD" }
  ],
  userId: "username1234", // so the dfsp can associate this request with GET /accounts
  callbackURI: 'pisp-app://callback'
}
end note

activate PISP
activate PISP_TP_OUT

PISP_TP_OUT -> PISP_TP_OUT: const model = await create()
rnote right of PISP_TP_OUT: state: start
PISP_TP_OUT -> PISP_LM: model.requestConsent()
activate PISP_LM

PISP_LM -> PISP_LM: ThirdpartyRequests.postConsentRequests()
PISP_LM -> PISP_LM: const consentRequestId = uuid()
PISP_LM -> Switch: POST /consentRequests
rnote right of PISP_LM #LightBlue
POST /consentRequests
FSIOP-Source: pispa
FSIOP-Destination: dfspa
{
  consentRequestId: 6789
  userId: "username1234"
  scopes: [{
    accountId: 'dfspa.username.1234',
    actions: ['accounts.getBalance', 'accounts.transfer'],
    accountId: 'dfspa.username.5678',
    actions: ['accounts.getBalance', 'accounts.transfer'],
  }],
  // model will add `authChannels`
  authChannels: ["WEB", "OTP"],
  callbackURI: 'pisp-app://callback...'
}
end note

activate Switch
Switch - -> PISP_LM: 202 Accepted
deactivate PISP_LM
Switch -> DFSP_TP_IN: POST /consentRequests
activate DFSP_TP_IN
DFSP_TP_IN - -> Switch: 202 Accepted
deactivate Switch
DFSP_TP_IN -> DFSP_TP_IN: const model = await create()
rnote right of DFSP_TP_IN: state: start
DFSP_TP_IN -> DFSP_LM: model.requestConsent()
deactivate DFSP_TP_IN
activate DFSP_LM
DFSP_LM -> DFSP_LM: DFSPBackendRequests.validateConsentRequest()
DFSP_LM -> DFSPAuthorizeSimulator: POST /sendOTP
activate DFSPAuthorizeSimulator
rnote right of DFSP_LM #LightBlue
POST /sendOTP
{
  consentRequestId: 6789,
  username: "username.1234",
  message: "0987"
}
end note
DFSPAuthorizeSimulator -> DFSPAuthorizeSimulator: take action on TTK for defined rule for username
DFSPAuthorizeSimulator -> DFSP_LM: 200 OK
rnote right of DFSP_LM: state: consentRequestValidatedAndStored
deactivate DFSPAuthorizeSimulator
deactivate DFSP_TP_IN

DFSP_LM -> Switch: PUT /consentRequests/6789
activate Switch

rnote left of DFSP_LM #LightBlue
PUT /consentRequests/6789
FSIOP-Source: pispa
FSIOP-Destination: dfspa
{
  consentRequestId: 6789
  scopes: [{
    accountId: 'dfspa.username.1234',
    actions: ['accounts.getBalance', 'accounts.transfer'],
    accountId: 'dfspa.username.5678',
    actions: ['accounts.getBalance', 'accounts.transfer'],
  }],
  authChannels: ["OTP"], // updated with the channel in use
  callbackURI: 'pisp-app://callback...',
  // note: no authURI for OTP flow
}
end note
Switch - -> DFSP_LM: 202 ACCEPTED
deactivate DFSP_LM

Switch ->  PISP_TP_IN: PUT /consentRequests/6789
activate PISP_TP_IN
PISP_TP_IN - -> Switch: 200 OK
deactivate Switch
activate PISP_LM
PISP_TP_IN - -> PISP_LM: Consent Request response recieved
deactivate PISP_TP_IN
rnote right of PISP_LM: state: OTPAuthenticationChannelResponseRecieved
PISP_LM - -> PISP_LM: this.saveToKVS()
PISP_LM -> PISP_TP_OUT: return Authentication Response
deactivate PISP_LM
PISP_TP_OUT - -> PISP: 200 OK Authentication Response
rnote left of PISP_TP_OUT #LightBlue
{
  channelResponse: {
    consentRequestId: 6789
    scopes: [{
      accountId: 'dfspa.username.1234',
      actions: ['accounts.getBalance', 'accounts.transfer'],
      accountId: 'dfspa.username.5678',
      actions: ['accounts.getBalance', 'accounts.transfer'],
    }],
    authChannels: ["OTP"],
    callbackURI: 'pisp-app://callback...',
    authURI: 'dfspa.com/authorize?consentRequestId=6789' // this is new
  },
  currentState="OTPAuthenticationChannelResponseRecieved"
}
end note

deactivate PISP_TP_OUT
deactivate PISP

note over PISP, DFSPAuthorizeSimulator
  The DFSP is expected to send an OTP to the end user which will be used in the next linking step.
end note

== Authentication+Grant Consent+Register Credential ==
autonumber 1 "<b>AUTHENTICATION-#</b>"
rnote right of PISP
PISP has obtained authToken from end-user(OTP) or through a callback(Web).
end note
PISP -> PISP_TP_OUT: POST /linking/request-consent/6789/authenticate
rnote right of PISP #LightBlue
POST /linking/request-consent/6789/authenticate
{
  authToken: '123456'
}
end note

activate PISP
activate PISP_TP_OUT

PISP_TP_OUT -> PISP_TP_OUT: const model = await loadFromKVS({key: 6789})
rnote right of PISP_TP_OUT: state: webAuthenticationChannelResponseRecieved or OTPAuthenticationChannelResponseRecieved
PISP_TP_OUT -> PISP_LM: model.authenticate()

activate PISP_LM

PISP_LM -> PISP_LM: ThirdpartyRequests.patchConsentRequests()
PISP_LM -> Switch: PATCH /consentRequests/6789
rnote right of PISP_LM #LightBlue
PATCH /consentRequests/6789
FSIOP-Source: pispa
FSIOP-Destination: dfspa
{
  authToken: '124356'
}
end note

activate Switch
Switch - -> PISP_LM: 202 Accepted
deactivate PISP_LM
Switch -> DFSP_TP_IN: PATCH /consentRequests/6789
activate DFSP_TP_IN
DFSP_TP_IN - -> Switch: 202 Accepted
deactivate Switch
DFSP_TP_IN -> DFSP_TP_IN: const model = await loadFromKVS({key: 6789})
rnote right of DFSP_TP_IN: state: consentRequestValidatedAndStored
DFSP_TP_IN -> DFSP_LM: model.validateAuthToken()
deactivate DFSP_TP_IN
activate DFSP_LM

DFSP_LM -> DFSP_LM: DFSPBackendRequests.validateAuthToken()
rnote right of DFSP_LM #LightBlue
Do we need two backend endpoints for validating
web authTokens and OTP authTokens? Or is a DFSP expected to
validate both cases with one endpoint?

POST /validateAuthToken
{
  consentRequestId: '6789'
  authChannel: model.data.authChannel,
  authToken: '124356'
}

For now we will just use one endpoint.
The DFSP should be able to infer the method based on the consentRequestId.
end note
rnote right of DFSP_LM: state: authTokenValidated

DFSP_LM -> DFSP_LM: const consentId = uuid()
DFSP_LM -> DFSP_LM: model.grantConsent()
DFSP_LM -> DFSP_LM: ThirdpartyRequests.postConsents()
rnote right of DFSP_LM: state: consentGranted
rnote right of DFSP_LM #LightBlue
It's important to save the model with the consentId from this point onwards!
Requests will not contain a consentRequestId in the upcoming requests.
This may require changing `PersistentModel` to have a secondary key it can
store the model with.
end note
DFSP_LM -> DFSP_LM: this.saveToKVS({key: '1a2b3c4d'})

DFSP_LM -> Switch: POST /consents
activate Switch

rnote left of DFSP_LM #LightBlue
POST /consents
FSIOP-Source: dfspa
FSIOP-Destination: pispa
{
  consentId: 1a2b3c4d
  consentRequestId: 6789
  scopes: model.data.scopes
}
end note
Switch - -> DFSP_LM: 202 ACCEPTED
deactivate DFSP_LM
Switch ->  PISP_TP_IN: POST /consents
activate PISP_TP_IN
PISP_TP_IN -> PISP_TP_IN: const model = await loadFromKVS({key: 6789})
PISP_TP_IN -> PISP_LM: model.registerCredential()
activate PISP_LM
PISP_TP_IN - -> Switch: 202 Accepted
deactivate PISP_TP_IN
deactivate Switch
rnote right of PISP_LM: state: consentRecieved
rnote right of PISP_LM #LightBlue
It's important to save the model with the consentId from this point onwards!
Requests will not contain a consentRequestId in the upcoming requests.
This may require changing `PersistentModel` to have a secondary key it can
store the model with.
end note
PISP_LM - -> PISP_LM: const challenge = deriveChallenge(consentRequest)
PISP_LM - -> PISP_LM: this.saveToKVS({key: '1a2b3c4d'})

PISP_LM -> PISP_LM: ThirdpartyRequests.putConsents()
rnote right of PISP_LM: state: signedConsentSent
PISP_LM -> Switch: PUT /consents/1a2b3c4d
activate Switch

rnote right of PISP_LM #LightBlue
PUT /consents/1a2b3c4d
FSIOP-Source: pispa
FSIOP-Destination: dfspa
{
  scopes: [{
    accountId: 'dfspa.username.1234',
    actions: ['accounts.getBalance', 'accounts.transfer'],
    accountId: 'dfspa.username.5678',
    actions: ['accounts.getBalance', 'accounts.transfer'],
  }],
  credential: {
    credentialType: "FIDO",
    status: "PENDING",
    payload: PublicKeyCredential
  }
}
end note

Switch - -> PISP_LM: 202 Accepted
deactivate PISP_LM
Switch -> DFSP_TP_IN: PUT /consents/1a2b3c4d
activate DFSP_TP_IN

DFSP_TP_IN -> DFSP_TP_IN: const model = await loadFromKVS({key: 1a2b3c4d})
rnote right of DFSP_TP_IN: state: signedConsentReceived
DFSP_TP_IN -> DFSP_LM: model.validateSignedConsent()
activate DFSP_LM
rnote right of DFSP_TP_IN: state: pendingRegistrationAndValidation
DFSP_TP_IN - -> Switch: 202 Accepted
deactivate Switch
deactivate DFSP_TP_IN
DFSP_LM -> DFSP_LM: Check signed consent.
rnote right of DFSP_LM #LightBlue
Does this need a backend request or can the scheme adapter check the consent.

Yes and No. We're keeping it as this for now (default to just talking to the
auth service), but ideally we would open up a config option that would allow a
DFSP to specify whether or not the DFSP Backend should receive a callback
asking them to validate the credential before proceeding.
end note
rnote right of DFSP_LM: state: signedConsentChecked
DFSP_LM-> DFSP_LM: model.validateWithAuthService()
DFSP_LM -> Switch: POST /consents/1a2b3c4d
activate Switch

rnote left of DFSP_LM #LightBlue
POST /consents/1a2b3c4d
FSIOP-Source: dfspa
FSIOP-Destination: central-auth
{
  scopes: [{
    accountId: 'dfspa.username.1234',
    actions: ['accounts.getBalance', 'accounts.transfer'],
    accountId: 'dfspa.username.5678',
    actions: ['accounts.getBalance', 'accounts.transfer'],
  }],
  credential: {
    credentialType: "FIDO",
    status: "PENDING",
    payload: PublicKeyCredential
  }
}
end note
Switch - -> DFSP_LM: 202 Accepted
DFSP_LM -> DFSP_LM: this.saveToKVS()
deactivate DFSP_LM

Switch -> AUTH: POST /consents/1a2b3c4d
activate AUTH
AUTH - -> Switch: 202 Accepted
AUTH -> AUTH: Check consent.
AUTH -> Switch: PUT /consents/1a2b3c4d

rnote left of AUTH #LightBlue
PUT /consents/1a2b3c4d
FSIOP-Source: central-auth
FSIOP-Destination: dfspa
{
  scopes: [{
    accountId: 'dfspa.username.1234',
    actions: ['accounts.getBalance', 'accounts.transfer'],
    accountId: 'dfspa.username.5678',
    actions: ['accounts.getBalance', 'accounts.transfer'],
  }],
  credential: {
    credentialType: "FIDO",
    status: "VERIFIED",
    payload: PublicKeyCredential
  }
}
end note

Switch - -> AUTH: 200 OK
Switch -> DFSP_TP_IN: PUT /consents/1a2b3c4d
activate DFSP_TP_IN
DFSP_TP_IN -> DFSP_TP_IN: const model = await loadFromKVS({key: 1a2b3c4d})
DFSP_TP_IN -> DFSP_TP_IN: consentResponseRecieved()
rnote right of DFSP_TP_IN: state: consentResponseRecieved
DFSP_TP_IN -> DFSP_LM: Auth Service response recieved
activate DFSP_LM
DFSP_TP_IN - -> Switch: 200 OK
deactivate Switch
deactivate DFSP_TP_IN

AUTH -> ALS: POST /participants/CONSENTS/1a2b3c4d
activate ALS
ALS - -> AUTH: 202 Accepted
deactivate AUTH

ALS -> DFSP_TP_IN: PUT /participants/CONSENTS/1a2b3c4d
activate DFSP_TP_IN
DFSP_TP_IN -> DFSP_TP_IN: const model = await loadFromKVS({key: 1a2b3c4d})
DFSP_TP_IN -> DFSP_TP_IN: participantResponseRecieved()
rnote right of DFSP_TP_IN: state: participantsResponseRecieved
DFSP_TP_IN -> DFSP_LM: Participant response recieved
DFSP_TP_IN - -> ALS: 200 Accepted
deactivate ALS
deactivate DFSP_TP_IN
rnote right of DFSP_LM: state: consentRegisteredAndValidated
DFSP_LM -> DFSP_LM: model.finalizeConsent()

loop for each scope in ""Consents.scopes""
DFSP_LM -> Switch: POST /participants/THIRD_PARTY_LINK/dfsp.username.5678
Switch - -> DFSP_LM: 202 Accepted
Switch -> ALS: POST /participants/THIRD_PARTY_LINK/dfsp.username.5678
ALS - -> Switch: 202 Accepted
ALS -> Switch: PUT /participants/THIRD_PARTY_LINK/dfsp.username.5678
Switch - -> ALS: 200 OK
Switch -> DFSP_TP_IN: PUT /participants/THIRD_PARTY_LINK/dfsp.username.5678
DFSP_TP_IN - -> Switch: 200 OK
DFSP_TP_IN -> DFSP_LM: Participant response recieved
end

DFSP_LM -> DFSP_LM: await Promise.all()
DFSP_LM -> DFSP_LM: state: PISPDFSPLinkEstablished
DFSP_LM -> DFSP_LM: model.notifyVerificationToPISP()
DFSP_LM -> Switch: PATCH /consents/1a2b3c4d
rnote left of DFSP_LM #LightBlue
PATCH /consents/1a2b3c4d
FSIOP-Source: dfspa
FSIOP-Destination: pispa
{
  credential: {
    status: "VERIFIED"
  }
}
end note
activate Switch
Switch - -> DFSP_LM: 200 OK
deactivate DFSP_LM
Switch -> PISP_TP_IN: PATCH /consents/1a2b3c4d
activate PISP_TP_IN
PISP_TP_IN -> PISP_TP_IN: const model = await loadFromKVS({key: 1a2b3c4d})

PISP_TP_IN -> PISP_LM: Verified Response recieved
activate PISP_LM
PISP_TP_IN - -> Switch: 200 OK
deactivate PISP_TP_IN
deactivate Switch
rnote right of PISP_LM: state: accountsLinked
PISP_LM - -> PISP_TP_OUT: return Accounts linked response
deactivate PISP_LM
PISP_TP_OUT - -> PISP: 200 OK Accounts Linked
rnote left of PISP_TP_OUT #LightBlue
{
  credential: {
    status: "VERIFIED"
  }
  currentState="accountsLinked"
}
end note
@enduml

PlantUML version 1.2021.00(Sun Jan 10 05:25:05 EST 2021)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>