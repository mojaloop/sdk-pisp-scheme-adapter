<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="6747px" preserveAspectRatio="none" style="width:4686px;height:6747px;" version="1.1" viewBox="0 0 4686 6747" width="4686px" zoomAndPan="magnify"><defs><filter height="300%" id="f1okzv4wtxb6c6" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="151" x="2264.25" y="28.708">PISP Linking OTP</text><rect fill="#DDDDDD" height="6700.8516" style="stroke:#A80036;stroke-width:1.0;" width="1122.5" x="484.5" y="40.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="180" x="955.75" y="53.02">PISP tp-scheme-adapter</text><rect fill="#DDDDDD" height="6700.8516" style="stroke:#A80036;stroke-width:1.0;" width="920.5" x="2022" y="40.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="67" x="2448.75" y="53.02">Mojaloop</text><rect fill="#DDDDDD" height="6700.8516" style="stroke:#A80036;stroke-width:1.0;" width="658" x="3213" y="40.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="186" x="3449" y="53.02">DFSP tp-scheme-adapter</text><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="1481.6328" style="stroke:#A80036;stroke-width:1.0;" width="10" x="71.5" y="202.7813"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="4620.5703" style="stroke:#A80036;stroke-width:1.0;" width="10" x="71.5" y="2073.9375"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="1481.6328" style="stroke:#A80036;stroke-width:1.0;" width="10" x="550.5" y="202.7813"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="4620.5703" style="stroke:#A80036;stroke-width:1.0;" width="10" x="550.5" y="2073.9375"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="375.6563" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1026.5" y="446.2422"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="133.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1026.5" y="1521.75"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="209.1953" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1026.5" y="2256.8672"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="652.8516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1026.5" y="3417.1094"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="125.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1026.5" y="6422.0469"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="155.6641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1536.5" y="1463.4844"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="129.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1536.5" y="3350.8438"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="100.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1536.5" y="6384.9141"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="467.0547" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="517.5078"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="394.6563" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="1127.0938"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="300.5938" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="2328.1328"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="331.8594" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="3148.5156"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="552.3203" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="3713.4375"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="989.1094" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="4411.2891"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="297.7266" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="6187.5859"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="652.7188" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2400.5" y="4805.9453"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="233.9297" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2841.5" y="5429.5313"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="133.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3273.5" y="851.0313"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="133.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3273.5" y="2495.1953"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="166.6641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3273.5" y="4099.0938"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="204.7969" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3273.5" y="5195.6016"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="175.6641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3273.5" y="5487.7969"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="575.3203" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3789.5" y="888.1641"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="818.5156" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3789.5" y="2532.3281"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="633.5859" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3789.5" y="4136.2266"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="984.5156" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3789.5" y="5371.2656"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="105.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="4297.5" y="1021.6953"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="279.3281" style="stroke:#000000;stroke-width:2.0;" width="1861" x="2016" y="5753.7266"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="76" x2="76" y1="95.3828" y2="6703.5078"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="555.5" x2="555.5" y1="95.3828" y2="6703.5078"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1031.5" x2="1031.5" y1="95.3828" y2="6703.5078"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1541" x2="1541" y1="95.3828" y2="6703.5078"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="2057" x2="2057" y1="95.3828" y2="6703.5078"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="2405.5" x2="2405.5" y1="95.3828" y2="6703.5078"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="2846.5" x2="2846.5" y1="95.3828" y2="6703.5078"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="3278" x2="3278" y1="95.3828" y2="6703.5078"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="3794" x2="3794" y1="95.3828" y2="6703.5078"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="4302" x2="4302" y1="95.3828" y2="6703.5078"/><rect fill="#FEFECE" filter="url(#f1okzv4wtxb6c6)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="109" x="20" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="95" x="27" y="80.0811">PISP Backend</text><rect fill="#FEFECE" filter="url(#f1okzv4wtxb6c6)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="109" x="20" y="6702.5078"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="95" x="27" y="6722.5029">PISP Backend</text><rect fill="#FEFECE" filter="url(#f1okzv4wtxb6c6)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="130" x="488.5" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="116" x="495.5" y="80.0811">outbound-server</text><rect fill="#FEFECE" filter="url(#f1okzv4wtxb6c6)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="130" x="488.5" y="6702.5078"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="116" x="495.5" y="6722.5029">outbound-server</text><rect fill="#FEFECE" filter="url(#f1okzv4wtxb6c6)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="134" x="962.5" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="120" x="969.5" y="80.0811">PISPLinkingModel</text><rect fill="#FEFECE" filter="url(#f1okzv4wtxb6c6)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="134" x="962.5" y="6702.5078"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="120" x="969.5" y="6722.5029">PISPLinkingModel</text><rect fill="#FEFECE" filter="url(#f1okzv4wtxb6c6)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="119" x="1480" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="105" x="1487" y="80.0811">inbound-server</text><rect fill="#FEFECE" filter="url(#f1okzv4wtxb6c6)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="119" x="1480" y="6702.5078"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="105" x="1487" y="6722.5029">inbound-server</text><rect fill="#FEFECE" filter="url(#f1okzv4wtxb6c6)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="59" x="2026" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="45" x="2033" y="80.0811">Switch</text><rect fill="#FEFECE" filter="url(#f1okzv4wtxb6c6)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="59" x="2026" y="6702.5078"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="45" x="2033" y="6722.5029">Switch</text><rect fill="#FEFECE" filter="url(#f1okzv4wtxb6c6)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="100" x="2353.5" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="86" x="2360.5" y="80.0811">Auth Service</text><rect fill="#FEFECE" filter="url(#f1okzv4wtxb6c6)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="100" x="2353.5" y="6702.5078"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="86" x="2360.5" y="6722.5029">Auth Service</text><rect fill="#FEFECE" filter="url(#f1okzv4wtxb6c6)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="180" x="2754.5" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="166" x="2761.5" y="80.0811">Account Lookup Service</text><rect fill="#FEFECE" filter="url(#f1okzv4wtxb6c6)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="180" x="2754.5" y="6702.5078"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="166" x="2761.5" y="6722.5029">Account Lookup Service</text><rect fill="#FEFECE" filter="url(#f1okzv4wtxb6c6)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="119" x="3217" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="105" x="3224" y="80.0811">inbound-server</text><rect fill="#FEFECE" filter="url(#f1okzv4wtxb6c6)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="119" x="3217" y="6702.5078"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="105" x="3224" y="6722.5029">inbound-server</text><rect fill="#FEFECE" filter="url(#f1okzv4wtxb6c6)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="141" x="3722" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="127" x="3729" y="80.0811">DFSPLinkingModel</text><rect fill="#FEFECE" filter="url(#f1okzv4wtxb6c6)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="141" x="3722" y="6702.5078"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="127" x="3729" y="6722.5029">DFSPLinkingModel</text><rect fill="#FEFECE" filter="url(#f1okzv4wtxb6c6)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="181" x="4210" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="167" x="4217" y="80.0811">DFSPAuthorizeSimulator</text><rect fill="#FEFECE" filter="url(#f1okzv4wtxb6c6)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="181" x="4210" y="6702.5078"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="167" x="4217" y="6722.5029">DFSPAuthorizeSimulator</text><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="1481.6328" style="stroke:#A80036;stroke-width:1.0;" width="10" x="71.5" y="202.7813"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="4620.5703" style="stroke:#A80036;stroke-width:1.0;" width="10" x="71.5" y="2073.9375"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="1481.6328" style="stroke:#A80036;stroke-width:1.0;" width="10" x="550.5" y="202.7813"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="4620.5703" style="stroke:#A80036;stroke-width:1.0;" width="10" x="550.5" y="2073.9375"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="375.6563" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1026.5" y="446.2422"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="133.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1026.5" y="1521.75"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="209.1953" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1026.5" y="2256.8672"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="652.8516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1026.5" y="3417.1094"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="125.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1026.5" y="6422.0469"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="155.6641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1536.5" y="1463.4844"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="129.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1536.5" y="3350.8438"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="100.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1536.5" y="6384.9141"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="467.0547" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="517.5078"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="394.6563" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="1127.0938"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="300.5938" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="2328.1328"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="331.8594" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="3148.5156"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="552.3203" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="3713.4375"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="989.1094" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="4411.2891"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="297.7266" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="6187.5859"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="652.7188" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2400.5" y="4805.9453"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="233.9297" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2841.5" y="5429.5313"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="133.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3273.5" y="851.0313"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="133.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3273.5" y="2495.1953"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="166.6641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3273.5" y="4099.0938"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="204.7969" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3273.5" y="5195.6016"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="175.6641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3273.5" y="5487.7969"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="575.3203" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3789.5" y="888.1641"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="818.5156" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3789.5" y="2532.3281"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="633.5859" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3789.5" y="4136.2266"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="984.5156" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3789.5" y="5371.2656"/><rect fill="#FFFFFF" filter="url(#f1okzv4wtxb6c6)" height="105.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="4297.5" y="1021.6953"/><rect fill="#EEEEEE" filter="url(#f1okzv4wtxb6c6)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="4679.5" x="0" y="125.9492"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="4679.5" y1="125.9492" y2="125.9492"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="4679.5" y1="128.9492" y2="128.9492"/><rect fill="#EEEEEE" filter="url(#f1okzv4wtxb6c6)" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="189" x="2245.25" y="115.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="170" x="2251.25" y="131.4497">Request Consent - OTP</text><rect fill="#FBFB77" filter="url(#f1okzv4wtxb6c6)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="485" x="81" y="153.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="477" x="85" y="169.5825">PISP presents accounts to user. User selects one or more accounts to link.</text><polygon fill="#A80036" points="538.5,198.7813,548.5,202.7813,538.5,206.7813,542.5,202.7813" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="81.5" x2="544.5" y1="202.7813" y2="202.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="88.5" y="197.7153">REQUEST-CONSENT-1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="246.5" y="197.7153">POST /linking/request-consent</text><rect fill="#ADD8E6" filter="url(#f1okzv4wtxb6c6)" height="129" style="stroke:#A80036;stroke-width:1.0;" width="570" x="86" y="215.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="90" y="231.8481">POST /linking/request-consent</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="90" y="246.981">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="81" x="98" y="262.1138">"accounts": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="507" x="106" y="277.2466">{ accountNickname: "XXXXXXnt", id: "dfspa.username.1234", currency: "ZAR" },</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="546" x="106" y="292.3794">{ accountNickname: "SpeXXXXXXXXnt", id: "dfspa.username.5678", currency: "USD" }</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="9" x="98" y="307.5122">],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="204" x="98" y="322.645">callbackURI: 'pisp-app://callback'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="90" y="337.7778">}</text><line style="stroke:#A80036;stroke-width:1.0;" x1="560.5" x2="602.5" y1="370.9766" y2="370.9766"/><line style="stroke:#A80036;stroke-width:1.0;" x1="602.5" x2="602.5" y1="370.9766" y2="383.9766"/><line style="stroke:#A80036;stroke-width:1.0;" x1="561.5" x2="602.5" y1="383.9766" y2="383.9766"/><polygon fill="#A80036" points="571.5,379.9766,561.5,383.9766,571.5,387.9766,567.5,383.9766" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="567.5" y="365.9106">REQUEST-CONSENT-2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="186" x="725.5" y="365.9106">const model = await create()</text><rect fill="#FBFB77" filter="url(#f1okzv4wtxb6c6)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="79" x="565" y="396.9766"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="569" y="413.0435">state: start</text><polygon fill="#A80036" points="1014.5,442.2422,1024.5,446.2422,1014.5,450.2422,1018.5,446.2422" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="560.5" x2="1020.5" y1="446.2422" y2="446.2422"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="567.5" y="441.1763">REQUEST-CONSENT-3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="156" x="725.5" y="441.1763">model.requestConsent()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1036.5" x2="1078.5" y1="475.375" y2="475.375"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1078.5" x2="1078.5" y1="475.375" y2="488.375"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1037.5" x2="1078.5" y1="488.375" y2="488.375"/><polygon fill="#A80036" points="1047.5,484.375,1037.5,488.375,1047.5,492.375,1043.5,488.375" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="1043.5" y="470.3091">REQUEST-CONSENT-4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="277" x="1201.5" y="470.3091">ThirdpartyRequests.postConsentRequests()</text><polygon fill="#A80036" points="2040.5,513.5078,2050.5,517.5078,2040.5,521.5078,2044.5,517.5078" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1036.5" x2="2046.5" y1="517.5078" y2="517.5078"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="1043.5" y="512.4419">REQUEST-CONSENT-5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="152" x="1201.5" y="512.4419">POST /consentRequests</text><rect fill="#ADD8E6" filter="url(#f1okzv4wtxb6c6)" height="265" style="stroke:#A80036;stroke-width:1.0;" width="358" x="1041" y="530.5078"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="152" x="1045" y="546.5747">POST /consentRequests</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="1045" y="561.7075">FSIOP-Source: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="1045" y="576.8403">FSIOP-Destination: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1045" y="591.9731">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="277" x="1053" y="607.106">// consentRequestId will be the uuid created</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="142" x="1053" y="622.2388">// at the PRELINKING-2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154" x="1053" y="637.3716">consentRequestId: 6789</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66" x="1053" y="652.5044">scopes: [{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="1061" y="667.6372">accountId: 'dfspa.username.1234',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="1061" y="682.77">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="1061" y="697.9028">accountId: 'dfspa.username.5678',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="1061" y="713.0356">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="17" x="1053" y="728.1685">}],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="208" x="1053" y="743.3013">// model will add `authChannels`</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="145" x="1053" y="758.4341">authChannels: ["OTP"],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="216" x="1053" y="773.5669">callbackURI: 'pisp-app://callback...'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1045" y="788.6997">}</text><polygon fill="#A80036" points="1042.5,817.8984,1032.5,821.8984,1042.5,825.8984,1038.5,821.8984" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1036.5" x2="2051.5" y1="821.8984" y2="821.8984"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="1048.5" y="816.8325">REQUEST-CONSENT-6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="1206.5" y="816.8325">202 Accepted</text><polygon fill="#A80036" points="3261.5,847.0313,3271.5,851.0313,3261.5,855.0313,3265.5,851.0313" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2062.5" x2="3267.5" y1="851.0313" y2="851.0313"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="2069.5" y="845.9653">REQUEST-CONSENT-7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="152" x="2227.5" y="845.9653">POST /consentRequests</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3283.5" x2="3330.5" y1="875.1641" y2="875.1641"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3330.5" x2="3330.5" y1="875.1641" y2="888.1641"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3289.5" x2="3330.5" y1="888.1641" y2="888.1641"/><polygon fill="#A80036" points="3299.5,884.1641,3289.5,888.1641,3299.5,892.1641,3295.5,888.1641" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="3295.5" y="870.0981">REQUEST-CONSENT-8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="186" x="3453.5" y="870.0981">const model = await create()</text><rect fill="#FBFB77" filter="url(#f1okzv4wtxb6c6)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="79" x="3288" y="906.1641"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="3292" y="922.231">state: start</text><polygon fill="#A80036" points="3777.5,951.4297,3787.5,955.4297,3777.5,959.4297,3781.5,955.4297" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3283.5" x2="3783.5" y1="955.4297" y2="955.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="3290.5" y="950.3638">REQUEST-CONSENT-9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="156" x="3448.5" y="950.3638">model.requestConsent()</text><polygon fill="#A80036" points="2068.5,980.5625,2058.5,984.5625,2068.5,988.5625,2064.5,984.5625" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2062.5" x2="3277.5" y1="984.5625" y2="984.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="2074.5" y="979.4966">REQUEST-CONSENT-10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2241.5" y="979.4966">202 Accepted</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3846.5" y1="1008.6953" y2="1008.6953"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3846.5" x2="3846.5" y1="1008.6953" y2="1021.6953"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3805.5" x2="3846.5" y1="1021.6953" y2="1021.6953"/><polygon fill="#A80036" points="3815.5,1017.6953,3805.5,1021.6953,3815.5,1025.6953,3811.5,1021.6953" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="3811.5" y="1003.6294">REQUEST-CONSENT-11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="317" x="3978.5" y="1003.6294">DFSPBackendRequests.validateConsentRequest()</text><polygon fill="#A80036" points="4285.5,1051.8281,4295.5,1055.8281,4285.5,1059.8281,4289.5,1055.8281" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="4291.5" y1="1055.8281" y2="1055.8281"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="3806.5" y="1050.7622">REQUEST-CONSENT-12</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="256" x="3973.5" y="1050.7622">POST /store/consentRequests/6789</text><line style="stroke:#A80036;stroke-width:1.0;" x1="4307.5" x2="4349.5" y1="1084.9609" y2="1084.9609"/><line style="stroke:#A80036;stroke-width:1.0;" x1="4349.5" x2="4349.5" y1="1084.9609" y2="1097.9609"/><line style="stroke:#A80036;stroke-width:1.0;" x1="4308.5" x2="4349.5" y1="1097.9609" y2="1097.9609"/><polygon fill="#A80036" points="4318.5,1093.9609,4308.5,1097.9609,4318.5,1101.9609,4314.5,1097.9609" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="4314.5" y="1079.895">REQUEST-CONSENT-13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="186" x="4481.5" y="1079.895">store consentRequest details</text><polygon fill="#A80036" points="3810.5,1123.0938,3800.5,1127.0938,3810.5,1131.0938,3806.5,1127.0938" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3804.5" x2="4301.5" y1="1127.0938" y2="1127.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="3816.5" y="1122.0278">REQUEST-CONSENT-14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="3983.5" y="1122.0278">201 Created</text><rect fill="#FBFB77" filter="url(#f1okzv4wtxb6c6)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="280" x="3804" y="1140.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="272" x="3808" y="1156.1606">state: consentRequestValidatedAndStored</text><polygon fill="#A80036" points="2073.5,1185.3594,2063.5,1189.3594,2073.5,1193.3594,2069.5,1189.3594" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2067.5" x2="3788.5" y1="1189.3594" y2="1189.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="2079.5" y="1184.2935">REQUEST-CONSENT-15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="179" x="2246.5" y="1184.2935">PUT /consentRequests/6789</text><rect fill="#ADD8E6" filter="url(#f1okzv4wtxb6c6)" height="234" style="stroke:#A80036;stroke-width:1.0;" width="457" x="3327" y="1202.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="179" x="3331" y="1218.4263">PUT /consentRequests/6789</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="3331" y="1233.5591">FSIOP-Source: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="3331" y="1248.6919">FSIOP-Destination: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3331" y="1263.8247">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154" x="3339" y="1278.9575">consentRequestId: 6789</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66" x="3339" y="1294.0903">scopes: [{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="3347" y="1309.2231">accountId: 'dfspa.username.1234',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="3347" y="1324.356">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="3347" y="1339.4888">accountId: 'dfspa.username.5678',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="3347" y="1354.6216">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="17" x="3339" y="1369.7544">}],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="145" x="3339" y="1384.8872">authChannels: ["OTP"],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="3339" y="1400.02">callbackURI: 'pisp-app://callback...',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="441" x="3339" y="1415.1528">authURI: 'dfspa.com/authorize?consentRequestId=6789' // this is new</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3331" y="1430.2856">}</text><polygon fill="#A80036" points="3782.5,1459.4844,3792.5,1463.4844,3782.5,1467.4844,3786.5,1463.4844" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2062.5" x2="3788.5" y1="1463.4844" y2="1463.4844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="2069.5" y="1458.4185">REQUEST-CONSENT-16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="96" x="2236.5" y="1458.4185">202 ACCEPTED</text><polygon fill="#A80036" points="1557.5,1488.6172,1547.5,1492.6172,1557.5,1496.6172,1553.5,1492.6172" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1551.5" x2="2051.5" y1="1492.6172" y2="1492.6172"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1563.5" y="1487.5513">REQUEST-CONSENT-17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="179" x="1730.5" y="1487.5513">PUT /consentRequests/6789</text><polygon fill="#A80036" points="2045.5,1517.75,2055.5,1521.75,2045.5,1525.75,2049.5,1521.75" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1546.5" x2="2051.5" y1="1521.75" y2="1521.75"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1553.5" y="1516.6841">REQUEST-CONSENT-18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="1720.5" y="1516.6841">200 OK</text><polygon fill="#A80036" points="1047.5,1546.8828,1037.5,1550.8828,1047.5,1554.8828,1043.5,1550.8828" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1041.5" x2="1535.5" y1="1550.8828" y2="1550.8828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1053.5" y="1545.8169">REQUEST-CONSENT-19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="230" x="1220.5" y="1545.8169">Consent Request response recieved</text><rect fill="#FBFB77" filter="url(#f1okzv4wtxb6c6)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="338" x="1041" y="1563.8828"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="330" x="1045" y="1579.9497">state: OTPAuthenticationChannelResponseRecieved</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1036.5" x2="1078.5" y1="1618.1484" y2="1618.1484"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1078.5" x2="1078.5" y1="1618.1484" y2="1631.1484"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1031.5" x2="1078.5" y1="1631.1484" y2="1631.1484"/><polygon fill="#A80036" points="1041.5,1627.1484,1031.5,1631.1484,1041.5,1635.1484,1037.5,1631.1484" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1043.5" y="1613.0825">REQUEST-CONSENT-20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="108" x="1210.5" y="1613.0825">this.saveToKVS()</text><polygon fill="#A80036" points="571.5,1651.2813,561.5,1655.2813,571.5,1659.2813,567.5,1655.2813" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="565.5" x2="1030.5" y1="1655.2813" y2="1655.2813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="577.5" y="1650.2153">REQUEST-CONSENT-21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="202" x="744.5" y="1650.2153">return Authentication Response</text><polygon fill="#A80036" points="87.5,1680.4141,77.5,1684.4141,87.5,1688.4141,83.5,1684.4141" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="81.5" x2="554.5" y1="1684.4141" y2="1684.4141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="93.5" y="1679.3481">REQUEST-CONSENT-22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="201" x="260.5" y="1679.3481">200 OK Autentication Response</text><rect fill="#ADD8E6" filter="url(#f1okzv4wtxb6c6)" height="234" style="stroke:#A80036;stroke-width:1.0;" width="465" x="85" y="1697.4141"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="89" y="1713.481">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="128" x="97" y="1728.6138">channelResponse: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154" x="105" y="1743.7466">consentRequestId: 6789</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66" x="105" y="1758.8794">scopes: [{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="113" y="1774.0122">accountId: 'dfspa.username.1234',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="113" y="1789.145">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="113" y="1804.2778">accountId: 'dfspa.username.5678',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="113" y="1819.4106">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="17" x="105" y="1834.5435">}],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="145" x="105" y="1849.6763">authChannels: ["OTP"],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="105" y="1864.8091">callbackURI: 'pisp-app://callback...',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="441" x="105" y="1879.9419">authURI: 'dfspa.com/authorize?consentRequestId=6789' // this is new</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="12" x="97" y="1895.0747">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="391" x="97" y="1910.2075">currentState="OTPAuthenticationChannelResponseRecieved"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="89" y="1925.3403">}</text><path d="M5,1942.4063 L5,1967.4063 L4375,1967.4063 L4375,1952.4063 L4365,1942.4063 L5,1942.4063 " fill="#FBFB77" filter="url(#f1okzv4wtxb6c6)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M4365,1942.4063 L4365,1952.4063 L4375,1952.4063 L4365,1942.4063 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="609" x="1879" y="1959.4731">The DFSP is expected to send an OTP to the end user which will be used in the next linking step.</text><rect fill="#EEEEEE" filter="url(#f1okzv4wtxb6c6)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="4679.5" x="0" y="1997.1055"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="4679.5" y1="1997.1055" y2="1997.1055"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="4679.5" y1="2000.1055" y2="2000.1055"/><rect fill="#EEEEEE" filter="url(#f1okzv4wtxb6c6)" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="397" x="2141.25" y="1986.5391"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="378" x="2147.25" y="2002.606">Authentication+Grant Consent+Register Credential</text><rect fill="#FBFB77" filter="url(#f1okzv4wtxb6c6)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="503" x="81" y="2024.6719"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="495" x="85" y="2040.7388">PISP has obtained authToken from end-user(OTP) or through a callback(Web).</text><polygon fill="#A80036" points="538.5,2069.9375,548.5,2073.9375,538.5,2077.9375,542.5,2073.9375" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="81.5" x2="544.5" y1="2073.9375" y2="2073.9375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="88.5" y="2068.8716">AUTHENTICATION-1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="312" x="231.5" y="2068.8716">POST /linking/request-consent/6789/authenticate</text><rect fill="#ADD8E6" filter="url(#f1okzv4wtxb6c6)" height="68" style="stroke:#A80036;stroke-width:1.0;" width="320" x="86" y="2086.9375"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="312" x="90" y="2103.0044">POST /linking/request-consent/6789/authenticate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="90" y="2118.1372">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="98" y="2133.27">authToken: '123456'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="90" y="2148.4028">}</text><line style="stroke:#A80036;stroke-width:1.0;" x1="560.5" x2="602.5" y1="2181.6016" y2="2181.6016"/><line style="stroke:#A80036;stroke-width:1.0;" x1="602.5" x2="602.5" y1="2181.6016" y2="2194.6016"/><line style="stroke:#A80036;stroke-width:1.0;" x1="561.5" x2="602.5" y1="2194.6016" y2="2194.6016"/><polygon fill="#A80036" points="571.5,2190.6016,561.5,2194.6016,571.5,2198.6016,567.5,2194.6016" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="567.5" y="2176.5356">AUTHENTICATION-2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="309" x="710.5" y="2176.5356">const model = await loadFromKVS({key: 6789})</text><rect fill="#FBFB77" filter="url(#f1okzv4wtxb6c6)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="648" x="565" y="2207.6016"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="640" x="569" y="2223.6685">state: webAuthenticationChannelResponseRecieved or OTPAuthenticationChannelResponseRecieved</text><polygon fill="#A80036" points="1014.5,2252.8672,1024.5,2256.8672,1014.5,2260.8672,1018.5,2256.8672" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="560.5" x2="1020.5" y1="2256.8672" y2="2256.8672"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="567.5" y="2251.8013">AUTHENTICATION-3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="710.5" y="2251.8013">model.authenticate()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1036.5" x2="1078.5" y1="2286" y2="2286"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1078.5" x2="1078.5" y1="2286" y2="2299"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1037.5" x2="1078.5" y1="2299" y2="2299"/><polygon fill="#A80036" points="1047.5,2295,1037.5,2299,1047.5,2303,1043.5,2299" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="1043.5" y="2280.9341">AUTHENTICATION-4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="285" x="1186.5" y="2280.9341">ThirdpartyRequests.patchConsentRequests()</text><polygon fill="#A80036" points="2040.5,2324.1328,2050.5,2328.1328,2040.5,2332.1328,2044.5,2328.1328" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1036.5" x2="2046.5" y1="2328.1328" y2="2328.1328"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="1043.5" y="2323.0669">AUTHENTICATION-5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="197" x="1186.5" y="2323.0669">PATCH /consentRequests/6789</text><rect fill="#ADD8E6" filter="url(#f1okzv4wtxb6c6)" height="98" style="stroke:#A80036;stroke-width:1.0;" width="205" x="1041" y="2341.1328"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="197" x="1045" y="2357.1997">PATCH /consentRequests/6789</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="1045" y="2372.3325">FSIOP-Source: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="1045" y="2387.4653">FSIOP-Destination: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1045" y="2402.5981">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="1053" y="2417.731">authToken: '124356'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1045" y="2432.8638">}</text><polygon fill="#A80036" points="1042.5,2462.0625,1032.5,2466.0625,1042.5,2470.0625,1038.5,2466.0625" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1036.5" x2="2051.5" y1="2466.0625" y2="2466.0625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="1048.5" y="2460.9966">AUTHENTICATION-6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="1191.5" y="2460.9966">202 Accepted</text><polygon fill="#A80036" points="3261.5,2491.1953,3271.5,2495.1953,3261.5,2499.1953,3265.5,2495.1953" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2062.5" x2="3267.5" y1="2495.1953" y2="2495.1953"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="2069.5" y="2490.1294">AUTHENTICATION-7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="197" x="2212.5" y="2490.1294">PATCH /consentRequests/6789</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3283.5" x2="3330.5" y1="2519.3281" y2="2519.3281"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3330.5" x2="3330.5" y1="2519.3281" y2="2532.3281"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3289.5" x2="3330.5" y1="2532.3281" y2="2532.3281"/><polygon fill="#A80036" points="3299.5,2528.3281,3289.5,2532.3281,3299.5,2536.3281,3295.5,2532.3281" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="3295.5" y="2514.2622">AUTHENTICATION-8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="309" x="3438.5" y="2514.2622">const model = await loadFromKVS({key: 6789})</text><rect fill="#FBFB77" filter="url(#f1okzv4wtxb6c6)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="280" x="3288" y="2550.3281"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="272" x="3292" y="2566.395">state: consentRequestValidatedAndStored</text><polygon fill="#A80036" points="3777.5,2595.5938,3787.5,2599.5938,3777.5,2603.5938,3781.5,2599.5938" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3283.5" x2="3783.5" y1="2599.5938" y2="2599.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="3290.5" y="2594.5278">AUTHENTICATION-9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="172" x="3433.5" y="2594.5278">model.validateAuthToken()</text><polygon fill="#A80036" points="2068.5,2624.7266,2058.5,2628.7266,2068.5,2632.7266,2064.5,2628.7266" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2062.5" x2="3277.5" y1="2628.7266" y2="2628.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2074.5" y="2623.6606">AUTHENTICATION-10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2226.5" y="2623.6606">202 Accepted</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3841.5" y1="2657.8594" y2="2657.8594"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3841.5" x2="3841.5" y1="2657.8594" y2="2670.8594"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3800.5" x2="3841.5" y1="2670.8594" y2="2670.8594"/><polygon fill="#A80036" points="3810.5,2666.8594,3800.5,2670.8594,3810.5,2674.8594,3806.5,2670.8594" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3806.5" y="2652.7935">AUTHENTICATION-11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="280" x="3958.5" y="2652.7935">DFSPBackendRequests.validateAuthToken()</text><rect fill="#ADD8E6" filter="url(#f1okzv4wtxb6c6)" height="159" style="stroke:#A80036;stroke-width:1.0;" width="416" x="3804" y="2683.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="312" x="3808" y="2699.9263">Do we need two backend endpoints for validating</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="408" x="3808" y="2715.0591">web authTokens and OTP authTokens? Or is a DFSP expected to</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="248" x="3808" y="2730.1919">validate both cases with one endpoint?</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="0" x="3812" y="2745.3247"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="160" x="3808" y="2760.4575">POST /validateAuthToken</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3808" y="2775.5903">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="160" x="3816" y="2790.7231">consentRequestId: '6789'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="251" x="3816" y="2805.856">authChannel: model.data.authChannel,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="3816" y="2820.9888">authToken: '124356'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3808" y="2836.1216">}</text><rect fill="#FBFB77" filter="url(#f1okzv4wtxb6c6)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="176" x="3804" y="2853.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="168" x="3808" y="2869.2544">state: authTokenValidated</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3841.5" y1="2902.4531" y2="2902.4531"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3841.5" x2="3841.5" y1="2902.4531" y2="2915.4531"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3800.5" x2="3841.5" y1="2915.4531" y2="2915.4531"/><polygon fill="#A80036" points="3810.5,2911.4531,3800.5,2915.4531,3810.5,2919.4531,3806.5,2915.4531" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3806.5" y="2897.3872">AUTHENTICATION-12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="157" x="3958.5" y="2897.3872">const consentId = uuid()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3841.5" y1="2944.5859" y2="2944.5859"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3841.5" x2="3841.5" y1="2944.5859" y2="2957.5859"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3800.5" x2="3841.5" y1="2957.5859" y2="2957.5859"/><polygon fill="#A80036" points="3810.5,2953.5859,3800.5,2957.5859,3810.5,2961.5859,3806.5,2957.5859" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3806.5" y="2939.52">AUTHENTICATION-13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="141" x="3958.5" y="2939.52">model.grantConsent()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3841.5" y1="2986.7188" y2="2986.7188"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3841.5" x2="3841.5" y1="2986.7188" y2="2999.7188"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3800.5" x2="3841.5" y1="2999.7188" y2="2999.7188"/><polygon fill="#A80036" points="3810.5,2995.7188,3800.5,2999.7188,3810.5,3003.7188,3806.5,2999.7188" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3806.5" y="2981.6528">AUTHENTICATION-14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="225" x="3958.5" y="2981.6528">ThirdpartyRequests.postConsents()</text><rect fill="#FBFB77" filter="url(#f1okzv4wtxb6c6)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="152" x="3804" y="3012.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="144" x="3808" y="3028.7856">state: consentGranted</text><rect fill="#ADD8E6" filter="url(#f1okzv4wtxb6c6)" height="68" style="stroke:#A80036;stroke-width:1.0;" width="495" x="3804" y="3045.8516"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="484" x="3808" y="3061.9185">It's important to save the model with the consentId from this point onwards!</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="458" x="3808" y="3077.0513">Requests will not contain a consentRequestId in the upcoming requests.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="487" x="3808" y="3092.1841">This may require changing `PersistentModel` to have a secondary key it can</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="3808" y="3107.3169">store the model with.</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3846.5" y1="3135.5156" y2="3135.5156"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3846.5" x2="3846.5" y1="3135.5156" y2="3148.5156"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3805.5" x2="3846.5" y1="3148.5156" y2="3148.5156"/><polygon fill="#A80036" points="3815.5,3144.5156,3805.5,3148.5156,3815.5,3152.5156,3811.5,3148.5156" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3811.5" y="3130.4497">AUTHENTICATION-15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="223" x="3963.5" y="3130.4497">this.saveToKVS({key: '1a2b3c4d'})</text><polygon fill="#A80036" points="2073.5,3178.6484,2063.5,3182.6484,2073.5,3186.6484,2069.5,3182.6484" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2067.5" x2="3788.5" y1="3182.6484" y2="3182.6484"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2079.5" y="3177.5825">AUTHENTICATION-16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100" x="2231.5" y="3177.5825">POST /consents</text><rect fill="#ADD8E6" filter="url(#f1okzv4wtxb6c6)" height="129" style="stroke:#A80036;stroke-width:1.0;" width="191" x="3593" y="3195.6484"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100" x="3597" y="3211.7153">POST /consents</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="130" x="3597" y="3226.8481">FSIOP-Source: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="157" x="3597" y="3241.981">FSIOP-Destination: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3597" y="3257.1138">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="133" x="3605" y="3272.2466">consentId: 1a2b3c4d</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154" x="3605" y="3287.3794">consentRequestId: 6789</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="175" x="3605" y="3302.5122">scopes: model.data.scopes</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3597" y="3317.645">}</text><polygon fill="#A80036" points="3782.5,3346.8438,3792.5,3350.8438,3782.5,3354.8438,3786.5,3350.8438" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2062.5" x2="3788.5" y1="3350.8438" y2="3350.8438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2069.5" y="3345.7778">AUTHENTICATION-17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="96" x="2221.5" y="3345.7778">202 ACCEPTED</text><polygon fill="#A80036" points="1557.5,3375.9766,1547.5,3379.9766,1557.5,3383.9766,1553.5,3379.9766" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1551.5" x2="2051.5" y1="3379.9766" y2="3379.9766"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1563.5" y="3374.9106">AUTHENTICATION-18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100" x="1715.5" y="3374.9106">POST /consents</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1546.5" x2="1593.5" y1="3404.1094" y2="3404.1094"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1593.5" x2="1593.5" y1="3404.1094" y2="3417.1094"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1552.5" x2="1593.5" y1="3417.1094" y2="3417.1094"/><polygon fill="#A80036" points="1562.5,3413.1094,1552.5,3417.1094,1562.5,3421.1094,1558.5,3417.1094" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1558.5" y="3399.0435">AUTHENTICATION-19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="309" x="1710.5" y="3399.0435">const model = await loadFromKVS({key: 6789})</text><polygon fill="#A80036" points="1047.5,3447.2422,1037.5,3451.2422,1047.5,3455.2422,1043.5,3451.2422" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1041.5" x2="1535.5" y1="3451.2422" y2="3451.2422"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1053.5" y="3446.1763">AUTHENTICATION-20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="168" x="1205.5" y="3446.1763">model.registerCredential()</text><polygon fill="#A80036" points="2045.5,3476.375,2055.5,3480.375,2045.5,3484.375,2049.5,3480.375" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1541.5" x2="2051.5" y1="3480.375" y2="3480.375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1548.5" y="3475.3091">AUTHENTICATION-21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="1700.5" y="3475.3091">202 Accepted</text><rect fill="#FBFB77" filter="url(#f1okzv4wtxb6c6)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="157" x="1041" y="3493.375"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="149" x="1045" y="3509.4419">state: consentRecieved</text><rect fill="#ADD8E6" filter="url(#f1okzv4wtxb6c6)" height="68" style="stroke:#A80036;stroke-width:1.0;" width="495" x="1041" y="3526.5078"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="484" x="1045" y="3542.5747">It's important to save the model with the consentId from this point onwards!</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="458" x="1045" y="3557.7075">Requests will not contain a consentRequestId in the upcoming requests.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="487" x="1045" y="3572.8403">This may require changing `PersistentModel` to have a secondary key it can</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="1045" y="3587.9731">store the model with.</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1036.5" x2="1078.5" y1="3621.1719" y2="3621.1719"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1078.5" x2="1078.5" y1="3621.1719" y2="3634.1719"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1037.5" x2="1078.5" y1="3634.1719" y2="3634.1719"/><polygon fill="#A80036" points="1047.5,3630.1719,1037.5,3634.1719,1047.5,3638.1719,1043.5,3634.1719" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1043.5" y="3616.106">AUTHENTICATION-22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="1195.5" y="3616.106">const challenge = deriveChallenge(consentRequest)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1036.5" x2="1078.5" y1="3663.3047" y2="3663.3047"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1078.5" x2="1078.5" y1="3663.3047" y2="3676.3047"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1037.5" x2="1078.5" y1="3676.3047" y2="3676.3047"/><polygon fill="#A80036" points="1047.5,3672.3047,1037.5,3676.3047,1047.5,3680.3047,1043.5,3676.3047" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1043.5" y="3658.2388">AUTHENTICATION-23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="223" x="1195.5" y="3658.2388">this.saveToKVS({key: '1a2b3c4d'})</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1036.5" x2="1083.5" y1="3700.4375" y2="3700.4375"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1083.5" x2="1083.5" y1="3700.4375" y2="3713.4375"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1042.5" x2="1083.5" y1="3713.4375" y2="3713.4375"/><polygon fill="#A80036" points="1052.5,3709.4375,1042.5,3713.4375,1052.5,3717.4375,1048.5,3713.4375" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1048.5" y="3695.3716">AUTHENTICATION-24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="218" x="1200.5" y="3695.3716">ThirdpartyRequests.putConsents()</text><rect fill="#FBFB77" filter="url(#f1okzv4wtxb6c6)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="174" x="1041" y="3731.4375"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="166" x="1045" y="3747.5044">state: signedConsentSent</text><polygon fill="#A80036" points="2040.5,3776.7031,2050.5,3780.7031,2040.5,3784.7031,2044.5,3780.7031" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1036.5" x2="2046.5" y1="3780.7031" y2="3780.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1043.5" y="3775.6372">AUTHENTICATION-25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="1195.5" y="3775.6372">PUT /consents/1a2b3c4d</text><rect fill="#ADD8E6" filter="url(#f1okzv4wtxb6c6)" height="250" style="stroke:#A80036;stroke-width:1.0;" width="358" x="1041" y="3793.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="1045" y="3809.77">PUT /consents/1a2b3c4d</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="1045" y="3824.9028">FSIOP-Source: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="1045" y="3840.0356">FSIOP-Destination: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1045" y="3855.1685">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66" x="1053" y="3870.3013">scopes: [{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="1061" y="3885.4341">accountId: 'dfspa.username.1234',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="1061" y="3900.5669">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="1061" y="3915.6997">accountId: 'dfspa.username.5678',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="1061" y="3930.8325">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="17" x="1053" y="3945.9653">}],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="1053" y="3961.0981">credential: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="145" x="1061" y="3976.231">credentialType: "FIDO",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="121" x="1061" y="3991.3638">status: "PENDING",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="183" x="1061" y="4006.4966">payload: PublicKeyCredential</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1053" y="4021.6294">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1045" y="4036.7622">}</text><polygon fill="#A80036" points="1042.5,4065.9609,1032.5,4069.9609,1042.5,4073.9609,1038.5,4069.9609" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1036.5" x2="2051.5" y1="4069.9609" y2="4069.9609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1048.5" y="4064.895">AUTHENTICATION-26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="1200.5" y="4064.895">202 Accepted</text><polygon fill="#A80036" points="3261.5,4095.0938,3271.5,4099.0938,3261.5,4103.0938,3265.5,4099.0938" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2062.5" x2="3267.5" y1="4099.0938" y2="4099.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2069.5" y="4094.0278">AUTHENTICATION-27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="2221.5" y="4094.0278">PUT /consents/1a2b3c4d</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3283.5" x2="3330.5" y1="4123.2266" y2="4123.2266"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3330.5" x2="3330.5" y1="4123.2266" y2="4136.2266"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3289.5" x2="3330.5" y1="4136.2266" y2="4136.2266"/><polygon fill="#A80036" points="3299.5,4132.2266,3289.5,4136.2266,3299.5,4140.2266,3295.5,4136.2266" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3295.5" y="4118.1606">AUTHENTICATION-28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="340" x="3447.5" y="4118.1606">const model = await loadFromKVS({key: 1a2b3c4d})</text><rect fill="#FBFB77" filter="url(#f1okzv4wtxb6c6)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="201" x="3288" y="4154.2266"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="193" x="3292" y="4170.2935">state: signedConsentRecieved</text><polygon fill="#A80036" points="3777.5,4199.4922,3787.5,4203.4922,3777.5,4207.4922,3781.5,4203.4922" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3283.5" x2="3783.5" y1="4203.4922" y2="4203.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3290.5" y="4198.4263">AUTHENTICATION-29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="201" x="3442.5" y="4198.4263">model.validateSignedConsent()</text><rect fill="#FBFB77" filter="url(#f1okzv4wtxb6c6)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="264" x="3288" y="4216.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="256" x="3292" y="4232.5591">state: pendingRegistrationAndValidation</text><polygon fill="#A80036" points="2068.5,4261.7578,2058.5,4265.7578,2068.5,4269.7578,2064.5,4265.7578" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2062.5" x2="3277.5" y1="4265.7578" y2="4265.7578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2074.5" y="4260.6919">AUTHENTICATION-30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2226.5" y="4260.6919">202 Accepted</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3841.5" y1="4294.8906" y2="4294.8906"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3841.5" x2="3841.5" y1="4294.8906" y2="4307.8906"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3800.5" x2="3841.5" y1="4307.8906" y2="4307.8906"/><polygon fill="#A80036" points="3810.5,4303.8906,3800.5,4307.8906,3810.5,4311.8906,3806.5,4307.8906" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3806.5" y="4289.8247">AUTHENTICATION-31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="144" x="3958.5" y="4289.8247">Check signed consent.</text><rect fill="#ADD8E6" filter="url(#f1okzv4wtxb6c6)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="530" x="3804" y="4320.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="522" x="3808" y="4336.9575">Does this need a backend request or can the scheme adapter check the consent.</text><rect fill="#FBFB77" filter="url(#f1okzv4wtxb6c6)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="199" x="3804" y="4354.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="3808" y="4370.0903">state: signedConsentChecked</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3846.5" y1="4398.2891" y2="4398.2891"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3846.5" x2="3846.5" y1="4398.2891" y2="4411.2891"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3805.5" x2="3846.5" y1="4411.2891" y2="4411.2891"/><polygon fill="#A80036" points="3815.5,4407.2891,3805.5,4411.2891,3815.5,4415.2891,3811.5,4411.2891" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3811.5" y="4393.2231">AUTHENTICATION-32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="208" x="3963.5" y="4393.2231">model.validateWithAuthService()</text><polygon fill="#A80036" points="2073.5,4441.4219,2063.5,4445.4219,2073.5,4449.4219,2069.5,4445.4219" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2067.5" x2="3788.5" y1="4445.4219" y2="4445.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2079.5" y="4440.356">AUTHENTICATION-33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="167" x="2231.5" y="4440.356">POST /consents/1a2b3c4d</text><rect fill="#ADD8E6" filter="url(#f1okzv4wtxb6c6)" height="250" style="stroke:#A80036;stroke-width:1.0;" width="358" x="3426" y="4458.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="167" x="3430" y="4474.4888">POST /consents/1a2b3c4d</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="130" x="3430" y="4489.6216">FSIOP-Source: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="201" x="3430" y="4504.7544">FSIOP-Destination: central-auth</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3430" y="4519.8872">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66" x="3438" y="4535.02">scopes: [{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="3446" y="4550.1528">accountId: 'dfspa.username.1234',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="3446" y="4565.2856">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="3446" y="4580.4185">accountId: 'dfspa.username.5678',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="3446" y="4595.5513">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="17" x="3438" y="4610.6841">}],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="3438" y="4625.8169">credential: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="145" x="3446" y="4640.9497">credentialType: "FIDO",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="121" x="3446" y="4656.0825">status: "PENDING",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="183" x="3446" y="4671.2153">payload: PublicKeyCredential</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3438" y="4686.3481">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3430" y="4701.481">}</text><polygon fill="#A80036" points="3777.5,4730.6797,3787.5,4734.6797,3777.5,4738.6797,3781.5,4734.6797" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2062.5" x2="3783.5" y1="4734.6797" y2="4734.6797"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2069.5" y="4729.6138">AUTHENTICATION-34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2221.5" y="4729.6138">202 Accepted</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3841.5" y1="4768.8125" y2="4768.8125"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3841.5" x2="3841.5" y1="4768.8125" y2="4781.8125"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3794.5" x2="3841.5" y1="4781.8125" y2="4781.8125"/><polygon fill="#A80036" points="3804.5,4777.8125,3794.5,4781.8125,3804.5,4785.8125,3800.5,4781.8125" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3806.5" y="4763.7466">AUTHENTICATION-35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="108" x="3958.5" y="4763.7466">this.saveToKVS()</text><polygon fill="#A80036" points="2388.5,4801.9453,2398.5,4805.9453,2388.5,4809.9453,2392.5,4805.9453" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2062.5" x2="2394.5" y1="4805.9453" y2="4805.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2069.5" y="4800.8794">AUTHENTICATION-36</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="167" x="2221.5" y="4800.8794">POST /consents/1a2b3c4d</text><polygon fill="#A80036" points="2073.5,4831.0781,2063.5,4835.0781,2073.5,4839.0781,2069.5,4835.0781" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2067.5" x2="2399.5" y1="4835.0781" y2="4835.0781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2079.5" y="4830.0122">AUTHENTICATION-37</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2231.5" y="4830.0122">202 Accepted</text><line style="stroke:#A80036;stroke-width:1.0;" x1="2410.5" x2="2452.5" y1="4864.2109" y2="4864.2109"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2452.5" x2="2452.5" y1="4864.2109" y2="4877.2109"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2411.5" x2="2452.5" y1="4877.2109" y2="4877.2109"/><polygon fill="#A80036" points="2421.5,4873.2109,2411.5,4877.2109,2421.5,4881.2109,2417.5,4877.2109" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2417.5" y="4859.145">AUTHENTICATION-38</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="98" x="2569.5" y="4859.145">Check consent.</text><polygon fill="#A80036" points="2073.5,4902.3438,2063.5,4906.3438,2073.5,4910.3438,2069.5,4906.3438" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2067.5" x2="2399.5" y1="4906.3438" y2="4906.3438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2079.5" y="4901.2778">AUTHENTICATION-39</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="2231.5" y="4901.2778">PUT /consents/1a2b3c4d</text><rect fill="#ADD8E6" filter="url(#f1okzv4wtxb6c6)" height="250" style="stroke:#A80036;stroke-width:1.0;" width="358" x="2037" y="4919.3438"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="2041" y="4935.4106">PUT /consents/1a2b3c4d</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="173" x="2041" y="4950.5435">FSIOP-Source: central-auth</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="2041" y="4965.6763">FSIOP-Destination: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2041" y="4980.8091">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66" x="2049" y="4995.9419">scopes: [{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="2057" y="5011.0747">accountId: 'dfspa.username.1234',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="2057" y="5026.2075">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="2057" y="5041.3403">accountId: 'dfspa.username.5678',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="2057" y="5056.4731">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="17" x="2049" y="5071.606">}],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="2049" y="5086.7388">credential: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="145" x="2057" y="5101.8716">credentialType: "FIDO",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="118" x="2057" y="5117.0044">status: "VERIFIED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="183" x="2057" y="5132.1372">payload: PublicKeyCredential</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2049" y="5147.27">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2041" y="5162.4028">}</text><polygon fill="#A80036" points="2388.5,5191.6016,2398.5,5195.6016,2388.5,5199.6016,2392.5,5195.6016" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2062.5" x2="2394.5" y1="5195.6016" y2="5195.6016"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2069.5" y="5190.5356">AUTHENTICATION-40</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="2221.5" y="5190.5356">200 OK</text><polygon fill="#A80036" points="3261.5,5220.7344,3271.5,5224.7344,3261.5,5228.7344,3265.5,5224.7344" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2062.5" x2="3267.5" y1="5224.7344" y2="5224.7344"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2069.5" y="5219.6685">AUTHENTICATION-41</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="2221.5" y="5219.6685">PUT /consents/1a2b3c4d</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3283.5" x2="3325.5" y1="5253.8672" y2="5253.8672"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3325.5" x2="3325.5" y1="5253.8672" y2="5266.8672"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3284.5" x2="3325.5" y1="5266.8672" y2="5266.8672"/><polygon fill="#A80036" points="3294.5,5262.8672,3284.5,5266.8672,3294.5,5270.8672,3290.5,5266.8672" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3290.5" y="5248.8013">AUTHENTICATION-42</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="340" x="3442.5" y="5248.8013">const model = await loadFromKVS({key: 1a2b3c4d})</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3283.5" x2="3325.5" y1="5296" y2="5296"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3325.5" x2="3325.5" y1="5296" y2="5309"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3284.5" x2="3325.5" y1="5309" y2="5309"/><polygon fill="#A80036" points="3294.5,5305,3284.5,5309,3294.5,5313,3290.5,5309" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3290.5" y="5290.9341">AUTHENTICATION-43</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="180" x="3442.5" y="5290.9341">consentResponseRecieved()</text><rect fill="#FBFB77" filter="url(#f1okzv4wtxb6c6)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="219" x="3288" y="5322"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="211" x="3292" y="5338.0669">state: consentResponseRecieved</text><polygon fill="#A80036" points="3777.5,5367.2656,3787.5,5371.2656,3777.5,5375.2656,3781.5,5371.2656" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3283.5" x2="3783.5" y1="5371.2656" y2="5371.2656"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3290.5" y="5366.1997">AUTHENTICATION-44</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="202" x="3442.5" y="5366.1997">Auth Service response recieved</text><polygon fill="#A80036" points="2068.5,5396.3984,2058.5,5400.3984,2068.5,5404.3984,2064.5,5400.3984" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2062.5" x2="3277.5" y1="5400.3984" y2="5400.3984"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2074.5" y="5395.3325">AUTHENTICATION-45</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="2226.5" y="5395.3325">200 OK</text><polygon fill="#A80036" points="2829.5,5425.5313,2839.5,5429.5313,2829.5,5433.5313,2833.5,5429.5313" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2410.5" x2="2835.5" y1="5429.5313" y2="5429.5313"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2417.5" y="5424.4653">AUTHENTICATION-46</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="260" x="2569.5" y="5424.4653">POST /participants/CONSENTS/1a2b3c4d</text><polygon fill="#A80036" points="2416.5,5454.6641,2406.5,5458.6641,2416.5,5462.6641,2412.5,5458.6641" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2410.5" x2="2840.5" y1="5458.6641" y2="5458.6641"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2422.5" y="5453.5981">AUTHENTICATION-47</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2574.5" y="5453.5981">202 Accepted</text><polygon fill="#A80036" points="3261.5,5483.7969,3271.5,5487.7969,3261.5,5491.7969,3265.5,5487.7969" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2851.5" x2="3267.5" y1="5487.7969" y2="5487.7969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2858.5" y="5482.731">AUTHENTICATION-48</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="251" x="3010.5" y="5482.731">PUT /participants/CONSENTS/1a2b3c4d</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3283.5" x2="3325.5" y1="5516.9297" y2="5516.9297"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3325.5" x2="3325.5" y1="5516.9297" y2="5529.9297"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3284.5" x2="3325.5" y1="5529.9297" y2="5529.9297"/><polygon fill="#A80036" points="3294.5,5525.9297,3284.5,5529.9297,3294.5,5533.9297,3290.5,5529.9297" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3290.5" y="5511.8638">AUTHENTICATION-49</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="340" x="3442.5" y="5511.8638">const model = await loadFromKVS({key: 1a2b3c4d})</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3283.5" x2="3325.5" y1="5559.0625" y2="5559.0625"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3325.5" x2="3325.5" y1="5559.0625" y2="5572.0625"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3284.5" x2="3325.5" y1="5572.0625" y2="5572.0625"/><polygon fill="#A80036" points="3294.5,5568.0625,3284.5,5572.0625,3294.5,5576.0625,3290.5,5572.0625" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3290.5" y="5553.9966">AUTHENTICATION-50</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="197" x="3442.5" y="5553.9966">participantResponseRecieved()</text><rect fill="#FBFB77" filter="url(#f1okzv4wtxb6c6)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="243" x="3288" y="5585.0625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="235" x="3292" y="5601.1294">state: participantsResponseRecieved</text><polygon fill="#A80036" points="3777.5,5630.3281,3787.5,5634.3281,3777.5,5638.3281,3781.5,5634.3281" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3283.5" x2="3783.5" y1="5634.3281" y2="5634.3281"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3290.5" y="5629.2622">AUTHENTICATION-51</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="189" x="3442.5" y="5629.2622">Participant response recieved</text><polygon fill="#A80036" points="2857.5,5659.4609,2847.5,5663.4609,2857.5,5667.4609,2853.5,5663.4609" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2851.5" x2="3277.5" y1="5663.4609" y2="5663.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2863.5" y="5658.395">AUTHENTICATION-52</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="3015.5" y="5658.395">200 Accepted</text><rect fill="#FBFB77" filter="url(#f1okzv4wtxb6c6)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="253" x="3804" y="5676.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="245" x="3808" y="5692.5278">state: consentRegisteredAndValidated</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3841.5" y1="5725.7266" y2="5725.7266"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3841.5" x2="3841.5" y1="5725.7266" y2="5738.7266"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3800.5" x2="3841.5" y1="5738.7266" y2="5738.7266"/><polygon fill="#A80036" points="3810.5,5734.7266,3800.5,5738.7266,3810.5,5742.7266,3806.5,5738.7266" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3806.5" y="5720.6606">AUTHENTICATION-53</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="151" x="3958.5" y="5720.6606">model.finalizeConsent()</text><path d="M2016,5753.7266 L2093,5753.7266 L2093,5760.7266 L2083,5770.7266 L2016,5770.7266 L2016,5753.7266 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="279.3281" style="stroke:#000000;stroke-width:2.0;" width="1861" x="2016" y="5753.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="32" x="2031" y="5766.7935">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="116" x="2108" y="5765.937">[for each scope in</text><text fill="#000000" font-family="monospace" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="105" x="2228" y="5765.937">Consents.scopes</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="5" x="2333" y="5765.937">]</text><polygon fill="#A80036" points="2068.5,5787.9922,2058.5,5791.9922,2068.5,5795.9922,2064.5,5791.9922" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2062.5" x2="3788.5" y1="5791.9922" y2="5791.9922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2074.5" y="5786.9263">AUTHENTICATION-54</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="376" x="2226.5" y="5786.9263">POST /participants/THIRD_PARTY_LINK/dfsp.username.5678</text><polygon fill="#A80036" points="3777.5,5817.125,3787.5,5821.125,3777.5,5825.125,3781.5,5821.125" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2057.5" x2="3783.5" y1="5821.125" y2="5821.125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2064.5" y="5816.0591">AUTHENTICATION-55</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2216.5" y="5816.0591">202 Accepted</text><polygon fill="#A80036" points="2834.5,5846.2578,2844.5,5850.2578,2834.5,5854.2578,2838.5,5850.2578" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2057.5" x2="2840.5" y1="5850.2578" y2="5850.2578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2064.5" y="5845.1919">AUTHENTICATION-56</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="376" x="2216.5" y="5845.1919">POST /participants/THIRD_PARTY_LINK/dfsp.username.5678</text><polygon fill="#A80036" points="2068.5,5875.3906,2058.5,5879.3906,2068.5,5883.3906,2064.5,5879.3906" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2062.5" x2="2845.5" y1="5879.3906" y2="5879.3906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2074.5" y="5874.3247">AUTHENTICATION-57</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2226.5" y="5874.3247">202 Accepted</text><polygon fill="#A80036" points="2068.5,5904.5234,2058.5,5908.5234,2068.5,5912.5234,2064.5,5908.5234" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2062.5" x2="2845.5" y1="5908.5234" y2="5908.5234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2074.5" y="5903.4575">AUTHENTICATION-58</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="367" x="2226.5" y="5903.4575">PUT /participants/THIRD_PARTY_LINK/dfsp.username.5678</text><polygon fill="#A80036" points="2834.5,5933.6563,2844.5,5937.6563,2834.5,5941.6563,2838.5,5937.6563" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2057.5" x2="2840.5" y1="5937.6563" y2="5937.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2064.5" y="5932.5903">AUTHENTICATION-59</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="2216.5" y="5932.5903">200 OK</text><polygon fill="#A80036" points="3266.5,5962.7891,3276.5,5966.7891,3266.5,5970.7891,3270.5,5966.7891" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2057.5" x2="3272.5" y1="5966.7891" y2="5966.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2064.5" y="5961.7231">AUTHENTICATION-60</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="367" x="2216.5" y="5961.7231">PUT /participants/THIRD_PARTY_LINK/dfsp.username.5678</text><polygon fill="#A80036" points="2068.5,5991.9219,2058.5,5995.9219,2068.5,5999.9219,2064.5,5995.9219" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2062.5" x2="3277.5" y1="5995.9219" y2="5995.9219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2074.5" y="5990.856">AUTHENTICATION-61</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="2226.5" y="5990.856">200 OK</text><polygon fill="#A80036" points="3777.5,6021.0547,3787.5,6025.0547,3777.5,6029.0547,3781.5,6025.0547" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3278.5" x2="3783.5" y1="6025.0547" y2="6025.0547"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3285.5" y="6019.9888">AUTHENTICATION-62</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="189" x="3437.5" y="6019.9888">Participant response recieved</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3841.5" y1="6061.1875" y2="6061.1875"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3841.5" x2="3841.5" y1="6061.1875" y2="6074.1875"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3800.5" x2="3841.5" y1="6074.1875" y2="6074.1875"/><polygon fill="#A80036" points="3810.5,6070.1875,3800.5,6074.1875,3810.5,6078.1875,3806.5,6074.1875" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3806.5" y="6056.1216">AUTHENTICATION-63</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="3958.5" y="6056.1216">await Promise.all()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3841.5" y1="6103.3203" y2="6103.3203"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3841.5" x2="3841.5" y1="6103.3203" y2="6116.3203"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3800.5" x2="3841.5" y1="6116.3203" y2="6116.3203"/><polygon fill="#A80036" points="3810.5,6112.3203,3800.5,6116.3203,3810.5,6120.3203,3806.5,6116.3203" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3806.5" y="6098.2544">AUTHENTICATION-64</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="201" x="3958.5" y="6098.2544">state: PISPDFSPLinkEstablished</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3841.5" y1="6145.4531" y2="6145.4531"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3841.5" x2="3841.5" y1="6145.4531" y2="6158.4531"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3800.5" x2="3841.5" y1="6158.4531" y2="6158.4531"/><polygon fill="#A80036" points="3810.5,6154.4531,3800.5,6158.4531,3810.5,6162.4531,3806.5,6158.4531" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3806.5" y="6140.3872">AUTHENTICATION-65</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="203" x="3958.5" y="6140.3872">model.notifyVerificationToPISP()</text><polygon fill="#A80036" points="2073.5,6183.5859,2063.5,6187.5859,2073.5,6191.5859,2069.5,6187.5859" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2067.5" x2="3788.5" y1="6187.5859" y2="6187.5859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2079.5" y="6182.52">AUTHENTICATION-66</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="176" x="2231.5" y="6182.52">PATCH /consents/1a2b3c4d</text><rect fill="#ADD8E6" filter="url(#f1okzv4wtxb6c6)" height="129" style="stroke:#A80036;stroke-width:1.0;" width="184" x="3600" y="6200.5859"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="176" x="3604" y="6216.6528">PATCH /consents/1a2b3c4d</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="130" x="3604" y="6231.7856">FSIOP-Source: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="157" x="3604" y="6246.9185">FSIOP-Destination: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3604" y="6262.0513">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="3612" y="6277.1841">credential: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="3620" y="6292.3169">status: "VERIFIED"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3612" y="6307.4497">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3604" y="6322.5825">}</text><polygon fill="#A80036" points="3782.5,6351.7813,3792.5,6355.7813,3782.5,6359.7813,3786.5,6355.7813" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2062.5" x2="3788.5" y1="6355.7813" y2="6355.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2069.5" y="6350.7153">AUTHENTICATION-67</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="2221.5" y="6350.7153">200 OK</text><polygon fill="#A80036" points="1557.5,6380.9141,1547.5,6384.9141,1557.5,6388.9141,1553.5,6384.9141" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1551.5" x2="2051.5" y1="6384.9141" y2="6384.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1563.5" y="6379.8481">AUTHENTICATION-68</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="176" x="1715.5" y="6379.8481">PATCH /consents/1a2b3c4d</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1546.5" x2="1593.5" y1="6409.0469" y2="6409.0469"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1593.5" x2="1593.5" y1="6409.0469" y2="6422.0469"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1552.5" x2="1593.5" y1="6422.0469" y2="6422.0469"/><polygon fill="#A80036" points="1562.5,6418.0469,1552.5,6422.0469,1562.5,6426.0469,1558.5,6422.0469" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1558.5" y="6403.981">AUTHENTICATION-69</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="340" x="1710.5" y="6403.981">const model = await loadFromKVS({key: 1a2b3c4d})</text><polygon fill="#A80036" points="1047.5,6452.1797,1037.5,6456.1797,1047.5,6460.1797,1043.5,6456.1797" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1041.5" x2="1535.5" y1="6456.1797" y2="6456.1797"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1053.5" y="6451.1138">AUTHENTICATION-70</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="172" x="1205.5" y="6451.1138">Verified Response recieved</text><polygon fill="#A80036" points="2045.5,6481.3125,2055.5,6485.3125,2045.5,6489.3125,2049.5,6485.3125" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1541.5" x2="2051.5" y1="6485.3125" y2="6485.3125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1548.5" y="6480.2466">AUTHENTICATION-71</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="1700.5" y="6480.2466">200 OK</text><rect fill="#FBFB77" filter="url(#f1okzv4wtxb6c6)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="148" x="1041" y="6498.3125"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="140" x="1045" y="6514.3794">state: accountsLinked</text><polygon fill="#A80036" points="571.5,6543.5781,561.5,6547.5781,571.5,6551.5781,567.5,6547.5781" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="565.5" x2="1030.5" y1="6547.5781" y2="6547.5781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="577.5" y="6542.5122">AUTHENTICATION-72</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="206" x="729.5" y="6542.5122">return Accounts linked response</text><polygon fill="#A80036" points="92.5,6572.7109,82.5,6576.7109,92.5,6580.7109,88.5,6576.7109" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="86.5" x2="549.5" y1="6576.7109" y2="6576.7109"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="98.5" y="6571.645">AUTHENTICATION-73</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154" x="250.5" y="6571.645">200 OK Accounts Linked</text><rect fill="#ADD8E6" filter="url(#f1okzv4wtxb6c6)" height="98" style="stroke:#A80036;stroke-width:1.0;" width="217" x="328" y="6589.7109"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="332" y="6605.7778">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="340" y="6620.9106">credential: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="348" y="6636.0435">status: "VERIFIED"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="340" y="6651.1763">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="201" x="340" y="6666.3091">currentState="accountsLinked"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="332" y="6681.4419">}</text><!--MD5=[148cdc91071dfea81cae536320062992]
@startuml

title PISP Linking OTP

participant "PISP Backend" as PISP
box "PISP tp-scheme-adapter"
  participant "outbound-server" as PISP_TP_OUT
  participant "PISPLinkingModel" as PISP_LM
  participant "inbound-server" as PISP_TP_IN
end box
box "Mojaloop"
    participant Switch
    participant "Auth Service" as AUTH
    participant "Account Lookup Service" as ALS
end box
box "DFSP tp-scheme-adapter"
  participant "inbound-server" as DFSP_TP_IN
  participant "DFSPLinkingModel" as DFSP_LM
end box
participant DFSPAuthorizeSimulator

== Request Consent - OTP ==
autonumber 1 "<b>REQUEST-CONSENT-#</b>"
rnote right of PISP
PISP presents accounts to user. User selects one or more accounts to link.
end note
PISP -> PISP_TP_OUT: POST /linking/request-consent
rnote right of PISP #LightBlue
POST /linking/request-consent
{
  "accounts": [
    { accountNickname: "XXXXXXnt", id: "dfspa.username.1234", currency: "ZAR" },
    { accountNickname: "SpeXXXXXXXXnt", id: "dfspa.username.5678", currency: "USD" }
  ],
  callbackURI: 'pisp-app://callback'
}
end note

activate PISP
activate PISP_TP_OUT

PISP_TP_OUT -> PISP_TP_OUT: const model = await create()
rnote right of PISP_TP_OUT: state: start
PISP_TP_OUT -> PISP_LM: model.requestConsent()

activate PISP_LM

PISP_LM -> PISP_LM: ThirdpartyRequests.postConsentRequests()
PISP_LM -> Switch: POST /consentRequests
rnote right of PISP_LM #LightBlue
POST /consentRequests
FSIOP-Source: pispa
FSIOP-Destination: dfspa
{
  // consentRequestId will be the uuid created
  // at the PRELINKING-2
  consentRequestId: 6789
  scopes: [{
    accountId: 'dfspa.username.1234',
    actions: ['accounts.getBalance', 'accounts.transfer'],
    accountId: 'dfspa.username.5678',
    actions: ['accounts.getBalance', 'accounts.transfer'],
  }],
  // model will add `authChannels`
  authChannels: ["OTP"],
  callbackURI: 'pisp-app://callback...'
}
end note

activate Switch
Switch - -> PISP_LM: 202 Accepted
deactivate PISP_LM
Switch -> DFSP_TP_IN: POST /consentRequests
activate DFSP_TP_IN

DFSP_TP_IN -> DFSP_TP_IN: const model = await create()
activate DFSP_LM
rnote right of DFSP_TP_IN: state: start
DFSP_TP_IN -> DFSP_LM: model.requestConsent()
DFSP_TP_IN - -> Switch: 202 Accepted
deactivate Switch
deactivate DFSP_TP_IN
DFSP_LM -> DFSP_LM: DFSPBackendRequests.validateConsentRequest()
activate DFSPAuthorizeSimulator
DFSP_LM -> DFSPAuthorizeSimulator: ""POST /store/consentRequests/6789""
DFSPAuthorizeSimulator -> DFSPAuthorizeSimulator: store consentRequest details
DFSPAuthorizeSimulator -> DFSP_LM: 201 Created
rnote right of DFSP_LM: state: consentRequestValidatedAndStored
deactivate DFSPAuthorizeSimulator
deactivate DFSP_TP_IN


activate Switch
DFSP_LM -> Switch: PUT /consentRequests/6789

rnote left of DFSP_LM #LightBlue
PUT /consentRequests/6789
FSIOP-Source: pispa
FSIOP-Destination: dfspa
{
  consentRequestId: 6789
  scopes: [{
    accountId: 'dfspa.username.1234',
    actions: ['accounts.getBalance', 'accounts.transfer'],
    accountId: 'dfspa.username.5678',
    actions: ['accounts.getBalance', 'accounts.transfer'],
  }],
  authChannels: ["OTP"],
  callbackURI: 'pisp-app://callback...',
  authURI: 'dfspa.com/authorize?consentRequestId=6789' // this is new
}
end note
Switch - -> DFSP_LM: 202 ACCEPTED
deactivate DFSP_LM
activate PISP_TP_IN
Switch ->  PISP_TP_IN: PUT /consentRequests/6789
PISP_TP_IN - -> Switch: 200 OK
deactivate Switch
activate PISP_LM
PISP_TP_IN - -> PISP_LM: Consent Request response recieved
rnote right of PISP_LM: state: OTPAuthenticationChannelResponseRecieved
PISP_LM - -> PISP_LM: this.saveToKVS()
deactivate PISP_TP_IN
PISP_LM -> PISP_TP_OUT: return Authentication Response
deactivate PISP_LM
PISP_TP_OUT - -> PISP: 200 OK Autentication Response
rnote left of PISP_TP_OUT #LightBlue
{
  channelResponse: {
    consentRequestId: 6789
    scopes: [{
      accountId: 'dfspa.username.1234',
      actions: ['accounts.getBalance', 'accounts.transfer'],
      accountId: 'dfspa.username.5678',
      actions: ['accounts.getBalance', 'accounts.transfer'],
    }],
    authChannels: ["OTP"],
    callbackURI: 'pisp-app://callback...',
    authURI: 'dfspa.com/authorize?consentRequestId=6789' // this is new
  },
  currentState="OTPAuthenticationChannelResponseRecieved"
}
end note

deactivate PISP_TP_OUT
deactivate PISP

note over PISP, DFSPAuthorizeSimulator
  The DFSP is expected to send an OTP to the end user which will be used in the next linking step.
end note

== Authentication+Grant Consent+Register Credential ==
autonumber 1 "<b>AUTHENTICATION-#</b>"
rnote right of PISP
PISP has obtained authToken from end-user(OTP) or through a callback(Web).
end note
PISP -> PISP_TP_OUT: POST /linking/request-consent/6789/authenticate
rnote right of PISP #LightBlue
POST /linking/request-consent/6789/authenticate
{
  authToken: '123456'
}
end note

activate PISP
activate PISP_TP_OUT

PISP_TP_OUT -> PISP_TP_OUT: const model = await loadFromKVS({key: 6789})
rnote right of PISP_TP_OUT: state: webAuthenticationChannelResponseRecieved or OTPAuthenticationChannelResponseRecieved
PISP_TP_OUT -> PISP_LM: model.authenticate()

activate PISP_LM

PISP_LM -> PISP_LM: ThirdpartyRequests.patchConsentRequests()
PISP_LM -> Switch: PATCH /consentRequests/6789
rnote right of PISP_LM #LightBlue
PATCH /consentRequests/6789
FSIOP-Source: pispa
FSIOP-Destination: dfspa
{
  authToken: '124356'
}
end note

activate Switch
Switch - -> PISP_LM: 202 Accepted
deactivate PISP_LM
Switch -> DFSP_TP_IN: PATCH /consentRequests/6789
activate DFSP_TP_IN

DFSP_TP_IN -> DFSP_TP_IN: const model = await loadFromKVS({key: 6789})
activate DFSP_LM
rnote right of DFSP_TP_IN: state: consentRequestValidatedAndStored
DFSP_TP_IN -> DFSP_LM: model.validateAuthToken()
DFSP_TP_IN - -> Switch: 202 Accepted
deactivate Switch
deactivate DFSP_TP_IN

DFSP_LM -> DFSP_LM: DFSPBackendRequests.validateAuthToken()
rnote right of DFSP_LM #LightBlue
Do we need two backend endpoints for validating
web authTokens and OTP authTokens? Or is a DFSP expected to
validate both cases with one endpoint?

POST /validateAuthToken
{
  consentRequestId: '6789'
  authChannel: model.data.authChannel,
  authToken: '124356'
}
end note
rnote right of DFSP_LM: state: authTokenValidated

DFSP_LM -> DFSP_LM: const consentId = uuid()
DFSP_LM -> DFSP_LM: model.grantConsent()
DFSP_LM -> DFSP_LM: ThirdpartyRequests.postConsents()
rnote right of DFSP_LM: state: consentGranted
rnote right of DFSP_LM #LightBlue
It's important to save the model with the consentId from this point onwards!
Requests will not contain a consentRequestId in the upcoming requests.
This may require changing `PersistentModel` to have a secondary key it can
store the model with.
end note
DFSP_LM -> DFSP_LM: this.saveToKVS({key: '1a2b3c4d'})

activate Switch
DFSP_LM -> Switch: POST /consents

rnote left of DFSP_LM #LightBlue
POST /consents
FSIOP-Source: dfspa
FSIOP-Destination: pispa
{
  consentId: 1a2b3c4d
  consentRequestId: 6789
  scopes: model.data.scopes
}
end note
Switch - -> DFSP_LM: 202 ACCEPTED
deactivate DFSP_LM
activate PISP_TP_IN
Switch ->  PISP_TP_IN: POST /consents
PISP_TP_IN -> PISP_TP_IN: const model = await loadFromKVS({key: 6789})
activate PISP_LM
PISP_TP_IN -> PISP_LM: model.registerCredential()
PISP_TP_IN - -> Switch: 202 Accepted
deactivate PISP_TP_IN
deactivate Switch
rnote right of PISP_LM: state: consentRecieved
rnote right of PISP_LM #LightBlue
It's important to save the model with the consentId from this point onwards!
Requests will not contain a consentRequestId in the upcoming requests.
This may require changing `PersistentModel` to have a secondary key it can
store the model with.
end note
PISP_LM - -> PISP_LM: const challenge = deriveChallenge(consentRequest)
PISP_LM - -> PISP_LM: this.saveToKVS({key: '1a2b3c4d'})

PISP_LM -> PISP_LM: ThirdpartyRequests.putConsents()
rnote right of PISP_LM: state: signedConsentSent
activate Switch
PISP_LM -> Switch: PUT /consents/1a2b3c4d

rnote right of PISP_LM #LightBlue
PUT /consents/1a2b3c4d
FSIOP-Source: pispa
FSIOP-Destination: dfspa
{
  scopes: [{
    accountId: 'dfspa.username.1234',
    actions: ['accounts.getBalance', 'accounts.transfer'],
    accountId: 'dfspa.username.5678',
    actions: ['accounts.getBalance', 'accounts.transfer'],
  }],
  credential: {
    credentialType: "FIDO",
    status: "PENDING",
    payload: PublicKeyCredential
  }
}
end note

Switch - -> PISP_LM: 202 Accepted
deactivate PISP_LM
Switch -> DFSP_TP_IN: PUT /consents/1a2b3c4d
activate DFSP_TP_IN

DFSP_TP_IN -> DFSP_TP_IN: const model = await loadFromKVS({key: 1a2b3c4d})
activate DFSP_LM
rnote right of DFSP_TP_IN: state: signedConsentRecieved
DFSP_TP_IN -> DFSP_LM: model.validateSignedConsent()
rnote right of DFSP_TP_IN: state: pendingRegistrationAndValidation
DFSP_TP_IN - -> Switch: 202 Accepted
deactivate Switch
deactivate DFSP_TP_IN
DFSP_LM -> DFSP_LM: Check signed consent.
rnote right of DFSP_LM #LightBlue
Does this need a backend request or can the scheme adapter check the consent.
end note
rnote right of DFSP_LM: state: signedConsentChecked
DFSP_LM-> DFSP_LM: model.validateWithAuthService()
activate Switch
DFSP_LM -> Switch: POST /consents/1a2b3c4d

rnote left of DFSP_LM #LightBlue
POST /consents/1a2b3c4d
FSIOP-Source: dfspa
FSIOP-Destination: central-auth
{
  scopes: [{
    accountId: 'dfspa.username.1234',
    actions: ['accounts.getBalance', 'accounts.transfer'],
    accountId: 'dfspa.username.5678',
    actions: ['accounts.getBalance', 'accounts.transfer'],
  }],
  credential: {
    credentialType: "FIDO",
    status: "PENDING",
    payload: PublicKeyCredential
  }
}
end note
Switch - -> DFSP_LM: 202 Accepted
DFSP_LM -> DFSP_LM: this.saveToKVS()
deactivate DFSP_LM

Switch -> AUTH: POST /consents/1a2b3c4d
activate AUTH
AUTH - -> Switch: 202 Accepted
AUTH -> AUTH: Check consent.
AUTH -> Switch: PUT /consents/1a2b3c4d

rnote left of AUTH #LightBlue
PUT /consents/1a2b3c4d
FSIOP-Source: central-auth
FSIOP-Destination: dfspa
{
  scopes: [{
    accountId: 'dfspa.username.1234',
    actions: ['accounts.getBalance', 'accounts.transfer'],
    accountId: 'dfspa.username.5678',
    actions: ['accounts.getBalance', 'accounts.transfer'],
  }],
  credential: {
    credentialType: "FIDO",
    status: "VERIFIED",
    payload: PublicKeyCredential
  }
}
end note

Switch - -> AUTH: 200 OK
activate DFSP_TP_IN
Switch -> DFSP_TP_IN: PUT /consents/1a2b3c4d
DFSP_TP_IN -> DFSP_TP_IN: const model = await loadFromKVS({key: 1a2b3c4d})
DFSP_TP_IN -> DFSP_TP_IN: consentResponseRecieved()
rnote right of DFSP_TP_IN: state: consentResponseRecieved
DFSP_TP_IN -> DFSP_LM: Auth Service response recieved
activate DFSP_LM
DFSP_TP_IN - -> Switch: 200 OK
deactivate Switch
deactivate DFSP_TP_IN

AUTH -> ALS: POST /participants/CONSENTS/1a2b3c4d
activate ALS
ALS - -> AUTH: 202 Accepted
deactivate AUTH

ALS -> DFSP_TP_IN: PUT /participants/CONSENTS/1a2b3c4d
activate DFSP_TP_IN
DFSP_TP_IN -> DFSP_TP_IN: const model = await loadFromKVS({key: 1a2b3c4d})
DFSP_TP_IN -> DFSP_TP_IN: participantResponseRecieved()
rnote right of DFSP_TP_IN: state: participantsResponseRecieved
DFSP_TP_IN -> DFSP_LM: Participant response recieved
DFSP_TP_IN - -> ALS: 200 Accepted
deactivate ALS
deactivate DFSP_TP_IN
rnote right of DFSP_LM: state: consentRegisteredAndValidated
DFSP_LM -> DFSP_LM: model.finalizeConsent()

loop for each scope in ""Consents.scopes""
DFSP_LM -> Switch: POST /participants/THIRD_PARTY_LINK/dfsp.username.5678
Switch - -> DFSP_LM: 202 Accepted
Switch -> ALS: POST /participants/THIRD_PARTY_LINK/dfsp.username.5678
ALS - -> Switch: 202 Accepted
ALS -> Switch: PUT /participants/THIRD_PARTY_LINK/dfsp.username.5678
Switch - -> ALS: 200 OK
Switch -> DFSP_TP_IN: PUT /participants/THIRD_PARTY_LINK/dfsp.username.5678
DFSP_TP_IN - -> Switch: 200 OK
DFSP_TP_IN -> DFSP_LM: Participant response recieved
end

DFSP_LM -> DFSP_LM: await Promise.all()
DFSP_LM -> DFSP_LM: state: PISPDFSPLinkEstablished
DFSP_LM -> DFSP_LM: model.notifyVerificationToPISP()
DFSP_LM -> Switch: PATCH /consents/1a2b3c4d
rnote left of DFSP_LM #LightBlue
PATCH /consents/1a2b3c4d
FSIOP-Source: dfspa
FSIOP-Destination: pispa
{
  credential: {
    status: "VERIFIED"
  }
}
end note
activate Switch
Switch - -> DFSP_LM: 200 OK
deactivate DFSP_LM
Switch -> PISP_TP_IN: PATCH /consents/1a2b3c4d
activate PISP_TP_IN
PISP_TP_IN -> PISP_TP_IN: const model = await loadFromKVS({key: 1a2b3c4d})

activate PISP_LM
PISP_TP_IN -> PISP_LM: Verified Response recieved
PISP_TP_IN - -> Switch: 200 OK
deactivate PISP_TP_IN
deactivate Switch
rnote right of PISP_LM: state: accountsLinked
PISP_LM - -> PISP_TP_OUT: return Accounts linked response
deactivate PISP_LM
PISP_TP_OUT - -> PISP: 200 OK Accounts Linked
rnote left of PISP_TP_OUT #LightBlue
{
  credential: {
    status: "VERIFIED"
  }
  currentState="accountsLinked"
}
end note
@enduml

PlantUML version 1.2021.00(Sun Jan 10 05:25:05 EST 2021)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>