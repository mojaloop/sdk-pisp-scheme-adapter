<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="6958px" preserveAspectRatio="none" style="width:4807px;height:6958px;" version="1.1" viewBox="0 0 4807 6958" width="4807px" zoomAndPan="magnify"><defs><filter height="300%" id="f15l9oqlsclkm9" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="151" x="2324.75" y="28.708">PISP Linking OTP</text><rect fill="#DDDDDD" height="6911.7813" style="stroke:#A80036;stroke-width:1.0;" width="1122.5" x="484.5" y="40.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="180" x="955.75" y="53.02">PISP tp-scheme-adapter</text><rect fill="#DDDDDD" height="6911.7813" style="stroke:#A80036;stroke-width:1.0;" width="920.5" x="2022" y="40.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="67" x="2448.75" y="53.02">Mojaloop</text><rect fill="#DDDDDD" height="6911.7813" style="stroke:#A80036;stroke-width:1.0;" width="658" x="3213" y="40.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="186" x="3449" y="53.02">DFSP tp-scheme-adapter</text><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="1662.5625" style="stroke:#A80036;stroke-width:1.0;" width="10" x="71.5" y="202.7813"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="4650.5703" style="stroke:#A80036;stroke-width:1.0;" width="10" x="71.5" y="2254.8672"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="1662.5625" style="stroke:#A80036;stroke-width:1.0;" width="10" x="550.5" y="202.7813"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="4650.5703" style="stroke:#A80036;stroke-width:1.0;" width="10" x="550.5" y="2254.8672"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="402.6563" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1026.5" y="461.375"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="133.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1026.5" y="1702.6797"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="209.1953" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1026.5" y="2437.7969"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="652.8516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1026.5" y="3628.0391"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="125.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1026.5" y="6632.9766"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="155.6641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1536.5" y="1644.4141"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="129.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1536.5" y="3561.7734"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="100.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1536.5" y="6595.8438"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="481.9219" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="574.7734"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="394.6563" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="1308.0234"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="330.5938" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="2509.0625"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="331.8594" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="3359.4453"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="552.3203" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="3924.3672"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="989.1094" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="4622.2188"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="297.7266" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="6398.5156"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="652.7188" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2400.5" y="5016.875"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="233.9297" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2841.5" y="5640.4609"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="163.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3273.5" y="893.1641"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="163.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3273.5" y="2676.125"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="166.6641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3273.5" y="4310.0234"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="204.7969" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3273.5" y="5406.5313"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="175.6641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3273.5" y="5698.7266"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="617.7188" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3789.5" y="1026.6953"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="752.1172" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3789.5" y="2809.6563"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="633.5859" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3789.5" y="4347.1563"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="984.5156" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3789.5" y="5582.1953"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="214.1953" style="stroke:#A80036;stroke-width:1.0;" width="10" x="4297.5" y="1093.8281"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="279.3281" style="stroke:#000000;stroke-width:2.0;" width="1861" x="2016" y="5964.6563"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="76" x2="76" y1="95.3828" y2="6914.4375"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="555.5" x2="555.5" y1="95.3828" y2="6914.4375"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1031.5" x2="1031.5" y1="95.3828" y2="6914.4375"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1541" x2="1541" y1="95.3828" y2="6914.4375"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="2057" x2="2057" y1="95.3828" y2="6914.4375"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="2405.5" x2="2405.5" y1="95.3828" y2="6914.4375"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="2846.5" x2="2846.5" y1="95.3828" y2="6914.4375"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="3278" x2="3278" y1="95.3828" y2="6914.4375"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="3794" x2="3794" y1="95.3828" y2="6914.4375"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="4302" x2="4302" y1="95.3828" y2="6914.4375"/><rect fill="#FEFECE" filter="url(#f15l9oqlsclkm9)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="109" x="20" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="95" x="27" y="80.0811">PISP Backend</text><rect fill="#FEFECE" filter="url(#f15l9oqlsclkm9)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="109" x="20" y="6913.4375"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="95" x="27" y="6933.4326">PISP Backend</text><rect fill="#FEFECE" filter="url(#f15l9oqlsclkm9)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="130" x="488.5" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="116" x="495.5" y="80.0811">outbound-server</text><rect fill="#FEFECE" filter="url(#f15l9oqlsclkm9)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="130" x="488.5" y="6913.4375"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="116" x="495.5" y="6933.4326">outbound-server</text><rect fill="#FEFECE" filter="url(#f15l9oqlsclkm9)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="134" x="962.5" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="120" x="969.5" y="80.0811">PISPLinkingModel</text><rect fill="#FEFECE" filter="url(#f15l9oqlsclkm9)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="134" x="962.5" y="6913.4375"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="120" x="969.5" y="6933.4326">PISPLinkingModel</text><rect fill="#FEFECE" filter="url(#f15l9oqlsclkm9)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="119" x="1480" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="105" x="1487" y="80.0811">inbound-server</text><rect fill="#FEFECE" filter="url(#f15l9oqlsclkm9)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="119" x="1480" y="6913.4375"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="105" x="1487" y="6933.4326">inbound-server</text><rect fill="#FEFECE" filter="url(#f15l9oqlsclkm9)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="59" x="2026" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="45" x="2033" y="80.0811">Switch</text><rect fill="#FEFECE" filter="url(#f15l9oqlsclkm9)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="59" x="2026" y="6913.4375"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="45" x="2033" y="6933.4326">Switch</text><rect fill="#FEFECE" filter="url(#f15l9oqlsclkm9)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="100" x="2353.5" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="86" x="2360.5" y="80.0811">Auth Service</text><rect fill="#FEFECE" filter="url(#f15l9oqlsclkm9)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="100" x="2353.5" y="6913.4375"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="86" x="2360.5" y="6933.4326">Auth Service</text><rect fill="#FEFECE" filter="url(#f15l9oqlsclkm9)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="180" x="2754.5" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="166" x="2761.5" y="80.0811">Account Lookup Service</text><rect fill="#FEFECE" filter="url(#f15l9oqlsclkm9)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="180" x="2754.5" y="6913.4375"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="166" x="2761.5" y="6933.4326">Account Lookup Service</text><rect fill="#FEFECE" filter="url(#f15l9oqlsclkm9)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="119" x="3217" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="105" x="3224" y="80.0811">inbound-server</text><rect fill="#FEFECE" filter="url(#f15l9oqlsclkm9)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="119" x="3217" y="6913.4375"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="105" x="3224" y="6933.4326">inbound-server</text><rect fill="#FEFECE" filter="url(#f15l9oqlsclkm9)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="141" x="3722" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="127" x="3729" y="80.0811">DFSPLinkingModel</text><rect fill="#FEFECE" filter="url(#f15l9oqlsclkm9)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="141" x="3722" y="6913.4375"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="127" x="3729" y="6933.4326">DFSPLinkingModel</text><rect fill="#FEFECE" filter="url(#f15l9oqlsclkm9)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="181" x="4210" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="167" x="4217" y="80.0811">DFSPAuthorizeSimulator</text><rect fill="#FEFECE" filter="url(#f15l9oqlsclkm9)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="181" x="4210" y="6913.4375"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="167" x="4217" y="6933.4326">DFSPAuthorizeSimulator</text><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="1662.5625" style="stroke:#A80036;stroke-width:1.0;" width="10" x="71.5" y="202.7813"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="4650.5703" style="stroke:#A80036;stroke-width:1.0;" width="10" x="71.5" y="2254.8672"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="1662.5625" style="stroke:#A80036;stroke-width:1.0;" width="10" x="550.5" y="202.7813"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="4650.5703" style="stroke:#A80036;stroke-width:1.0;" width="10" x="550.5" y="2254.8672"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="402.6563" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1026.5" y="461.375"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="133.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1026.5" y="1702.6797"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="209.1953" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1026.5" y="2437.7969"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="652.8516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1026.5" y="3628.0391"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="125.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1026.5" y="6632.9766"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="155.6641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1536.5" y="1644.4141"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="129.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1536.5" y="3561.7734"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="100.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1536.5" y="6595.8438"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="481.9219" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="574.7734"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="394.6563" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="1308.0234"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="330.5938" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="2509.0625"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="331.8594" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="3359.4453"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="552.3203" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="3924.3672"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="989.1094" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="4622.2188"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="297.7266" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2052.5" y="6398.5156"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="652.7188" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2400.5" y="5016.875"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="233.9297" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2841.5" y="5640.4609"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="163.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3273.5" y="893.1641"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="163.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3273.5" y="2676.125"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="166.6641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3273.5" y="4310.0234"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="204.7969" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3273.5" y="5406.5313"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="175.6641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3273.5" y="5698.7266"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="617.7188" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3789.5" y="1026.6953"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="752.1172" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3789.5" y="2809.6563"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="633.5859" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3789.5" y="4347.1563"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="984.5156" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3789.5" y="5582.1953"/><rect fill="#FFFFFF" filter="url(#f15l9oqlsclkm9)" height="214.1953" style="stroke:#A80036;stroke-width:1.0;" width="10" x="4297.5" y="1093.8281"/><rect fill="#EEEEEE" filter="url(#f15l9oqlsclkm9)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="4800.5" x="0" y="125.9492"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="4800.5" y1="125.9492" y2="125.9492"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="4800.5" y1="128.9492" y2="128.9492"/><rect fill="#EEEEEE" filter="url(#f15l9oqlsclkm9)" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="189" x="2305.75" y="115.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="170" x="2311.75" y="131.4497">Request Consent - OTP</text><rect fill="#FBFB77" filter="url(#f15l9oqlsclkm9)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="485" x="81" y="153.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="477" x="85" y="169.5825">PISP presents accounts to user. User selects one or more accounts to link.</text><polygon fill="#A80036" points="538.5,198.7813,548.5,202.7813,538.5,206.7813,542.5,202.7813" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="81.5" x2="544.5" y1="202.7813" y2="202.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="88.5" y="197.7153">REQUEST-CONSENT-1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="246.5" y="197.7153">POST /linking/request-consent</text><rect fill="#ADD8E6" filter="url(#f15l9oqlsclkm9)" height="144" style="stroke:#A80036;stroke-width:1.0;" width="570" x="86" y="215.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="90" y="231.8481">POST /linking/request-consent</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="90" y="246.981">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="98" y="262.1138">accounts: [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="507" x="106" y="277.2466">{ accountNickname: "XXXXXXnt", id: "dfspa.username.1234", currency: "ZAR" },</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="546" x="106" y="292.3794">{ accountNickname: "SpeXXXXXXXXnt", id: "dfspa.username.5678", currency: "USD" }</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="9" x="98" y="307.5122">],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="541" x="98" y="322.645">userId: "username1234", // so the dfsp can associate this request with GET /accounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="204" x="98" y="337.7778">callbackURI: 'pisp-app://callback'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="90" y="352.9106">}</text><line style="stroke:#A80036;stroke-width:1.0;" x1="560.5" x2="602.5" y1="386.1094" y2="386.1094"/><line style="stroke:#A80036;stroke-width:1.0;" x1="602.5" x2="602.5" y1="386.1094" y2="399.1094"/><line style="stroke:#A80036;stroke-width:1.0;" x1="561.5" x2="602.5" y1="399.1094" y2="399.1094"/><polygon fill="#A80036" points="571.5,395.1094,561.5,399.1094,571.5,403.1094,567.5,399.1094" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="567.5" y="381.0435">REQUEST-CONSENT-2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="186" x="725.5" y="381.0435">const model = await create()</text><rect fill="#FBFB77" filter="url(#f15l9oqlsclkm9)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="79" x="565" y="412.1094"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="569" y="428.1763">state: start</text><polygon fill="#A80036" points="1014.5,457.375,1024.5,461.375,1014.5,465.375,1018.5,461.375" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="560.5" x2="1020.5" y1="461.375" y2="461.375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="567.5" y="456.3091">REQUEST-CONSENT-3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="156" x="725.5" y="456.3091">model.requestConsent()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1036.5" x2="1078.5" y1="490.5078" y2="490.5078"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1078.5" x2="1078.5" y1="490.5078" y2="503.5078"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1037.5" x2="1078.5" y1="503.5078" y2="503.5078"/><polygon fill="#A80036" points="1047.5,499.5078,1037.5,503.5078,1047.5,507.5078,1043.5,503.5078" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="1043.5" y="485.4419">REQUEST-CONSENT-4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="277" x="1201.5" y="485.4419">ThirdpartyRequests.postConsentRequests()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1036.5" x2="1078.5" y1="532.6406" y2="532.6406"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1078.5" x2="1078.5" y1="532.6406" y2="545.6406"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1037.5" x2="1078.5" y1="545.6406" y2="545.6406"/><polygon fill="#A80036" points="1047.5,541.6406,1037.5,545.6406,1047.5,549.6406,1043.5,545.6406" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="1043.5" y="527.5747">REQUEST-CONSENT-5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="209" x="1201.5" y="527.5747">const consentRequestId = uuid()</text><polygon fill="#A80036" points="2040.5,570.7734,2050.5,574.7734,2040.5,578.7734,2044.5,574.7734" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1036.5" x2="2046.5" y1="574.7734" y2="574.7734"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="1043.5" y="569.7075">REQUEST-CONSENT-6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="152" x="1201.5" y="569.7075">POST /consentRequests</text><rect fill="#ADD8E6" filter="url(#f15l9oqlsclkm9)" height="250" style="stroke:#A80036;stroke-width:1.0;" width="358" x="1041" y="587.7734"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="152" x="1045" y="603.8403">POST /consentRequests</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="1045" y="618.9731">FSIOP-Source: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="1045" y="634.106">FSIOP-Destination: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1045" y="649.2388">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154" x="1053" y="664.3716">consentRequestId: 6789</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154" x="1053" y="679.5044">userId: "username1234"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66" x="1053" y="694.6372">scopes: [{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="1061" y="709.77">accountId: 'dfspa.username.1234',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="1061" y="724.9028">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="1061" y="740.0356">accountId: 'dfspa.username.5678',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="1061" y="755.1685">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="17" x="1053" y="770.3013">}],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="208" x="1053" y="785.4341">// model will add `authChannels`</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="1053" y="800.5669">authChannels: ["WEB", "OTP"],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="216" x="1053" y="815.6997">callbackURI: 'pisp-app://callback...'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1045" y="830.8325">}</text><polygon fill="#A80036" points="1042.5,860.0313,1032.5,864.0313,1042.5,868.0313,1038.5,864.0313" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1036.5" x2="2051.5" y1="864.0313" y2="864.0313"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="1048.5" y="858.9653">REQUEST-CONSENT-7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="1206.5" y="858.9653">202 Accepted</text><polygon fill="#A80036" points="3261.5,889.1641,3271.5,893.1641,3261.5,897.1641,3265.5,893.1641" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2062.5" x2="3267.5" y1="893.1641" y2="893.1641"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="2069.5" y="888.0981">REQUEST-CONSENT-8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="152" x="2227.5" y="888.0981">POST /consentRequests</text><polygon fill="#A80036" points="2073.5,918.2969,2063.5,922.2969,2073.5,926.2969,2069.5,922.2969" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2067.5" x2="3272.5" y1="922.2969" y2="922.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="2079.5" y="917.231">REQUEST-CONSENT-9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2237.5" y="917.231">202 Accepted</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3283.5" x2="3325.5" y1="951.4297" y2="951.4297"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3325.5" x2="3325.5" y1="951.4297" y2="964.4297"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3284.5" x2="3325.5" y1="964.4297" y2="964.4297"/><polygon fill="#A80036" points="3294.5,960.4297,3284.5,964.4297,3294.5,968.4297,3290.5,964.4297" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="3290.5" y="946.3638">REQUEST-CONSENT-10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="186" x="3457.5" y="946.3638">const model = await create()</text><rect fill="#FBFB77" filter="url(#f15l9oqlsclkm9)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="79" x="3288" y="977.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="3292" y="993.4966">state: start</text><polygon fill="#A80036" points="3777.5,1022.6953,3787.5,1026.6953,3777.5,1030.6953,3781.5,1026.6953" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3283.5" x2="3783.5" y1="1026.6953" y2="1026.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="3290.5" y="1021.6294">REQUEST-CONSENT-11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="156" x="3457.5" y="1021.6294">model.requestConsent()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3846.5" y1="1080.8281" y2="1080.8281"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3846.5" x2="3846.5" y1="1080.8281" y2="1093.8281"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3805.5" x2="3846.5" y1="1093.8281" y2="1093.8281"/><polygon fill="#A80036" points="3815.5,1089.8281,3805.5,1093.8281,3815.5,1097.8281,3811.5,1093.8281" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="3811.5" y="1075.7622">REQUEST-CONSENT-12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="317" x="3978.5" y="1075.7622">DFSPBackendRequests.validateConsentRequest()</text><polygon fill="#A80036" points="4285.5,1123.9609,4295.5,1127.9609,4285.5,1131.9609,4289.5,1127.9609" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="4291.5" y1="1127.9609" y2="1127.9609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="3806.5" y="1122.895">REQUEST-CONSENT-13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="98" x="3973.5" y="1122.895">POST /sendOTP</text><rect fill="#ADD8E6" filter="url(#f15l9oqlsclkm9)" height="98" style="stroke:#A80036;stroke-width:1.0;" width="204" x="3804" y="1140.9609"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="98" x="3808" y="1157.0278">POST /sendOTP</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3808" y="1172.1606">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="3816" y="1187.2935">consentRequestId: 6789,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="188" x="3816" y="1202.4263">username: "username.1234",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="109" x="3816" y="1217.5591">message: "0987"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3808" y="1232.6919">}</text><line style="stroke:#A80036;stroke-width:1.0;" x1="4307.5" x2="4349.5" y1="1265.8906" y2="1265.8906"/><line style="stroke:#A80036;stroke-width:1.0;" x1="4349.5" x2="4349.5" y1="1265.8906" y2="1278.8906"/><line style="stroke:#A80036;stroke-width:1.0;" x1="4308.5" x2="4349.5" y1="1278.8906" y2="1278.8906"/><polygon fill="#A80036" points="4318.5,1274.8906,4308.5,1278.8906,4318.5,1282.8906,4314.5,1278.8906" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="4314.5" y="1260.8247">REQUEST-CONSENT-14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="307" x="4481.5" y="1260.8247">take action on TTK for defined rule for username</text><polygon fill="#A80036" points="3810.5,1304.0234,3800.5,1308.0234,3810.5,1312.0234,3806.5,1308.0234" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3804.5" x2="4301.5" y1="1308.0234" y2="1308.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="3816.5" y="1302.9575">REQUEST-CONSENT-15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="3983.5" y="1302.9575">200 OK</text><rect fill="#FBFB77" filter="url(#f15l9oqlsclkm9)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="280" x="3804" y="1321.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="272" x="3808" y="1337.0903">state: consentRequestValidatedAndStored</text><polygon fill="#A80036" points="2073.5,1366.2891,2063.5,1370.2891,2073.5,1374.2891,2069.5,1370.2891" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2067.5" x2="3788.5" y1="1370.2891" y2="1370.2891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="2079.5" y="1365.2231">REQUEST-CONSENT-16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="179" x="2246.5" y="1365.2231">PUT /consentRequests/6789</text><rect fill="#ADD8E6" filter="url(#f15l9oqlsclkm9)" height="234" style="stroke:#A80036;stroke-width:1.0;" width="380" x="3404" y="1383.2891"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="179" x="3408" y="1399.356">PUT /consentRequests/6789</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="3408" y="1414.4888">FSIOP-Source: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="3408" y="1429.6216">FSIOP-Destination: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3408" y="1444.7544">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154" x="3416" y="1459.8872">consentRequestId: 6789</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66" x="3416" y="1475.02">scopes: [{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="3424" y="1490.1528">accountId: 'dfspa.username.1234',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="3424" y="1505.2856">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="3424" y="1520.4185">accountId: 'dfspa.username.5678',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="3424" y="1535.5513">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="17" x="3416" y="1550.6841">}],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="364" x="3416" y="1565.8169">authChannels: ["OTP"], // updated with the channel in use</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="3416" y="1580.9497">callbackURI: 'pisp-app://callback...',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="197" x="3416" y="1596.0825">// note: no authURI for OTP flow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3408" y="1611.2153">}</text><polygon fill="#A80036" points="3782.5,1640.4141,3792.5,1644.4141,3782.5,1648.4141,3786.5,1644.4141" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2062.5" x2="3788.5" y1="1644.4141" y2="1644.4141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="2069.5" y="1639.3481">REQUEST-CONSENT-17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="96" x="2236.5" y="1639.3481">202 ACCEPTED</text><polygon fill="#A80036" points="1557.5,1669.5469,1547.5,1673.5469,1557.5,1677.5469,1553.5,1673.5469" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1551.5" x2="2051.5" y1="1673.5469" y2="1673.5469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1563.5" y="1668.481">REQUEST-CONSENT-18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="179" x="1730.5" y="1668.481">PUT /consentRequests/6789</text><polygon fill="#A80036" points="2045.5,1698.6797,2055.5,1702.6797,2045.5,1706.6797,2049.5,1702.6797" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1546.5" x2="2051.5" y1="1702.6797" y2="1702.6797"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1553.5" y="1697.6138">REQUEST-CONSENT-19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="1720.5" y="1697.6138">200 OK</text><polygon fill="#A80036" points="1047.5,1727.8125,1037.5,1731.8125,1047.5,1735.8125,1043.5,1731.8125" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1041.5" x2="1535.5" y1="1731.8125" y2="1731.8125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1053.5" y="1726.7466">REQUEST-CONSENT-20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="230" x="1220.5" y="1726.7466">Consent Request response recieved</text><rect fill="#FBFB77" filter="url(#f15l9oqlsclkm9)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="338" x="1041" y="1744.8125"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="330" x="1045" y="1760.8794">state: OTPAuthenticationChannelResponseRecieved</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1036.5" x2="1078.5" y1="1799.0781" y2="1799.0781"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1078.5" x2="1078.5" y1="1799.0781" y2="1812.0781"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1031.5" x2="1078.5" y1="1812.0781" y2="1812.0781"/><polygon fill="#A80036" points="1041.5,1808.0781,1031.5,1812.0781,1041.5,1816.0781,1037.5,1812.0781" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1043.5" y="1794.0122">REQUEST-CONSENT-21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="108" x="1210.5" y="1794.0122">this.saveToKVS()</text><polygon fill="#A80036" points="571.5,1832.2109,561.5,1836.2109,571.5,1840.2109,567.5,1836.2109" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="565.5" x2="1030.5" y1="1836.2109" y2="1836.2109"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="577.5" y="1831.145">REQUEST-CONSENT-22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="202" x="744.5" y="1831.145">return Authentication Response</text><polygon fill="#A80036" points="87.5,1861.3438,77.5,1865.3438,87.5,1869.3438,83.5,1865.3438" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="81.5" x2="554.5" y1="1865.3438" y2="1865.3438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="93.5" y="1860.2778">REQUEST-CONSENT-23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="201" x="260.5" y="1860.2778">200 OK Autentication Response</text><rect fill="#ADD8E6" filter="url(#f15l9oqlsclkm9)" height="234" style="stroke:#A80036;stroke-width:1.0;" width="465" x="85" y="1878.3438"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="89" y="1894.4106">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="128" x="97" y="1909.5435">channelResponse: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154" x="105" y="1924.6763">consentRequestId: 6789</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66" x="105" y="1939.8091">scopes: [{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="113" y="1954.9419">accountId: 'dfspa.username.1234',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="113" y="1970.0747">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="113" y="1985.2075">accountId: 'dfspa.username.5678',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="113" y="2000.3403">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="17" x="105" y="2015.4731">}],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="145" x="105" y="2030.606">authChannels: ["OTP"],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="105" y="2045.7388">callbackURI: 'pisp-app://callback...',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="441" x="105" y="2060.8716">authURI: 'dfspa.com/authorize?consentRequestId=6789' // this is new</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="12" x="97" y="2076.0044">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="391" x="97" y="2091.1372">currentState="OTPAuthenticationChannelResponseRecieved"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="89" y="2106.27">}</text><path d="M5,2123.3359 L5,2148.3359 L4375,2148.3359 L4375,2133.3359 L4365,2123.3359 L5,2123.3359 " fill="#FBFB77" filter="url(#f15l9oqlsclkm9)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M4365,2123.3359 L4365,2133.3359 L4375,2133.3359 L4365,2123.3359 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="609" x="1879" y="2140.4028">The DFSP is expected to send an OTP to the end user which will be used in the next linking step.</text><rect fill="#EEEEEE" filter="url(#f15l9oqlsclkm9)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="4800.5" x="0" y="2178.0352"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="4800.5" y1="2178.0352" y2="2178.0352"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="4800.5" y1="2181.0352" y2="2181.0352"/><rect fill="#EEEEEE" filter="url(#f15l9oqlsclkm9)" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="397" x="2201.75" y="2167.4688"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="378" x="2207.75" y="2183.5356">Authentication+Grant Consent+Register Credential</text><rect fill="#FBFB77" filter="url(#f15l9oqlsclkm9)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="503" x="81" y="2205.6016"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="495" x="85" y="2221.6685">PISP has obtained authToken from end-user(OTP) or through a callback(Web).</text><polygon fill="#A80036" points="538.5,2250.8672,548.5,2254.8672,538.5,2258.8672,542.5,2254.8672" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="81.5" x2="544.5" y1="2254.8672" y2="2254.8672"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="88.5" y="2249.8013">AUTHENTICATION-1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="312" x="231.5" y="2249.8013">POST /linking/request-consent/6789/authenticate</text><rect fill="#ADD8E6" filter="url(#f15l9oqlsclkm9)" height="68" style="stroke:#A80036;stroke-width:1.0;" width="320" x="86" y="2267.8672"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="312" x="90" y="2283.9341">POST /linking/request-consent/6789/authenticate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="90" y="2299.0669">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="98" y="2314.1997">authToken: '123456'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="90" y="2329.3325">}</text><line style="stroke:#A80036;stroke-width:1.0;" x1="560.5" x2="602.5" y1="2362.5313" y2="2362.5313"/><line style="stroke:#A80036;stroke-width:1.0;" x1="602.5" x2="602.5" y1="2362.5313" y2="2375.5313"/><line style="stroke:#A80036;stroke-width:1.0;" x1="561.5" x2="602.5" y1="2375.5313" y2="2375.5313"/><polygon fill="#A80036" points="571.5,2371.5313,561.5,2375.5313,571.5,2379.5313,567.5,2375.5313" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="567.5" y="2357.4653">AUTHENTICATION-2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="309" x="710.5" y="2357.4653">const model = await loadFromKVS({key: 6789})</text><rect fill="#FBFB77" filter="url(#f15l9oqlsclkm9)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="648" x="565" y="2388.5313"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="640" x="569" y="2404.5981">state: webAuthenticationChannelResponseRecieved or OTPAuthenticationChannelResponseRecieved</text><polygon fill="#A80036" points="1014.5,2433.7969,1024.5,2437.7969,1014.5,2441.7969,1018.5,2437.7969" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="560.5" x2="1020.5" y1="2437.7969" y2="2437.7969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="567.5" y="2432.731">AUTHENTICATION-3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="710.5" y="2432.731">model.authenticate()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1036.5" x2="1078.5" y1="2466.9297" y2="2466.9297"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1078.5" x2="1078.5" y1="2466.9297" y2="2479.9297"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1037.5" x2="1078.5" y1="2479.9297" y2="2479.9297"/><polygon fill="#A80036" points="1047.5,2475.9297,1037.5,2479.9297,1047.5,2483.9297,1043.5,2479.9297" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="1043.5" y="2461.8638">AUTHENTICATION-4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="285" x="1186.5" y="2461.8638">ThirdpartyRequests.patchConsentRequests()</text><polygon fill="#A80036" points="2040.5,2505.0625,2050.5,2509.0625,2040.5,2513.0625,2044.5,2509.0625" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1036.5" x2="2046.5" y1="2509.0625" y2="2509.0625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="1043.5" y="2503.9966">AUTHENTICATION-5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="197" x="1186.5" y="2503.9966">PATCH /consentRequests/6789</text><rect fill="#ADD8E6" filter="url(#f15l9oqlsclkm9)" height="98" style="stroke:#A80036;stroke-width:1.0;" width="205" x="1041" y="2522.0625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="197" x="1045" y="2538.1294">PATCH /consentRequests/6789</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="1045" y="2553.2622">FSIOP-Source: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="1045" y="2568.395">FSIOP-Destination: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1045" y="2583.5278">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="1053" y="2598.6606">authToken: '124356'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1045" y="2613.7935">}</text><polygon fill="#A80036" points="1042.5,2642.9922,1032.5,2646.9922,1042.5,2650.9922,1038.5,2646.9922" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1036.5" x2="2051.5" y1="2646.9922" y2="2646.9922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="1048.5" y="2641.9263">AUTHENTICATION-6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="1191.5" y="2641.9263">202 Accepted</text><polygon fill="#A80036" points="3261.5,2672.125,3271.5,2676.125,3261.5,2680.125,3265.5,2676.125" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2062.5" x2="3267.5" y1="2676.125" y2="2676.125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="2069.5" y="2671.0591">AUTHENTICATION-7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="197" x="2212.5" y="2671.0591">PATCH /consentRequests/6789</text><polygon fill="#A80036" points="2073.5,2701.2578,2063.5,2705.2578,2073.5,2709.2578,2069.5,2705.2578" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2067.5" x2="3272.5" y1="2705.2578" y2="2705.2578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="2079.5" y="2700.1919">AUTHENTICATION-8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2222.5" y="2700.1919">202 Accepted</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3283.5" x2="3325.5" y1="2734.3906" y2="2734.3906"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3325.5" x2="3325.5" y1="2734.3906" y2="2747.3906"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3284.5" x2="3325.5" y1="2747.3906" y2="2747.3906"/><polygon fill="#A80036" points="3294.5,2743.3906,3284.5,2747.3906,3294.5,2751.3906,3290.5,2747.3906" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="3290.5" y="2729.3247">AUTHENTICATION-9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="309" x="3433.5" y="2729.3247">const model = await loadFromKVS({key: 6789})</text><rect fill="#FBFB77" filter="url(#f15l9oqlsclkm9)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="280" x="3288" y="2760.3906"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="272" x="3292" y="2776.4575">state: consentRequestValidatedAndStored</text><polygon fill="#A80036" points="3777.5,2805.6563,3787.5,2809.6563,3777.5,2813.6563,3781.5,2809.6563" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3283.5" x2="3783.5" y1="2809.6563" y2="2809.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3290.5" y="2804.5903">AUTHENTICATION-10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="172" x="3442.5" y="2804.5903">model.validateAuthToken()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3841.5" y1="2868.7891" y2="2868.7891"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3841.5" x2="3841.5" y1="2868.7891" y2="2881.7891"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3800.5" x2="3841.5" y1="2881.7891" y2="2881.7891"/><polygon fill="#A80036" points="3810.5,2877.7891,3800.5,2881.7891,3810.5,2885.7891,3806.5,2881.7891" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3806.5" y="2863.7231">AUTHENTICATION-11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="280" x="3958.5" y="2863.7231">DFSPBackendRequests.validateAuthToken()</text><rect fill="#ADD8E6" filter="url(#f15l9oqlsclkm9)" height="159" style="stroke:#A80036;stroke-width:1.0;" width="416" x="3804" y="2894.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="312" x="3808" y="2910.856">Do we need two backend endpoints for validating</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="408" x="3808" y="2925.9888">web authTokens and OTP authTokens? Or is a DFSP expected to</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="248" x="3808" y="2941.1216">validate both cases with one endpoint?</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="0" x="3812" y="2956.2544"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="160" x="3808" y="2971.3872">POST /validateAuthToken</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3808" y="2986.52">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="160" x="3816" y="3001.6528">consentRequestId: '6789'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="251" x="3816" y="3016.7856">authChannel: model.data.authChannel,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="3816" y="3031.9185">authToken: '124356'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3808" y="3047.0513">}</text><rect fill="#FBFB77" filter="url(#f15l9oqlsclkm9)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="176" x="3804" y="3064.1172"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="168" x="3808" y="3080.1841">state: authTokenValidated</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3841.5" y1="3113.3828" y2="3113.3828"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3841.5" x2="3841.5" y1="3113.3828" y2="3126.3828"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3800.5" x2="3841.5" y1="3126.3828" y2="3126.3828"/><polygon fill="#A80036" points="3810.5,3122.3828,3800.5,3126.3828,3810.5,3130.3828,3806.5,3126.3828" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3806.5" y="3108.3169">AUTHENTICATION-12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="157" x="3958.5" y="3108.3169">const consentId = uuid()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3841.5" y1="3155.5156" y2="3155.5156"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3841.5" x2="3841.5" y1="3155.5156" y2="3168.5156"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3800.5" x2="3841.5" y1="3168.5156" y2="3168.5156"/><polygon fill="#A80036" points="3810.5,3164.5156,3800.5,3168.5156,3810.5,3172.5156,3806.5,3168.5156" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3806.5" y="3150.4497">AUTHENTICATION-13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="141" x="3958.5" y="3150.4497">model.grantConsent()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3841.5" y1="3197.6484" y2="3197.6484"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3841.5" x2="3841.5" y1="3197.6484" y2="3210.6484"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3800.5" x2="3841.5" y1="3210.6484" y2="3210.6484"/><polygon fill="#A80036" points="3810.5,3206.6484,3800.5,3210.6484,3810.5,3214.6484,3806.5,3210.6484" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3806.5" y="3192.5825">AUTHENTICATION-14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="225" x="3958.5" y="3192.5825">ThirdpartyRequests.postConsents()</text><rect fill="#FBFB77" filter="url(#f15l9oqlsclkm9)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="152" x="3804" y="3223.6484"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="144" x="3808" y="3239.7153">state: consentGranted</text><rect fill="#ADD8E6" filter="url(#f15l9oqlsclkm9)" height="68" style="stroke:#A80036;stroke-width:1.0;" width="495" x="3804" y="3256.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="484" x="3808" y="3272.8481">It's important to save the model with the consentId from this point onwards!</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="458" x="3808" y="3287.981">Requests will not contain a consentRequestId in the upcoming requests.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="487" x="3808" y="3303.1138">This may require changing `PersistentModel` to have a secondary key it can</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="3808" y="3318.2466">store the model with.</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3846.5" y1="3346.4453" y2="3346.4453"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3846.5" x2="3846.5" y1="3346.4453" y2="3359.4453"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3805.5" x2="3846.5" y1="3359.4453" y2="3359.4453"/><polygon fill="#A80036" points="3815.5,3355.4453,3805.5,3359.4453,3815.5,3363.4453,3811.5,3359.4453" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3811.5" y="3341.3794">AUTHENTICATION-15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="223" x="3963.5" y="3341.3794">this.saveToKVS({key: '1a2b3c4d'})</text><polygon fill="#A80036" points="2073.5,3389.5781,2063.5,3393.5781,2073.5,3397.5781,2069.5,3393.5781" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2067.5" x2="3788.5" y1="3393.5781" y2="3393.5781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2079.5" y="3388.5122">AUTHENTICATION-16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100" x="2231.5" y="3388.5122">POST /consents</text><rect fill="#ADD8E6" filter="url(#f15l9oqlsclkm9)" height="129" style="stroke:#A80036;stroke-width:1.0;" width="191" x="3593" y="3406.5781"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100" x="3597" y="3422.645">POST /consents</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="130" x="3597" y="3437.7778">FSIOP-Source: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="157" x="3597" y="3452.9106">FSIOP-Destination: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3597" y="3468.0435">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="133" x="3605" y="3483.1763">consentId: 1a2b3c4d</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154" x="3605" y="3498.3091">consentRequestId: 6789</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="175" x="3605" y="3513.4419">scopes: model.data.scopes</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3597" y="3528.5747">}</text><polygon fill="#A80036" points="3782.5,3557.7734,3792.5,3561.7734,3782.5,3565.7734,3786.5,3561.7734" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2062.5" x2="3788.5" y1="3561.7734" y2="3561.7734"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2069.5" y="3556.7075">AUTHENTICATION-17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="96" x="2221.5" y="3556.7075">202 ACCEPTED</text><polygon fill="#A80036" points="1557.5,3586.9063,1547.5,3590.9063,1557.5,3594.9063,1553.5,3590.9063" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1551.5" x2="2051.5" y1="3590.9063" y2="3590.9063"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1563.5" y="3585.8403">AUTHENTICATION-18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100" x="1715.5" y="3585.8403">POST /consents</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1546.5" x2="1593.5" y1="3615.0391" y2="3615.0391"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1593.5" x2="1593.5" y1="3615.0391" y2="3628.0391"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1552.5" x2="1593.5" y1="3628.0391" y2="3628.0391"/><polygon fill="#A80036" points="1562.5,3624.0391,1552.5,3628.0391,1562.5,3632.0391,1558.5,3628.0391" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1558.5" y="3609.9731">AUTHENTICATION-19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="309" x="1710.5" y="3609.9731">const model = await loadFromKVS({key: 6789})</text><polygon fill="#A80036" points="1047.5,3658.1719,1037.5,3662.1719,1047.5,3666.1719,1043.5,3662.1719" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1041.5" x2="1535.5" y1="3662.1719" y2="3662.1719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1053.5" y="3657.106">AUTHENTICATION-20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="168" x="1205.5" y="3657.106">model.registerCredential()</text><polygon fill="#A80036" points="2045.5,3687.3047,2055.5,3691.3047,2045.5,3695.3047,2049.5,3691.3047" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1541.5" x2="2051.5" y1="3691.3047" y2="3691.3047"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1548.5" y="3686.2388">AUTHENTICATION-21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="1700.5" y="3686.2388">202 Accepted</text><rect fill="#FBFB77" filter="url(#f15l9oqlsclkm9)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="157" x="1041" y="3704.3047"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="149" x="1045" y="3720.3716">state: consentRecieved</text><rect fill="#ADD8E6" filter="url(#f15l9oqlsclkm9)" height="68" style="stroke:#A80036;stroke-width:1.0;" width="495" x="1041" y="3737.4375"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="484" x="1045" y="3753.5044">It's important to save the model with the consentId from this point onwards!</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="458" x="1045" y="3768.6372">Requests will not contain a consentRequestId in the upcoming requests.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="487" x="1045" y="3783.77">This may require changing `PersistentModel` to have a secondary key it can</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="1045" y="3798.9028">store the model with.</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1036.5" x2="1078.5" y1="3832.1016" y2="3832.1016"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1078.5" x2="1078.5" y1="3832.1016" y2="3845.1016"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1037.5" x2="1078.5" y1="3845.1016" y2="3845.1016"/><polygon fill="#A80036" points="1047.5,3841.1016,1037.5,3845.1016,1047.5,3849.1016,1043.5,3845.1016" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1043.5" y="3827.0356">AUTHENTICATION-22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="1195.5" y="3827.0356">const challenge = deriveChallenge(consentRequest)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1036.5" x2="1078.5" y1="3874.2344" y2="3874.2344"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1078.5" x2="1078.5" y1="3874.2344" y2="3887.2344"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1037.5" x2="1078.5" y1="3887.2344" y2="3887.2344"/><polygon fill="#A80036" points="1047.5,3883.2344,1037.5,3887.2344,1047.5,3891.2344,1043.5,3887.2344" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1043.5" y="3869.1685">AUTHENTICATION-23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="223" x="1195.5" y="3869.1685">this.saveToKVS({key: '1a2b3c4d'})</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1036.5" x2="1083.5" y1="3911.3672" y2="3911.3672"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1083.5" x2="1083.5" y1="3911.3672" y2="3924.3672"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1042.5" x2="1083.5" y1="3924.3672" y2="3924.3672"/><polygon fill="#A80036" points="1052.5,3920.3672,1042.5,3924.3672,1052.5,3928.3672,1048.5,3924.3672" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1048.5" y="3906.3013">AUTHENTICATION-24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="218" x="1200.5" y="3906.3013">ThirdpartyRequests.putConsents()</text><rect fill="#FBFB77" filter="url(#f15l9oqlsclkm9)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="174" x="1041" y="3942.3672"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="166" x="1045" y="3958.4341">state: signedConsentSent</text><polygon fill="#A80036" points="2040.5,3987.6328,2050.5,3991.6328,2040.5,3995.6328,2044.5,3991.6328" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1036.5" x2="2046.5" y1="3991.6328" y2="3991.6328"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1043.5" y="3986.5669">AUTHENTICATION-25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="1195.5" y="3986.5669">PUT /consents/1a2b3c4d</text><rect fill="#ADD8E6" filter="url(#f15l9oqlsclkm9)" height="250" style="stroke:#A80036;stroke-width:1.0;" width="358" x="1041" y="4004.6328"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="1045" y="4020.6997">PUT /consents/1a2b3c4d</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="1045" y="4035.8325">FSIOP-Source: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="1045" y="4050.9653">FSIOP-Destination: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1045" y="4066.0981">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66" x="1053" y="4081.231">scopes: [{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="1061" y="4096.3638">accountId: 'dfspa.username.1234',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="1061" y="4111.4966">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="1061" y="4126.6294">accountId: 'dfspa.username.5678',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="1061" y="4141.7622">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="17" x="1053" y="4156.895">}],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="1053" y="4172.0278">credential: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="145" x="1061" y="4187.1606">credentialType: "FIDO",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="121" x="1061" y="4202.2935">status: "PENDING",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="183" x="1061" y="4217.4263">payload: PublicKeyCredential</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1053" y="4232.5591">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1045" y="4247.6919">}</text><polygon fill="#A80036" points="1042.5,4276.8906,1032.5,4280.8906,1042.5,4284.8906,1038.5,4280.8906" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1036.5" x2="2051.5" y1="4280.8906" y2="4280.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1048.5" y="4275.8247">AUTHENTICATION-26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="1200.5" y="4275.8247">202 Accepted</text><polygon fill="#A80036" points="3261.5,4306.0234,3271.5,4310.0234,3261.5,4314.0234,3265.5,4310.0234" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2062.5" x2="3267.5" y1="4310.0234" y2="4310.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2069.5" y="4304.9575">AUTHENTICATION-27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="2221.5" y="4304.9575">PUT /consents/1a2b3c4d</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3283.5" x2="3330.5" y1="4334.1563" y2="4334.1563"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3330.5" x2="3330.5" y1="4334.1563" y2="4347.1563"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3289.5" x2="3330.5" y1="4347.1563" y2="4347.1563"/><polygon fill="#A80036" points="3299.5,4343.1563,3289.5,4347.1563,3299.5,4351.1563,3295.5,4347.1563" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3295.5" y="4329.0903">AUTHENTICATION-28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="340" x="3447.5" y="4329.0903">const model = await loadFromKVS({key: 1a2b3c4d})</text><rect fill="#FBFB77" filter="url(#f15l9oqlsclkm9)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="201" x="3288" y="4365.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="193" x="3292" y="4381.2231">state: signedConsentRecieved</text><polygon fill="#A80036" points="3777.5,4410.4219,3787.5,4414.4219,3777.5,4418.4219,3781.5,4414.4219" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3283.5" x2="3783.5" y1="4414.4219" y2="4414.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3290.5" y="4409.356">AUTHENTICATION-29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="201" x="3442.5" y="4409.356">model.validateSignedConsent()</text><rect fill="#FBFB77" filter="url(#f15l9oqlsclkm9)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="264" x="3288" y="4427.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="256" x="3292" y="4443.4888">state: pendingRegistrationAndValidation</text><polygon fill="#A80036" points="2068.5,4472.6875,2058.5,4476.6875,2068.5,4480.6875,2064.5,4476.6875" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2062.5" x2="3277.5" y1="4476.6875" y2="4476.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2074.5" y="4471.6216">AUTHENTICATION-30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2226.5" y="4471.6216">202 Accepted</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3841.5" y1="4505.8203" y2="4505.8203"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3841.5" x2="3841.5" y1="4505.8203" y2="4518.8203"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3800.5" x2="3841.5" y1="4518.8203" y2="4518.8203"/><polygon fill="#A80036" points="3810.5,4514.8203,3800.5,4518.8203,3810.5,4522.8203,3806.5,4518.8203" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3806.5" y="4500.7544">AUTHENTICATION-31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="144" x="3958.5" y="4500.7544">Check signed consent.</text><rect fill="#ADD8E6" filter="url(#f15l9oqlsclkm9)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="530" x="3804" y="4531.8203"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="522" x="3808" y="4547.8872">Does this need a backend request or can the scheme adapter check the consent.</text><rect fill="#FBFB77" filter="url(#f15l9oqlsclkm9)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="199" x="3804" y="4564.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="3808" y="4581.02">state: signedConsentChecked</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3846.5" y1="4609.2188" y2="4609.2188"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3846.5" x2="3846.5" y1="4609.2188" y2="4622.2188"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3805.5" x2="3846.5" y1="4622.2188" y2="4622.2188"/><polygon fill="#A80036" points="3815.5,4618.2188,3805.5,4622.2188,3815.5,4626.2188,3811.5,4622.2188" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3811.5" y="4604.1528">AUTHENTICATION-32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="208" x="3963.5" y="4604.1528">model.validateWithAuthService()</text><polygon fill="#A80036" points="2073.5,4652.3516,2063.5,4656.3516,2073.5,4660.3516,2069.5,4656.3516" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2067.5" x2="3788.5" y1="4656.3516" y2="4656.3516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2079.5" y="4651.2856">AUTHENTICATION-33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="167" x="2231.5" y="4651.2856">POST /consents/1a2b3c4d</text><rect fill="#ADD8E6" filter="url(#f15l9oqlsclkm9)" height="250" style="stroke:#A80036;stroke-width:1.0;" width="358" x="3426" y="4669.3516"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="167" x="3430" y="4685.4185">POST /consents/1a2b3c4d</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="130" x="3430" y="4700.5513">FSIOP-Source: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="201" x="3430" y="4715.6841">FSIOP-Destination: central-auth</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3430" y="4730.8169">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66" x="3438" y="4745.9497">scopes: [{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="3446" y="4761.0825">accountId: 'dfspa.username.1234',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="3446" y="4776.2153">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="3446" y="4791.3481">accountId: 'dfspa.username.5678',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="3446" y="4806.481">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="17" x="3438" y="4821.6138">}],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="3438" y="4836.7466">credential: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="145" x="3446" y="4851.8794">credentialType: "FIDO",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="121" x="3446" y="4867.0122">status: "PENDING",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="183" x="3446" y="4882.145">payload: PublicKeyCredential</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3438" y="4897.2778">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3430" y="4912.4106">}</text><polygon fill="#A80036" points="3777.5,4941.6094,3787.5,4945.6094,3777.5,4949.6094,3781.5,4945.6094" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2062.5" x2="3783.5" y1="4945.6094" y2="4945.6094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2069.5" y="4940.5435">AUTHENTICATION-34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2221.5" y="4940.5435">202 Accepted</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3841.5" y1="4979.7422" y2="4979.7422"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3841.5" x2="3841.5" y1="4979.7422" y2="4992.7422"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3794.5" x2="3841.5" y1="4992.7422" y2="4992.7422"/><polygon fill="#A80036" points="3804.5,4988.7422,3794.5,4992.7422,3804.5,4996.7422,3800.5,4992.7422" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3806.5" y="4974.6763">AUTHENTICATION-35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="108" x="3958.5" y="4974.6763">this.saveToKVS()</text><polygon fill="#A80036" points="2388.5,5012.875,2398.5,5016.875,2388.5,5020.875,2392.5,5016.875" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2062.5" x2="2394.5" y1="5016.875" y2="5016.875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2069.5" y="5011.8091">AUTHENTICATION-36</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="167" x="2221.5" y="5011.8091">POST /consents/1a2b3c4d</text><polygon fill="#A80036" points="2073.5,5042.0078,2063.5,5046.0078,2073.5,5050.0078,2069.5,5046.0078" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2067.5" x2="2399.5" y1="5046.0078" y2="5046.0078"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2079.5" y="5040.9419">AUTHENTICATION-37</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2231.5" y="5040.9419">202 Accepted</text><line style="stroke:#A80036;stroke-width:1.0;" x1="2410.5" x2="2452.5" y1="5075.1406" y2="5075.1406"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2452.5" x2="2452.5" y1="5075.1406" y2="5088.1406"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2411.5" x2="2452.5" y1="5088.1406" y2="5088.1406"/><polygon fill="#A80036" points="2421.5,5084.1406,2411.5,5088.1406,2421.5,5092.1406,2417.5,5088.1406" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2417.5" y="5070.0747">AUTHENTICATION-38</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="98" x="2569.5" y="5070.0747">Check consent.</text><polygon fill="#A80036" points="2073.5,5113.2734,2063.5,5117.2734,2073.5,5121.2734,2069.5,5117.2734" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2067.5" x2="2399.5" y1="5117.2734" y2="5117.2734"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2079.5" y="5112.2075">AUTHENTICATION-39</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="2231.5" y="5112.2075">PUT /consents/1a2b3c4d</text><rect fill="#ADD8E6" filter="url(#f15l9oqlsclkm9)" height="250" style="stroke:#A80036;stroke-width:1.0;" width="358" x="2037" y="5130.2734"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="2041" y="5146.3403">PUT /consents/1a2b3c4d</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="173" x="2041" y="5161.4731">FSIOP-Source: central-auth</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="2041" y="5176.606">FSIOP-Destination: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2041" y="5191.7388">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66" x="2049" y="5206.8716">scopes: [{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="2057" y="5222.0044">accountId: 'dfspa.username.1234',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="2057" y="5237.1372">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="2057" y="5252.27">accountId: 'dfspa.username.5678',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="2057" y="5267.4028">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="17" x="2049" y="5282.5356">}],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="2049" y="5297.6685">credential: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="145" x="2057" y="5312.8013">credentialType: "FIDO",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="118" x="2057" y="5327.9341">status: "VERIFIED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="183" x="2057" y="5343.0669">payload: PublicKeyCredential</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2049" y="5358.1997">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2041" y="5373.3325">}</text><polygon fill="#A80036" points="2388.5,5402.5313,2398.5,5406.5313,2388.5,5410.5313,2392.5,5406.5313" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2062.5" x2="2394.5" y1="5406.5313" y2="5406.5313"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2069.5" y="5401.4653">AUTHENTICATION-40</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="2221.5" y="5401.4653">200 OK</text><polygon fill="#A80036" points="3261.5,5431.6641,3271.5,5435.6641,3261.5,5439.6641,3265.5,5435.6641" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2062.5" x2="3267.5" y1="5435.6641" y2="5435.6641"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2069.5" y="5430.5981">AUTHENTICATION-41</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="2221.5" y="5430.5981">PUT /consents/1a2b3c4d</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3283.5" x2="3325.5" y1="5464.7969" y2="5464.7969"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3325.5" x2="3325.5" y1="5464.7969" y2="5477.7969"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3284.5" x2="3325.5" y1="5477.7969" y2="5477.7969"/><polygon fill="#A80036" points="3294.5,5473.7969,3284.5,5477.7969,3294.5,5481.7969,3290.5,5477.7969" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3290.5" y="5459.731">AUTHENTICATION-42</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="340" x="3442.5" y="5459.731">const model = await loadFromKVS({key: 1a2b3c4d})</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3283.5" x2="3325.5" y1="5506.9297" y2="5506.9297"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3325.5" x2="3325.5" y1="5506.9297" y2="5519.9297"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3284.5" x2="3325.5" y1="5519.9297" y2="5519.9297"/><polygon fill="#A80036" points="3294.5,5515.9297,3284.5,5519.9297,3294.5,5523.9297,3290.5,5519.9297" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3290.5" y="5501.8638">AUTHENTICATION-43</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="180" x="3442.5" y="5501.8638">consentResponseRecieved()</text><rect fill="#FBFB77" filter="url(#f15l9oqlsclkm9)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="219" x="3288" y="5532.9297"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="211" x="3292" y="5548.9966">state: consentResponseRecieved</text><polygon fill="#A80036" points="3777.5,5578.1953,3787.5,5582.1953,3777.5,5586.1953,3781.5,5582.1953" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3283.5" x2="3783.5" y1="5582.1953" y2="5582.1953"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3290.5" y="5577.1294">AUTHENTICATION-44</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="202" x="3442.5" y="5577.1294">Auth Service response recieved</text><polygon fill="#A80036" points="2068.5,5607.3281,2058.5,5611.3281,2068.5,5615.3281,2064.5,5611.3281" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2062.5" x2="3277.5" y1="5611.3281" y2="5611.3281"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2074.5" y="5606.2622">AUTHENTICATION-45</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="2226.5" y="5606.2622">200 OK</text><polygon fill="#A80036" points="2829.5,5636.4609,2839.5,5640.4609,2829.5,5644.4609,2833.5,5640.4609" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2410.5" x2="2835.5" y1="5640.4609" y2="5640.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2417.5" y="5635.395">AUTHENTICATION-46</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="260" x="2569.5" y="5635.395">POST /participants/CONSENTS/1a2b3c4d</text><polygon fill="#A80036" points="2416.5,5665.5938,2406.5,5669.5938,2416.5,5673.5938,2412.5,5669.5938" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2410.5" x2="2840.5" y1="5669.5938" y2="5669.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2422.5" y="5664.5278">AUTHENTICATION-47</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2574.5" y="5664.5278">202 Accepted</text><polygon fill="#A80036" points="3261.5,5694.7266,3271.5,5698.7266,3261.5,5702.7266,3265.5,5698.7266" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2851.5" x2="3267.5" y1="5698.7266" y2="5698.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2858.5" y="5693.6606">AUTHENTICATION-48</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="251" x="3010.5" y="5693.6606">PUT /participants/CONSENTS/1a2b3c4d</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3283.5" x2="3325.5" y1="5727.8594" y2="5727.8594"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3325.5" x2="3325.5" y1="5727.8594" y2="5740.8594"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3284.5" x2="3325.5" y1="5740.8594" y2="5740.8594"/><polygon fill="#A80036" points="3294.5,5736.8594,3284.5,5740.8594,3294.5,5744.8594,3290.5,5740.8594" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3290.5" y="5722.7935">AUTHENTICATION-49</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="340" x="3442.5" y="5722.7935">const model = await loadFromKVS({key: 1a2b3c4d})</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3283.5" x2="3325.5" y1="5769.9922" y2="5769.9922"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3325.5" x2="3325.5" y1="5769.9922" y2="5782.9922"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3284.5" x2="3325.5" y1="5782.9922" y2="5782.9922"/><polygon fill="#A80036" points="3294.5,5778.9922,3284.5,5782.9922,3294.5,5786.9922,3290.5,5782.9922" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3290.5" y="5764.9263">AUTHENTICATION-50</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="197" x="3442.5" y="5764.9263">participantResponseRecieved()</text><rect fill="#FBFB77" filter="url(#f15l9oqlsclkm9)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="243" x="3288" y="5795.9922"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="235" x="3292" y="5812.0591">state: participantsResponseRecieved</text><polygon fill="#A80036" points="3777.5,5841.2578,3787.5,5845.2578,3777.5,5849.2578,3781.5,5845.2578" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3283.5" x2="3783.5" y1="5845.2578" y2="5845.2578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3290.5" y="5840.1919">AUTHENTICATION-51</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="189" x="3442.5" y="5840.1919">Participant response recieved</text><polygon fill="#A80036" points="2857.5,5870.3906,2847.5,5874.3906,2857.5,5878.3906,2853.5,5874.3906" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2851.5" x2="3277.5" y1="5874.3906" y2="5874.3906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2863.5" y="5869.3247">AUTHENTICATION-52</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="3015.5" y="5869.3247">200 Accepted</text><rect fill="#FBFB77" filter="url(#f15l9oqlsclkm9)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="253" x="3804" y="5887.3906"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="245" x="3808" y="5903.4575">state: consentRegisteredAndValidated</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3841.5" y1="5936.6563" y2="5936.6563"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3841.5" x2="3841.5" y1="5936.6563" y2="5949.6563"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3800.5" x2="3841.5" y1="5949.6563" y2="5949.6563"/><polygon fill="#A80036" points="3810.5,5945.6563,3800.5,5949.6563,3810.5,5953.6563,3806.5,5949.6563" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3806.5" y="5931.5903">AUTHENTICATION-53</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="151" x="3958.5" y="5931.5903">model.finalizeConsent()</text><path d="M2016,5964.6563 L2093,5964.6563 L2093,5971.6563 L2083,5981.6563 L2016,5981.6563 L2016,5964.6563 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="279.3281" style="stroke:#000000;stroke-width:2.0;" width="1861" x="2016" y="5964.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="32" x="2031" y="5977.7231">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="116" x="2108" y="5976.8667">[for each scope in</text><text fill="#000000" font-family="monospace" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="105" x="2228" y="5976.8667">Consents.scopes</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="5" x="2333" y="5976.8667">]</text><polygon fill="#A80036" points="2068.5,5998.9219,2058.5,6002.9219,2068.5,6006.9219,2064.5,6002.9219" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2062.5" x2="3788.5" y1="6002.9219" y2="6002.9219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2074.5" y="5997.856">AUTHENTICATION-54</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="376" x="2226.5" y="5997.856">POST /participants/THIRD_PARTY_LINK/dfsp.username.5678</text><polygon fill="#A80036" points="3777.5,6028.0547,3787.5,6032.0547,3777.5,6036.0547,3781.5,6032.0547" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2057.5" x2="3783.5" y1="6032.0547" y2="6032.0547"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2064.5" y="6026.9888">AUTHENTICATION-55</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2216.5" y="6026.9888">202 Accepted</text><polygon fill="#A80036" points="2834.5,6057.1875,2844.5,6061.1875,2834.5,6065.1875,2838.5,6061.1875" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2057.5" x2="2840.5" y1="6061.1875" y2="6061.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2064.5" y="6056.1216">AUTHENTICATION-56</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="376" x="2216.5" y="6056.1216">POST /participants/THIRD_PARTY_LINK/dfsp.username.5678</text><polygon fill="#A80036" points="2068.5,6086.3203,2058.5,6090.3203,2068.5,6094.3203,2064.5,6090.3203" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2062.5" x2="2845.5" y1="6090.3203" y2="6090.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2074.5" y="6085.2544">AUTHENTICATION-57</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2226.5" y="6085.2544">202 Accepted</text><polygon fill="#A80036" points="2068.5,6115.4531,2058.5,6119.4531,2068.5,6123.4531,2064.5,6119.4531" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2062.5" x2="2845.5" y1="6119.4531" y2="6119.4531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2074.5" y="6114.3872">AUTHENTICATION-58</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="367" x="2226.5" y="6114.3872">PUT /participants/THIRD_PARTY_LINK/dfsp.username.5678</text><polygon fill="#A80036" points="2834.5,6144.5859,2844.5,6148.5859,2834.5,6152.5859,2838.5,6148.5859" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2057.5" x2="2840.5" y1="6148.5859" y2="6148.5859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2064.5" y="6143.52">AUTHENTICATION-59</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="2216.5" y="6143.52">200 OK</text><polygon fill="#A80036" points="3266.5,6173.7188,3276.5,6177.7188,3266.5,6181.7188,3270.5,6177.7188" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2057.5" x2="3272.5" y1="6177.7188" y2="6177.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2064.5" y="6172.6528">AUTHENTICATION-60</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="367" x="2216.5" y="6172.6528">PUT /participants/THIRD_PARTY_LINK/dfsp.username.5678</text><polygon fill="#A80036" points="2068.5,6202.8516,2058.5,6206.8516,2068.5,6210.8516,2064.5,6206.8516" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2062.5" x2="3277.5" y1="6206.8516" y2="6206.8516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2074.5" y="6201.7856">AUTHENTICATION-61</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="2226.5" y="6201.7856">200 OK</text><polygon fill="#A80036" points="3777.5,6231.9844,3787.5,6235.9844,3777.5,6239.9844,3781.5,6235.9844" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3278.5" x2="3783.5" y1="6235.9844" y2="6235.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3285.5" y="6230.9185">AUTHENTICATION-62</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="189" x="3437.5" y="6230.9185">Participant response recieved</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3841.5" y1="6272.1172" y2="6272.1172"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3841.5" x2="3841.5" y1="6272.1172" y2="6285.1172"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3800.5" x2="3841.5" y1="6285.1172" y2="6285.1172"/><polygon fill="#A80036" points="3810.5,6281.1172,3800.5,6285.1172,3810.5,6289.1172,3806.5,6285.1172" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3806.5" y="6267.0513">AUTHENTICATION-63</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="3958.5" y="6267.0513">await Promise.all()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3841.5" y1="6314.25" y2="6314.25"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3841.5" x2="3841.5" y1="6314.25" y2="6327.25"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3800.5" x2="3841.5" y1="6327.25" y2="6327.25"/><polygon fill="#A80036" points="3810.5,6323.25,3800.5,6327.25,3810.5,6331.25,3806.5,6327.25" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3806.5" y="6309.1841">AUTHENTICATION-64</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="201" x="3958.5" y="6309.1841">state: PISPDFSPLinkEstablished</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3841.5" y1="6356.3828" y2="6356.3828"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3841.5" x2="3841.5" y1="6356.3828" y2="6369.3828"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3800.5" x2="3841.5" y1="6369.3828" y2="6369.3828"/><polygon fill="#A80036" points="3810.5,6365.3828,3800.5,6369.3828,3810.5,6373.3828,3806.5,6369.3828" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3806.5" y="6351.3169">AUTHENTICATION-65</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="203" x="3958.5" y="6351.3169">model.notifyVerificationToPISP()</text><polygon fill="#A80036" points="2073.5,6394.5156,2063.5,6398.5156,2073.5,6402.5156,2069.5,6398.5156" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2067.5" x2="3788.5" y1="6398.5156" y2="6398.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2079.5" y="6393.4497">AUTHENTICATION-66</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="176" x="2231.5" y="6393.4497">PATCH /consents/1a2b3c4d</text><rect fill="#ADD8E6" filter="url(#f15l9oqlsclkm9)" height="129" style="stroke:#A80036;stroke-width:1.0;" width="184" x="3600" y="6411.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="176" x="3604" y="6427.5825">PATCH /consents/1a2b3c4d</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="130" x="3604" y="6442.7153">FSIOP-Source: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="157" x="3604" y="6457.8481">FSIOP-Destination: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3604" y="6472.981">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="3612" y="6488.1138">credential: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="3620" y="6503.2466">status: "VERIFIED"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3612" y="6518.3794">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3604" y="6533.5122">}</text><polygon fill="#A80036" points="3782.5,6562.7109,3792.5,6566.7109,3782.5,6570.7109,3786.5,6566.7109" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2062.5" x2="3788.5" y1="6566.7109" y2="6566.7109"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2069.5" y="6561.645">AUTHENTICATION-67</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="2221.5" y="6561.645">200 OK</text><polygon fill="#A80036" points="1557.5,6591.8438,1547.5,6595.8438,1557.5,6599.8438,1553.5,6595.8438" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1551.5" x2="2051.5" y1="6595.8438" y2="6595.8438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1563.5" y="6590.7778">AUTHENTICATION-68</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="176" x="1715.5" y="6590.7778">PATCH /consents/1a2b3c4d</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1546.5" x2="1593.5" y1="6619.9766" y2="6619.9766"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1593.5" x2="1593.5" y1="6619.9766" y2="6632.9766"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1552.5" x2="1593.5" y1="6632.9766" y2="6632.9766"/><polygon fill="#A80036" points="1562.5,6628.9766,1552.5,6632.9766,1562.5,6636.9766,1558.5,6632.9766" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1558.5" y="6614.9106">AUTHENTICATION-69</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="340" x="1710.5" y="6614.9106">const model = await loadFromKVS({key: 1a2b3c4d})</text><polygon fill="#A80036" points="1047.5,6663.1094,1037.5,6667.1094,1047.5,6671.1094,1043.5,6667.1094" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1041.5" x2="1535.5" y1="6667.1094" y2="6667.1094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1053.5" y="6662.0435">AUTHENTICATION-70</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="172" x="1205.5" y="6662.0435">Verified Response recieved</text><polygon fill="#A80036" points="2045.5,6692.2422,2055.5,6696.2422,2045.5,6700.2422,2049.5,6696.2422" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1541.5" x2="2051.5" y1="6696.2422" y2="6696.2422"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1548.5" y="6691.1763">AUTHENTICATION-71</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="1700.5" y="6691.1763">200 OK</text><rect fill="#FBFB77" filter="url(#f15l9oqlsclkm9)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="148" x="1041" y="6709.2422"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="140" x="1045" y="6725.3091">state: accountsLinked</text><polygon fill="#A80036" points="571.5,6754.5078,561.5,6758.5078,571.5,6762.5078,567.5,6758.5078" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="565.5" x2="1030.5" y1="6758.5078" y2="6758.5078"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="577.5" y="6753.4419">AUTHENTICATION-72</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="206" x="729.5" y="6753.4419">return Accounts linked response</text><polygon fill="#A80036" points="92.5,6783.6406,82.5,6787.6406,92.5,6791.6406,88.5,6787.6406" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="86.5" x2="549.5" y1="6787.6406" y2="6787.6406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="98.5" y="6782.5747">AUTHENTICATION-73</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154" x="250.5" y="6782.5747">200 OK Accounts Linked</text><rect fill="#ADD8E6" filter="url(#f15l9oqlsclkm9)" height="98" style="stroke:#A80036;stroke-width:1.0;" width="217" x="328" y="6800.6406"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="332" y="6816.7075">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="340" y="6831.8403">credential: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="348" y="6846.9731">status: "VERIFIED"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="340" y="6862.106">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="201" x="340" y="6877.2388">currentState="accountsLinked"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="332" y="6892.3716">}</text><!--MD5=[c63556bf0fbf8e48a5ea4873c3cf5ae3]
@startuml

title PISP Linking OTP

participant "PISP Backend" as PISP
box "PISP tp-scheme-adapter"
  participant "outbound-server" as PISP_TP_OUT
  participant "PISPLinkingModel" as PISP_LM
  participant "inbound-server" as PISP_TP_IN
end box
box "Mojaloop"
    participant Switch
    participant "Auth Service" as AUTH
    participant "Account Lookup Service" as ALS
end box
box "DFSP tp-scheme-adapter"
  participant "inbound-server" as DFSP_TP_IN
  participant "DFSPLinkingModel" as DFSP_LM
end box
participant DFSPAuthorizeSimulator

== Request Consent - OTP ==
autonumber 1 "<b>REQUEST-CONSENT-#</b>"
rnote right of PISP
PISP presents accounts to user. User selects one or more accounts to link.
end note
PISP -> PISP_TP_OUT: POST /linking/request-consent
rnote right of PISP #LightBlue
POST /linking/request-consent
{
  accounts: [
    { accountNickname: "XXXXXXnt", id: "dfspa.username.1234", currency: "ZAR" },
    { accountNickname: "SpeXXXXXXXXnt", id: "dfspa.username.5678", currency: "USD" }
  ],
  userId: "username1234", // so the dfsp can associate this request with GET /accounts
  callbackURI: 'pisp-app://callback'
}
end note

activate PISP
activate PISP_TP_OUT

PISP_TP_OUT -> PISP_TP_OUT: const model = await create()
rnote right of PISP_TP_OUT: state: start
PISP_TP_OUT -> PISP_LM: model.requestConsent()

activate PISP_LM

PISP_LM -> PISP_LM: ThirdpartyRequests.postConsentRequests()
PISP_LM -> PISP_LM: const consentRequestId = uuid()
PISP_LM -> Switch: POST /consentRequests
rnote right of PISP_LM #LightBlue
POST /consentRequests
FSIOP-Source: pispa
FSIOP-Destination: dfspa
{
  consentRequestId: 6789
  userId: "username1234"
  scopes: [{
    accountId: 'dfspa.username.1234',
    actions: ['accounts.getBalance', 'accounts.transfer'],
    accountId: 'dfspa.username.5678',
    actions: ['accounts.getBalance', 'accounts.transfer'],
  }],
  // model will add `authChannels`
  authChannels: ["WEB", "OTP"],
  callbackURI: 'pisp-app://callback...'
}
end note

activate Switch
Switch - -> PISP_LM: 202 Accepted
deactivate PISP_LM
Switch -> DFSP_TP_IN: POST /consentRequests
activate DFSP_TP_IN
DFSP_TP_IN - -> Switch: 202 Accepted
DFSP_TP_IN -> DFSP_TP_IN: const model = await create()
rnote right of DFSP_TP_IN: state: start
DFSP_TP_IN -> DFSP_LM: model.requestConsent()
activate DFSP_LM
deactivate Switch
deactivate DFSP_TP_IN
DFSP_LM -> DFSP_LM: DFSPBackendRequests.validateConsentRequest()
activate DFSPAuthorizeSimulator
DFSP_LM -> DFSPAuthorizeSimulator: POST /sendOTP
rnote right of DFSP_LM #LightBlue
POST /sendOTP
{
  consentRequestId: 6789,
  username: "username.1234",
  message: "0987"
}
end note
DFSPAuthorizeSimulator -> DFSPAuthorizeSimulator: take action on TTK for defined rule for username
DFSPAuthorizeSimulator -> DFSP_LM: 200 OK
rnote right of DFSP_LM: state: consentRequestValidatedAndStored
deactivate DFSPAuthorizeSimulator
deactivate DFSP_TP_IN


activate Switch
DFSP_LM -> Switch: PUT /consentRequests/6789

rnote left of DFSP_LM #LightBlue
PUT /consentRequests/6789
FSIOP-Source: pispa
FSIOP-Destination: dfspa
{
  consentRequestId: 6789
  scopes: [{
    accountId: 'dfspa.username.1234',
    actions: ['accounts.getBalance', 'accounts.transfer'],
    accountId: 'dfspa.username.5678',
    actions: ['accounts.getBalance', 'accounts.transfer'],
  }],
  authChannels: ["OTP"], // updated with the channel in use
  callbackURI: 'pisp-app://callback...',
  // note: no authURI for OTP flow
}
end note
Switch - -> DFSP_LM: 202 ACCEPTED
deactivate DFSP_LM
activate PISP_TP_IN
Switch ->  PISP_TP_IN: PUT /consentRequests/6789
PISP_TP_IN - -> Switch: 200 OK
deactivate Switch
activate PISP_LM
PISP_TP_IN - -> PISP_LM: Consent Request response recieved
rnote right of PISP_LM: state: OTPAuthenticationChannelResponseRecieved
PISP_LM - -> PISP_LM: this.saveToKVS()
deactivate PISP_TP_IN
PISP_LM -> PISP_TP_OUT: return Authentication Response
deactivate PISP_LM
PISP_TP_OUT - -> PISP: 200 OK Autentication Response
rnote left of PISP_TP_OUT #LightBlue
{
  channelResponse: {
    consentRequestId: 6789
    scopes: [{
      accountId: 'dfspa.username.1234',
      actions: ['accounts.getBalance', 'accounts.transfer'],
      accountId: 'dfspa.username.5678',
      actions: ['accounts.getBalance', 'accounts.transfer'],
    }],
    authChannels: ["OTP"],
    callbackURI: 'pisp-app://callback...',
    authURI: 'dfspa.com/authorize?consentRequestId=6789' // this is new
  },
  currentState="OTPAuthenticationChannelResponseRecieved"
}
end note

deactivate PISP_TP_OUT
deactivate PISP

note over PISP, DFSPAuthorizeSimulator
  The DFSP is expected to send an OTP to the end user which will be used in the next linking step.
end note

== Authentication+Grant Consent+Register Credential ==
autonumber 1 "<b>AUTHENTICATION-#</b>"
rnote right of PISP
PISP has obtained authToken from end-user(OTP) or through a callback(Web).
end note
PISP -> PISP_TP_OUT: POST /linking/request-consent/6789/authenticate
rnote right of PISP #LightBlue
POST /linking/request-consent/6789/authenticate
{
  authToken: '123456'
}
end note

activate PISP
activate PISP_TP_OUT

PISP_TP_OUT -> PISP_TP_OUT: const model = await loadFromKVS({key: 6789})
rnote right of PISP_TP_OUT: state: webAuthenticationChannelResponseRecieved or OTPAuthenticationChannelResponseRecieved
PISP_TP_OUT -> PISP_LM: model.authenticate()

activate PISP_LM

PISP_LM -> PISP_LM: ThirdpartyRequests.patchConsentRequests()
PISP_LM -> Switch: PATCH /consentRequests/6789
rnote right of PISP_LM #LightBlue
PATCH /consentRequests/6789
FSIOP-Source: pispa
FSIOP-Destination: dfspa
{
  authToken: '124356'
}
end note

activate Switch
Switch - -> PISP_LM: 202 Accepted
deactivate PISP_LM
Switch -> DFSP_TP_IN: PATCH /consentRequests/6789
activate DFSP_TP_IN
DFSP_TP_IN - -> Switch: 202 Accepted
DFSP_TP_IN -> DFSP_TP_IN: const model = await loadFromKVS({key: 6789})
rnote right of DFSP_TP_IN: state: consentRequestValidatedAndStored
DFSP_TP_IN -> DFSP_LM: model.validateAuthToken()
activate DFSP_LM

deactivate Switch
deactivate DFSP_TP_IN

DFSP_LM -> DFSP_LM: DFSPBackendRequests.validateAuthToken()
rnote right of DFSP_LM #LightBlue
Do we need two backend endpoints for validating
web authTokens and OTP authTokens? Or is a DFSP expected to
validate both cases with one endpoint?

POST /validateAuthToken
{
  consentRequestId: '6789'
  authChannel: model.data.authChannel,
  authToken: '124356'
}
end note
rnote right of DFSP_LM: state: authTokenValidated

DFSP_LM -> DFSP_LM: const consentId = uuid()
DFSP_LM -> DFSP_LM: model.grantConsent()
DFSP_LM -> DFSP_LM: ThirdpartyRequests.postConsents()
rnote right of DFSP_LM: state: consentGranted
rnote right of DFSP_LM #LightBlue
It's important to save the model with the consentId from this point onwards!
Requests will not contain a consentRequestId in the upcoming requests.
This may require changing `PersistentModel` to have a secondary key it can
store the model with.
end note
DFSP_LM -> DFSP_LM: this.saveToKVS({key: '1a2b3c4d'})

activate Switch
DFSP_LM -> Switch: POST /consents

rnote left of DFSP_LM #LightBlue
POST /consents
FSIOP-Source: dfspa
FSIOP-Destination: pispa
{
  consentId: 1a2b3c4d
  consentRequestId: 6789
  scopes: model.data.scopes
}
end note
Switch - -> DFSP_LM: 202 ACCEPTED
deactivate DFSP_LM
activate PISP_TP_IN
Switch ->  PISP_TP_IN: POST /consents
PISP_TP_IN -> PISP_TP_IN: const model = await loadFromKVS({key: 6789})
activate PISP_LM
PISP_TP_IN -> PISP_LM: model.registerCredential()
PISP_TP_IN - -> Switch: 202 Accepted
deactivate PISP_TP_IN
deactivate Switch
rnote right of PISP_LM: state: consentRecieved
rnote right of PISP_LM #LightBlue
It's important to save the model with the consentId from this point onwards!
Requests will not contain a consentRequestId in the upcoming requests.
This may require changing `PersistentModel` to have a secondary key it can
store the model with.
end note
PISP_LM - -> PISP_LM: const challenge = deriveChallenge(consentRequest)
PISP_LM - -> PISP_LM: this.saveToKVS({key: '1a2b3c4d'})

PISP_LM -> PISP_LM: ThirdpartyRequests.putConsents()
rnote right of PISP_LM: state: signedConsentSent
activate Switch
PISP_LM -> Switch: PUT /consents/1a2b3c4d

rnote right of PISP_LM #LightBlue
PUT /consents/1a2b3c4d
FSIOP-Source: pispa
FSIOP-Destination: dfspa
{
  scopes: [{
    accountId: 'dfspa.username.1234',
    actions: ['accounts.getBalance', 'accounts.transfer'],
    accountId: 'dfspa.username.5678',
    actions: ['accounts.getBalance', 'accounts.transfer'],
  }],
  credential: {
    credentialType: "FIDO",
    status: "PENDING",
    payload: PublicKeyCredential
  }
}
end note

Switch - -> PISP_LM: 202 Accepted
deactivate PISP_LM
Switch -> DFSP_TP_IN: PUT /consents/1a2b3c4d
activate DFSP_TP_IN

DFSP_TP_IN -> DFSP_TP_IN: const model = await loadFromKVS({key: 1a2b3c4d})
activate DFSP_LM
rnote right of DFSP_TP_IN: state: signedConsentRecieved
DFSP_TP_IN -> DFSP_LM: model.validateSignedConsent()
rnote right of DFSP_TP_IN: state: pendingRegistrationAndValidation
DFSP_TP_IN - -> Switch: 202 Accepted
deactivate Switch
deactivate DFSP_TP_IN
DFSP_LM -> DFSP_LM: Check signed consent.
rnote right of DFSP_LM #LightBlue
Does this need a backend request or can the scheme adapter check the consent.
end note
rnote right of DFSP_LM: state: signedConsentChecked
DFSP_LM-> DFSP_LM: model.validateWithAuthService()
activate Switch
DFSP_LM -> Switch: POST /consents/1a2b3c4d

rnote left of DFSP_LM #LightBlue
POST /consents/1a2b3c4d
FSIOP-Source: dfspa
FSIOP-Destination: central-auth
{
  scopes: [{
    accountId: 'dfspa.username.1234',
    actions: ['accounts.getBalance', 'accounts.transfer'],
    accountId: 'dfspa.username.5678',
    actions: ['accounts.getBalance', 'accounts.transfer'],
  }],
  credential: {
    credentialType: "FIDO",
    status: "PENDING",
    payload: PublicKeyCredential
  }
}
end note
Switch - -> DFSP_LM: 202 Accepted
DFSP_LM -> DFSP_LM: this.saveToKVS()
deactivate DFSP_LM

Switch -> AUTH: POST /consents/1a2b3c4d
activate AUTH
AUTH - -> Switch: 202 Accepted
AUTH -> AUTH: Check consent.
AUTH -> Switch: PUT /consents/1a2b3c4d

rnote left of AUTH #LightBlue
PUT /consents/1a2b3c4d
FSIOP-Source: central-auth
FSIOP-Destination: dfspa
{
  scopes: [{
    accountId: 'dfspa.username.1234',
    actions: ['accounts.getBalance', 'accounts.transfer'],
    accountId: 'dfspa.username.5678',
    actions: ['accounts.getBalance', 'accounts.transfer'],
  }],
  credential: {
    credentialType: "FIDO",
    status: "VERIFIED",
    payload: PublicKeyCredential
  }
}
end note

Switch - -> AUTH: 200 OK
activate DFSP_TP_IN
Switch -> DFSP_TP_IN: PUT /consents/1a2b3c4d
DFSP_TP_IN -> DFSP_TP_IN: const model = await loadFromKVS({key: 1a2b3c4d})
DFSP_TP_IN -> DFSP_TP_IN: consentResponseRecieved()
rnote right of DFSP_TP_IN: state: consentResponseRecieved
DFSP_TP_IN -> DFSP_LM: Auth Service response recieved
activate DFSP_LM
DFSP_TP_IN - -> Switch: 200 OK
deactivate Switch
deactivate DFSP_TP_IN

AUTH -> ALS: POST /participants/CONSENTS/1a2b3c4d
activate ALS
ALS - -> AUTH: 202 Accepted
deactivate AUTH

ALS -> DFSP_TP_IN: PUT /participants/CONSENTS/1a2b3c4d
activate DFSP_TP_IN
DFSP_TP_IN -> DFSP_TP_IN: const model = await loadFromKVS({key: 1a2b3c4d})
DFSP_TP_IN -> DFSP_TP_IN: participantResponseRecieved()
rnote right of DFSP_TP_IN: state: participantsResponseRecieved
DFSP_TP_IN -> DFSP_LM: Participant response recieved
DFSP_TP_IN - -> ALS: 200 Accepted
deactivate ALS
deactivate DFSP_TP_IN
rnote right of DFSP_LM: state: consentRegisteredAndValidated
DFSP_LM -> DFSP_LM: model.finalizeConsent()

loop for each scope in ""Consents.scopes""
DFSP_LM -> Switch: POST /participants/THIRD_PARTY_LINK/dfsp.username.5678
Switch - -> DFSP_LM: 202 Accepted
Switch -> ALS: POST /participants/THIRD_PARTY_LINK/dfsp.username.5678
ALS - -> Switch: 202 Accepted
ALS -> Switch: PUT /participants/THIRD_PARTY_LINK/dfsp.username.5678
Switch - -> ALS: 200 OK
Switch -> DFSP_TP_IN: PUT /participants/THIRD_PARTY_LINK/dfsp.username.5678
DFSP_TP_IN - -> Switch: 200 OK
DFSP_TP_IN -> DFSP_LM: Participant response recieved
end

DFSP_LM -> DFSP_LM: await Promise.all()
DFSP_LM -> DFSP_LM: state: PISPDFSPLinkEstablished
DFSP_LM -> DFSP_LM: model.notifyVerificationToPISP()
DFSP_LM -> Switch: PATCH /consents/1a2b3c4d
rnote left of DFSP_LM #LightBlue
PATCH /consents/1a2b3c4d
FSIOP-Source: dfspa
FSIOP-Destination: pispa
{
  credential: {
    status: "VERIFIED"
  }
}
end note
activate Switch
Switch - -> DFSP_LM: 200 OK
deactivate DFSP_LM
Switch -> PISP_TP_IN: PATCH /consents/1a2b3c4d
activate PISP_TP_IN
PISP_TP_IN -> PISP_TP_IN: const model = await loadFromKVS({key: 1a2b3c4d})

activate PISP_LM
PISP_TP_IN -> PISP_LM: Verified Response recieved
PISP_TP_IN - -> Switch: 200 OK
deactivate PISP_TP_IN
deactivate Switch
rnote right of PISP_LM: state: accountsLinked
PISP_LM - -> PISP_TP_OUT: return Accounts linked response
deactivate PISP_LM
PISP_TP_OUT - -> PISP: 200 OK Accounts Linked
rnote left of PISP_TP_OUT #LightBlue
{
  credential: {
    status: "VERIFIED"
  }
  currentState="accountsLinked"
}
end note
@enduml

PlantUML version 1.2021.00(Sun Jan 10 05:25:05 EST 2021)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>