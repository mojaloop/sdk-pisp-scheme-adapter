<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1576px" preserveAspectRatio="none" style="width:3226px;height:1576px;" version="1.1" viewBox="0 0 3226 1576" width="3226px" zoomAndPan="magnify"><defs><filter height="300%" id="frjs5i3payu4c" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="441" x="1389.25" y="28.708">PISP Linking Error Scenarios Authentication Phase</text><rect fill="#DDDDDD" height="1529.8281" style="stroke:#A80036;stroke-width:1.0;" width="1064.5" x="482.5" y="40.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="180" x="924.75" y="53.02">PISP tp-scheme-adapter</text><rect fill="#DDDDDD" height="1529.8281" style="stroke:#A80036;stroke-width:1.0;" width="379" x="1841" y="40.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="67" x="1997" y="53.02">Mojaloop</text><rect fill="#DDDDDD" height="1529.8281" style="stroke:#A80036;stroke-width:1.0;" width="618" x="2222" y="40.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="186" x="2438" y="53.02">DFSP tp-scheme-adapter</text><rect fill="#FFFFFF" filter="url(#frjs5i3payu4c)" height="1311.7031" style="stroke:#A80036;stroke-width:1.0;" width="10" x="56.5" y="202.7813"/><rect fill="#FFFFFF" filter="url(#frjs5i3payu4c)" height="1311.7031" style="stroke:#A80036;stroke-width:1.0;" width="10" x="548.5" y="202.7813"/><rect fill="#FFFFFF" filter="url(#frjs5i3payu4c)" height="209.1953" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1024.5" y="385.7109"/><rect fill="#FFFFFF" filter="url(#frjs5i3payu4c)" height="62.2656" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1024.5" y="1423.0859"/><rect fill="#FFFFFF" filter="url(#frjs5i3payu4c)" height="58.2656" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1476.5" y="1364.8203"/><rect fill="#FFFFFF" filter="url(#frjs5i3payu4c)" height="196.1953" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1871.5" y="456.9766"/><rect fill="#FFFFFF" filter="url(#frjs5i3payu4c)" height="362.6563" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1871.5" y="1031.2969"/><rect fill="#FFFFFF" filter="url(#frjs5i3payu4c)" height="133.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2282.5" y="624.0391"/><rect fill="#FFFFFF" filter="url(#frjs5i3payu4c)" height="578.1172" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2758.5" y="757.5703"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="61" x2="61" y1="95.3828" y2="1532.4844"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="553.5" x2="553.5" y1="95.3828" y2="1532.4844"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1029.5" x2="1029.5" y1="95.3828" y2="1532.4844"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1481" x2="1481" y1="95.3828" y2="1532.4844"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1876" x2="1876" y1="95.3828" y2="1532.4844"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1970" x2="1970" y1="95.3828" y2="1532.4844"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="2124" x2="2124" y1="95.3828" y2="1532.4844"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="2287" x2="2287" y1="95.3828" y2="1532.4844"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="2763" x2="2763" y1="95.3828" y2="1532.4844"/><rect fill="#FEFECE" filter="url(#frjs5i3payu4c)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="109" x="5" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="95" x="12" y="80.0811">PISP Backend</text><rect fill="#FEFECE" filter="url(#frjs5i3payu4c)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="109" x="5" y="1531.4844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="95" x="12" y="1551.4795">PISP Backend</text><rect fill="#FEFECE" filter="url(#frjs5i3payu4c)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="130" x="486.5" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="116" x="493.5" y="80.0811">outbound-server</text><rect fill="#FEFECE" filter="url(#frjs5i3payu4c)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="130" x="486.5" y="1531.4844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="116" x="493.5" y="1551.4795">outbound-server</text><rect fill="#FEFECE" filter="url(#frjs5i3payu4c)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="134" x="960.5" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="120" x="967.5" y="80.0811">PISPLinkingModel</text><rect fill="#FEFECE" filter="url(#frjs5i3payu4c)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="134" x="960.5" y="1531.4844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="120" x="967.5" y="1551.4795">PISPLinkingModel</text><rect fill="#FEFECE" filter="url(#frjs5i3payu4c)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="119" x="1420" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="105" x="1427" y="80.0811">inbound-server</text><rect fill="#FEFECE" filter="url(#frjs5i3payu4c)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="119" x="1420" y="1531.4844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="105" x="1427" y="1551.4795">inbound-server</text><rect fill="#FEFECE" filter="url(#frjs5i3payu4c)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="59" x="1845" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="45" x="1852" y="80.0811">Switch</text><rect fill="#FEFECE" filter="url(#frjs5i3payu4c)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="59" x="1845" y="1531.4844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="45" x="1852" y="1551.4795">Switch</text><rect fill="#FEFECE" filter="url(#frjs5i3payu4c)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="100" x="1918" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="86" x="1925" y="80.0811">Auth Service</text><rect fill="#FEFECE" filter="url(#frjs5i3payu4c)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="100" x="1918" y="1531.4844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="86" x="1925" y="1551.4795">Auth Service</text><rect fill="#FEFECE" filter="url(#frjs5i3payu4c)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="180" x="2032" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="166" x="2039" y="80.0811">Account Lookup Service</text><rect fill="#FEFECE" filter="url(#frjs5i3payu4c)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="180" x="2032" y="1531.4844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="166" x="2039" y="1551.4795">Account Lookup Service</text><rect fill="#FEFECE" filter="url(#frjs5i3payu4c)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="119" x="2226" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="105" x="2233" y="80.0811">inbound-server</text><rect fill="#FEFECE" filter="url(#frjs5i3payu4c)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="119" x="2226" y="1531.4844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="105" x="2233" y="1551.4795">inbound-server</text><rect fill="#FEFECE" filter="url(#frjs5i3payu4c)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="141" x="2691" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="127" x="2698" y="80.0811">DFSPLinkingModel</text><rect fill="#FEFECE" filter="url(#frjs5i3payu4c)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="141" x="2691" y="1531.4844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="127" x="2698" y="1551.4795">DFSPLinkingModel</text><rect fill="#FFFFFF" filter="url(#frjs5i3payu4c)" height="1311.7031" style="stroke:#A80036;stroke-width:1.0;" width="10" x="56.5" y="202.7813"/><rect fill="#FFFFFF" filter="url(#frjs5i3payu4c)" height="1311.7031" style="stroke:#A80036;stroke-width:1.0;" width="10" x="548.5" y="202.7813"/><rect fill="#FFFFFF" filter="url(#frjs5i3payu4c)" height="209.1953" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1024.5" y="385.7109"/><rect fill="#FFFFFF" filter="url(#frjs5i3payu4c)" height="62.2656" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1024.5" y="1423.0859"/><rect fill="#FFFFFF" filter="url(#frjs5i3payu4c)" height="58.2656" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1476.5" y="1364.8203"/><rect fill="#FFFFFF" filter="url(#frjs5i3payu4c)" height="196.1953" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1871.5" y="456.9766"/><rect fill="#FFFFFF" filter="url(#frjs5i3payu4c)" height="362.6563" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1871.5" y="1031.2969"/><rect fill="#FFFFFF" filter="url(#frjs5i3payu4c)" height="133.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2282.5" y="624.0391"/><rect fill="#FFFFFF" filter="url(#frjs5i3payu4c)" height="578.1172" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2758.5" y="757.5703"/><rect fill="#EEEEEE" filter="url(#frjs5i3payu4c)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="3219.5" x="0" y="125.9492"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="3219.5" y1="125.9492" y2="125.9492"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="3219.5" y1="128.9492" y2="128.9492"/><rect fill="#EEEEEE" filter="url(#frjs5i3payu4c)" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="126" x="1546.75" y="115.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="107" x="1552.75" y="131.4497">Authentication</text><rect fill="#FBFB77" filter="url(#frjs5i3payu4c)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="503" x="66" y="153.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="495" x="70" y="169.5825">PISP has obtained authToken from end-user(OTP) or through a callback(Web).</text><polygon fill="#A80036" points="536.5,198.7813,546.5,202.7813,536.5,206.7813,540.5,202.7813" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="66.5" x2="542.5" y1="202.7813" y2="202.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="73.5" y="197.7153">AUTHENTICATION-1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="312" x="216.5" y="197.7153">POST /linking/request-consent/6789/authenticate</text><rect fill="#ADD8E6" filter="url(#frjs5i3payu4c)" height="68" style="stroke:#A80036;stroke-width:1.0;" width="320" x="71" y="215.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="312" x="75" y="231.8481">POST /linking/request-consent/6789/authenticate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="75" y="246.981">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="83" y="262.1138">authToken: '123456'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="75" y="277.2466">}</text><line style="stroke:#A80036;stroke-width:1.0;" x1="558.5" x2="600.5" y1="310.4453" y2="310.4453"/><line style="stroke:#A80036;stroke-width:1.0;" x1="600.5" x2="600.5" y1="310.4453" y2="323.4453"/><line style="stroke:#A80036;stroke-width:1.0;" x1="559.5" x2="600.5" y1="323.4453" y2="323.4453"/><polygon fill="#A80036" points="569.5,319.4453,559.5,323.4453,569.5,327.4453,565.5,323.4453" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="565.5" y="305.3794">AUTHENTICATION-2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="309" x="708.5" y="305.3794">const model = await loadFromKVS({key: 6789})</text><rect fill="#FBFB77" filter="url(#frjs5i3payu4c)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="648" x="563" y="336.4453"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="640" x="567" y="352.5122">state: webAuthenticationChannelResponseReceived or OTPAuthenticationChannelResponseReceived</text><polygon fill="#A80036" points="1012.5,381.7109,1022.5,385.7109,1012.5,389.7109,1016.5,385.7109" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="558.5" x2="1018.5" y1="385.7109" y2="385.7109"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="565.5" y="380.645">AUTHENTICATION-3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="708.5" y="380.645">model.authenticate()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1034.5" x2="1076.5" y1="414.8438" y2="414.8438"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1076.5" x2="1076.5" y1="414.8438" y2="427.8438"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1035.5" x2="1076.5" y1="427.8438" y2="427.8438"/><polygon fill="#A80036" points="1045.5,423.8438,1035.5,427.8438,1045.5,431.8438,1041.5,427.8438" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="1041.5" y="409.7778">AUTHENTICATION-4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="285" x="1184.5" y="409.7778">ThirdpartyRequests.patchConsentRequests()</text><polygon fill="#A80036" points="1859.5,452.9766,1869.5,456.9766,1859.5,460.9766,1863.5,456.9766" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1034.5" x2="1865.5" y1="456.9766" y2="456.9766"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="1041.5" y="451.9106">AUTHENTICATION-5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="197" x="1184.5" y="451.9106">PATCH /consentRequests/6789</text><rect fill="#ADD8E6" filter="url(#frjs5i3payu4c)" height="98" style="stroke:#A80036;stroke-width:1.0;" width="205" x="1039" y="469.9766"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="197" x="1043" y="486.0435">PATCH /consentRequests/6789</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="1043" y="501.1763">FSIOP-Source: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="1043" y="516.3091">FSIOP-Destination: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1043" y="531.4419">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="1051" y="546.5747">authToken: '124356'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1043" y="561.7075">}</text><polygon fill="#A80036" points="1040.5,590.9063,1030.5,594.9063,1040.5,598.9063,1036.5,594.9063" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1034.5" x2="1870.5" y1="594.9063" y2="594.9063"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="1046.5" y="589.8403">AUTHENTICATION-6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="1189.5" y="589.8403">202 Accepted</text><polygon fill="#A80036" points="2270.5,620.0391,2280.5,624.0391,2270.5,628.0391,2274.5,624.0391" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1881.5" x2="2276.5" y1="624.0391" y2="624.0391"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="1888.5" y="618.9731">AUTHENTICATION-7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="197" x="2031.5" y="618.9731">PATCH /consentRequests/6789</text><polygon fill="#A80036" points="1887.5,649.1719,1877.5,653.1719,1887.5,657.1719,1883.5,653.1719" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1881.5" x2="2281.5" y1="653.1719" y2="653.1719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="1893.5" y="648.106">AUTHENTICATION-8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2036.5" y="648.106">202 Accepted</text><line style="stroke:#A80036;stroke-width:1.0;" x1="2292.5" x2="2334.5" y1="682.3047" y2="682.3047"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2334.5" x2="2334.5" y1="682.3047" y2="695.3047"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2293.5" x2="2334.5" y1="695.3047" y2="695.3047"/><polygon fill="#A80036" points="2303.5,691.3047,2293.5,695.3047,2303.5,699.3047,2299.5,695.3047" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="2299.5" y="677.2388">AUTHENTICATION-9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="309" x="2442.5" y="677.2388">const model = await loadFromKVS({key: 6789})</text><rect fill="#FBFB77" filter="url(#frjs5i3payu4c)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="280" x="2297" y="708.3047"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="272" x="2301" y="724.3716">state: consentRequestValidatedAndStored</text><polygon fill="#A80036" points="2746.5,753.5703,2756.5,757.5703,2746.5,761.5703,2750.5,757.5703" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2287.5" x2="2752.5" y1="757.5703" y2="757.5703"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2294.5" y="752.5044">AUTHENTICATION-10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="172" x="2446.5" y="752.5044">model.validateAuthToken()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="2768.5" x2="2810.5" y1="786.7031" y2="786.7031"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2810.5" x2="2810.5" y1="786.7031" y2="799.7031"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2769.5" x2="2810.5" y1="799.7031" y2="799.7031"/><polygon fill="#A80036" points="2779.5,795.7031,2769.5,799.7031,2779.5,803.7031,2775.5,799.7031" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2775.5" y="781.6372">AUTHENTICATION-11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="280" x="2927.5" y="781.6372">DFSPBackendRequests.validateAuthToken()</text><rect fill="#ADD8E6" filter="url(#frjs5i3payu4c)" height="159" style="stroke:#A80036;stroke-width:1.0;" width="416" x="2773" y="812.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="312" x="2777" y="828.77">Do we need two backend endpoints for validating</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="408" x="2777" y="843.9028">web authTokens and OTP authTokens? Or is a DFSP expected to</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="248" x="2777" y="859.0356">validate both cases with one endpoint?</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="0" x="2781" y="874.1685"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="160" x="2777" y="889.3013">POST /validateAuthToken</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2777" y="904.4341">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="160" x="2785" y="919.5669">consentRequestId: '6789'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="251" x="2785" y="934.6997">authChannel: model.data.authChannel,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="2785" y="949.8325">authToken: '124356'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2777" y="964.9653">}</text><rect fill="#FBFB77" filter="url(#frjs5i3payu4c)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="96" x="2773" y="982.0313"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2777" y="998.0981">state: errored</text><polygon fill="#A80036" points="1892.5,1027.2969,1882.5,1031.2969,1892.5,1035.2969,1888.5,1031.2969" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1886.5" x2="2757.5" y1="1031.2969" y2="1031.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1898.5" y="1026.231">AUTHENTICATION-12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="214" x="2050.5" y="1026.231">PUT /consentRequests/6789/error</text><rect fill="#F08080" filter="url(#frjs5i3payu4c)" height="265" style="stroke:#A80036;stroke-width:1.0;" width="392" x="2361" y="1044.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="214" x="2365" y="1060.3638">PUT /consentRequests/6789/error</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="130" x="2365" y="1075.4966">FSIOP-Source: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="157" x="2365" y="1090.6294">FSIOP-Destination: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2365" y="1105.7622">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="120" x="2373" y="1120.895">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="2381" y="1136.0278">errorCode: '7200',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="368" x="2381" y="1151.1606">errorDescription: 'Generic Thirdparty account linking error'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="30" x="2373" y="1166.2935">} OR</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="120" x="2373" y="1181.4263">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="2381" y="1196.5591">errorCode: '7205',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="245" x="2381" y="1211.6919">errorDescription: 'OTP failed validation'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="30" x="2373" y="1226.8247">} OR</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="120" x="2373" y="1241.9575">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="2381" y="1257.0903">errorCode: '7206',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="279" x="2381" y="1272.2231">errorDescription: 'FSP failed to validate OTP'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2373" y="1287.356">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2365" y="1302.4888">}</text><polygon fill="#A80036" points="2751.5,1331.6875,2761.5,1335.6875,2751.5,1339.6875,2755.5,1335.6875" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1881.5" x2="2757.5" y1="1335.6875" y2="1335.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1888.5" y="1330.6216">AUTHENTICATION-13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="2040.5" y="1330.6216">200 OK</text><polygon fill="#A80036" points="1497.5,1360.8203,1487.5,1364.8203,1497.5,1368.8203,1493.5,1364.8203" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1491.5" x2="1870.5" y1="1364.8203" y2="1364.8203"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1503.5" y="1359.7544">AUTHENTICATION-14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="214" x="1655.5" y="1359.7544">PUT /consentRequests/6789/error</text><polygon fill="#A80036" points="1864.5,1389.9531,1874.5,1393.9531,1864.5,1397.9531,1868.5,1393.9531" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1486.5" x2="1870.5" y1="1393.9531" y2="1393.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1493.5" y="1388.8872">AUTHENTICATION-15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="1645.5" y="1388.8872">200 OK</text><polygon fill="#A80036" points="1045.5,1419.0859,1035.5,1423.0859,1045.5,1427.0859,1041.5,1423.0859" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1039.5" x2="1480.5" y1="1423.0859" y2="1423.0859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1051.5" y="1418.02">AUTHENTICATION-16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="254" x="1203.5" y="1418.02">MojaloopFSPIOPError response received</text><rect fill="#FBFB77" filter="url(#frjs5i3payu4c)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="96" x="1039" y="1436.0859"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="1043" y="1452.1528">state: errored</text><polygon fill="#A80036" points="569.5,1481.3516,559.5,1485.3516,569.5,1489.3516,565.5,1485.3516" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="563.5" x2="1028.5" y1="1485.3516" y2="1485.3516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="575.5" y="1480.2856">AUTHENTICATION-17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="176" x="727.5" y="1480.2856">return MojaloopFSPIOPError</text><polygon fill="#A80036" points="72.5,1510.4844,62.5,1514.4844,72.5,1518.4844,68.5,1514.4844" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="66.5" x2="552.5" y1="1514.4844" y2="1514.4844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="78.5" y="1509.4185">AUTHENTICATION-18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="306" x="230.5" y="1509.4185">500 Internal Server Error ErrorInformationObject</text><!--MD5=[86412c18c27051d9d3f27a3d094c9363]
@startuml

title PISP Linking Error Scenarios Authentication Phase

participant "PISP Backend" as PISP
box "PISP tp-scheme-adapter"
  participant "outbound-server" as PISP_TP_OUT
  participant "PISPLinkingModel" as PISP_LM
  participant "inbound-server" as PISP_TP_IN
end box
box "Mojaloop"
    participant Switch
    participant "Auth Service" as AUTH
    participant "Account Lookup Service" as ALS
end box
box "DFSP tp-scheme-adapter"
  participant "inbound-server" as DFSP_TP_IN
  participant "DFSPLinkingModel" as DFSP_LM
end box

== Authentication ==
autonumber 1 "<b>AUTHENTICATION-#</b>"
rnote right of PISP
PISP has obtained authToken from end-user(OTP) or through a callback(Web).
end note
PISP -> PISP_TP_OUT: POST /linking/request-consent/6789/authenticate
rnote right of PISP #LightBlue
POST /linking/request-consent/6789/authenticate
{
  authToken: '123456'
}
end note

activate PISP
activate PISP_TP_OUT

PISP_TP_OUT -> PISP_TP_OUT: const model = await loadFromKVS({key: 6789})
rnote right of PISP_TP_OUT: state: webAuthenticationChannelResponseReceived or OTPAuthenticationChannelResponseReceived
PISP_TP_OUT -> PISP_LM: model.authenticate()

activate PISP_LM

PISP_LM -> PISP_LM: ThirdpartyRequests.patchConsentRequests()
PISP_LM -> Switch: PATCH /consentRequests/6789
rnote right of PISP_LM #LightBlue
PATCH /consentRequests/6789
FSIOP-Source: pispa
FSIOP-Destination: dfspa
{
  authToken: '124356'
}
end note

activate Switch
Switch - -> PISP_LM: 202 Accepted
deactivate PISP_LM
Switch -> DFSP_TP_IN: PATCH /consentRequests/6789
activate DFSP_TP_IN
DFSP_TP_IN - -> Switch: 202 Accepted
deactivate Switch
DFSP_TP_IN -> DFSP_TP_IN: const model = await loadFromKVS({key: 6789})
rnote right of DFSP_TP_IN: state: consentRequestValidatedAndStored
DFSP_TP_IN -> DFSP_LM: model.validateAuthToken()
deactivate DFSP_TP_IN
activate DFSP_LM

DFSP_LM -> DFSP_LM: DFSPBackendRequests.validateAuthToken()
rnote right of DFSP_LM #LightBlue
Do we need two backend endpoints for validating
web authTokens and OTP authTokens? Or is a DFSP expected to
validate both cases with one endpoint?

POST /validateAuthToken
{
  consentRequestId: '6789'
  authChannel: model.data.authChannel,
  authToken: '124356'
}
end note
rnote right of DFSP_LM: state: errored
DFSP_LM -> Switch: PUT /consentRequests/6789/error
activate Switch

rnote left of DFSP_LM #LightCoral
PUT /consentRequests/6789/error
FSIOP-Source: dfspa
FSIOP-Destination: pispa
{
  errorInformation: {
    errorCode: '7200',
    errorDescription: 'Generic Thirdparty account linking error'
  } OR
  errorInformation: {
    errorCode: '7205',
    errorDescription: 'OTP failed validation'
  } OR
  errorInformation: {
    errorCode: '7206',
    errorDescription: 'FSP failed to validate OTP'
  }
}
end note
Switch - -> DFSP_LM: 200 OK
deactivate DFSP_LM
Switch ->  PISP_TP_IN: PUT /consentRequests/6789/error
activate PISP_TP_IN
PISP_TP_IN - -> Switch: 200 OK
deactivate Switch
PISP_TP_IN - -> PISP_LM: MojaloopFSPIOPError response received
deactivate PISP_TP_IN
activate PISP_LM
rnote right of PISP_LM: state: errored
PISP_LM -> PISP_TP_OUT: return MojaloopFSPIOPError
deactivate PISP_LM
PISP_TP_OUT - -> PISP: 500 Internal Server Error ErrorInformationObject
deactivate PISP_TP_OUT
deactivate PISP

@enduml

PlantUML version 1.2021.00(Sun Jan 10 05:25:05 EST 2021)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>