<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1797px" preserveAspectRatio="none" style="width:3123px;height:1797px;" version="1.1" viewBox="0 0 3123 1797" width="3123px" zoomAndPan="magnify"><defs><filter height="300%" id="far92kq3b1i0b" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="524" x="1296.25" y="28.708">PISP Linking Web Error Scenarios (Request Consent Phase)</text><rect fill="#DDDDDD" height="1750.4219" style="stroke:#A80036;stroke-width:1.0;" width="973.5" x="497.5" y="40.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="180" x="894.25" y="53.02">PISP tp-scheme-adapter</text><rect fill="#DDDDDD" height="1750.4219" style="stroke:#A80036;stroke-width:1.0;" width="379" x="1785" y="40.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="67" x="1941" y="53.02">Mojaloop</text><rect fill="#DDDDDD" height="1750.4219" style="stroke:#A80036;stroke-width:1.0;" width="519" x="2166" y="40.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="186" x="2332.5" y="53.02">DFSP tp-scheme-adapter</text><rect fill="#FFFFFF" filter="url(#far92kq3b1i0b)" height="1532.2969" style="stroke:#A80036;stroke-width:1.0;" width="10" x="56.5" y="202.7813"/><rect fill="#FFFFFF" filter="url(#far92kq3b1i0b)" height="1532.2969" style="stroke:#A80036;stroke-width:1.0;" width="10" x="563.5" y="202.7813"/><rect fill="#FFFFFF" filter="url(#far92kq3b1i0b)" height="1297.8359" style="stroke:#A80036;stroke-width:1.0;" width="10" x="940.5" y="446.2422"/><rect fill="#FFFFFF" filter="url(#far92kq3b1i0b)" height="91.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="945.5" y="1614.5469"/><rect fill="#FFFFFF" filter="url(#far92kq3b1i0b)" height="87.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1400.5" y="1556.2813"/><rect fill="#FFFFFF" filter="url(#far92kq3b1i0b)" height="192.6641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1815.5" y="833.7656"/><rect fill="#FFFFFF" filter="url(#far92kq3b1i0b)" height="483.7188" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1815.5" y="1130.8281"/><rect fill="#FFFFFF" filter="url(#far92kq3b1i0b)" height="163.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2226.5" y="862.8984"/><rect fill="#FFFFFF" filter="url(#far92kq3b1i0b)" height="559.8516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2603.5" y="996.4297"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="61" x2="61" y1="95.3828" y2="1753.0781"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="568.5" x2="568.5" y1="95.3828" y2="1753.0781"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="945.5" x2="945.5" y1="95.3828" y2="1753.0781"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1405" x2="1405" y1="95.3828" y2="1753.0781"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1820" x2="1820" y1="95.3828" y2="1753.0781"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1914" x2="1914" y1="95.3828" y2="1753.0781"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="2068" x2="2068" y1="95.3828" y2="1753.0781"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="2231" x2="2231" y1="95.3828" y2="1753.0781"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="2608" x2="2608" y1="95.3828" y2="1753.0781"/><rect fill="#FEFECE" filter="url(#far92kq3b1i0b)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="109" x="5" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="95" x="12" y="80.0811">PISP Backend</text><rect fill="#FEFECE" filter="url(#far92kq3b1i0b)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="109" x="5" y="1752.0781"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="95" x="12" y="1772.0732">PISP Backend</text><rect fill="#FEFECE" filter="url(#far92kq3b1i0b)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="130" x="501.5" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="116" x="508.5" y="80.0811">outbound-server</text><rect fill="#FEFECE" filter="url(#far92kq3b1i0b)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="130" x="501.5" y="1752.0781"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="116" x="508.5" y="1772.0732">outbound-server</text><rect fill="#FEFECE" filter="url(#far92kq3b1i0b)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="134" x="876.5" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="120" x="883.5" y="80.0811">PISPLinkingModel</text><rect fill="#FEFECE" filter="url(#far92kq3b1i0b)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="134" x="876.5" y="1752.0781"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="120" x="883.5" y="1772.0732">PISPLinkingModel</text><rect fill="#FEFECE" filter="url(#far92kq3b1i0b)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="119" x="1344" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="105" x="1351" y="80.0811">inbound-server</text><rect fill="#FEFECE" filter="url(#far92kq3b1i0b)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="119" x="1344" y="1752.0781"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="105" x="1351" y="1772.0732">inbound-server</text><rect fill="#FEFECE" filter="url(#far92kq3b1i0b)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="59" x="1789" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="45" x="1796" y="80.0811">Switch</text><rect fill="#FEFECE" filter="url(#far92kq3b1i0b)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="59" x="1789" y="1752.0781"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="45" x="1796" y="1772.0732">Switch</text><rect fill="#FEFECE" filter="url(#far92kq3b1i0b)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="100" x="1862" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="86" x="1869" y="80.0811">Auth Service</text><rect fill="#FEFECE" filter="url(#far92kq3b1i0b)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="100" x="1862" y="1752.0781"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="86" x="1869" y="1772.0732">Auth Service</text><rect fill="#FEFECE" filter="url(#far92kq3b1i0b)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="180" x="1976" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="166" x="1983" y="80.0811">Account Lookup Service</text><rect fill="#FEFECE" filter="url(#far92kq3b1i0b)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="180" x="1976" y="1752.0781"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="166" x="1983" y="1772.0732">Account Lookup Service</text><rect fill="#FEFECE" filter="url(#far92kq3b1i0b)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="119" x="2170" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="105" x="2177" y="80.0811">inbound-server</text><rect fill="#FEFECE" filter="url(#far92kq3b1i0b)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="119" x="2170" y="1752.0781"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="105" x="2177" y="1772.0732">inbound-server</text><rect fill="#FEFECE" filter="url(#far92kq3b1i0b)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="141" x="2536" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="127" x="2543" y="80.0811">DFSPLinkingModel</text><rect fill="#FEFECE" filter="url(#far92kq3b1i0b)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="141" x="2536" y="1752.0781"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="127" x="2543" y="1772.0732">DFSPLinkingModel</text><rect fill="#FFFFFF" filter="url(#far92kq3b1i0b)" height="1532.2969" style="stroke:#A80036;stroke-width:1.0;" width="10" x="56.5" y="202.7813"/><rect fill="#FFFFFF" filter="url(#far92kq3b1i0b)" height="1532.2969" style="stroke:#A80036;stroke-width:1.0;" width="10" x="563.5" y="202.7813"/><rect fill="#FFFFFF" filter="url(#far92kq3b1i0b)" height="1297.8359" style="stroke:#A80036;stroke-width:1.0;" width="10" x="940.5" y="446.2422"/><rect fill="#FFFFFF" filter="url(#far92kq3b1i0b)" height="91.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="945.5" y="1614.5469"/><rect fill="#FFFFFF" filter="url(#far92kq3b1i0b)" height="87.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1400.5" y="1556.2813"/><rect fill="#FFFFFF" filter="url(#far92kq3b1i0b)" height="192.6641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1815.5" y="833.7656"/><rect fill="#FFFFFF" filter="url(#far92kq3b1i0b)" height="483.7188" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1815.5" y="1130.8281"/><rect fill="#FFFFFF" filter="url(#far92kq3b1i0b)" height="163.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2226.5" y="862.8984"/><rect fill="#FFFFFF" filter="url(#far92kq3b1i0b)" height="559.8516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2603.5" y="996.4297"/><rect fill="#EEEEEE" filter="url(#far92kq3b1i0b)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="3116.5" x="0" y="125.9492"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="3116.5" y1="125.9492" y2="125.9492"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="3116.5" y1="128.9492" y2="128.9492"/><rect fill="#EEEEEE" filter="url(#far92kq3b1i0b)" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="193" x="1461.75" y="115.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="174" x="1467.75" y="131.4497">Request Consent - Web</text><rect fill="#FBFB77" filter="url(#far92kq3b1i0b)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="485" x="66" y="153.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="477" x="70" y="169.5825">PISP presents accounts to user. User selects one or more accounts to link.</text><polygon fill="#A80036" points="551.5,198.7813,561.5,202.7813,551.5,206.7813,555.5,202.7813" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="66.5" x2="557.5" y1="202.7813" y2="202.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="73.5" y="197.7153">REQUEST-CONSENT-1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="231.5" y="197.7153">POST /linking/request-consent</text><rect fill="#ADD8E6" filter="url(#far92kq3b1i0b)" height="129" style="stroke:#A80036;stroke-width:1.0;" width="570" x="71" y="215.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="75" y="231.8481">POST /linking/request-consent</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="75" y="246.981">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="83" y="262.1138">accounts: [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="507" x="91" y="277.2466">{ accountNickname: "XXXXXXnt", id: "dfspa.username.1234", currency: "ZAR" },</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="546" x="91" y="292.3794">{ accountNickname: "SpeXXXXXXXXnt", id: "dfspa.username.5678", currency: "USD" }</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="9" x="83" y="307.5122">],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="204" x="83" y="322.645">callbackURI: 'pisp-app://callback'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="75" y="337.7778">}</text><line style="stroke:#A80036;stroke-width:1.0;" x1="573.5" x2="615.5" y1="370.9766" y2="370.9766"/><line style="stroke:#A80036;stroke-width:1.0;" x1="615.5" x2="615.5" y1="370.9766" y2="383.9766"/><line style="stroke:#A80036;stroke-width:1.0;" x1="574.5" x2="615.5" y1="383.9766" y2="383.9766"/><polygon fill="#A80036" points="584.5,379.9766,574.5,383.9766,584.5,387.9766,580.5,383.9766" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="580.5" y="365.9106">REQUEST-CONSENT-2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="186" x="738.5" y="365.9106">const model = await create()</text><rect fill="#FBFB77" filter="url(#far92kq3b1i0b)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="79" x="578" y="396.9766"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="582" y="413.0435">state: start</text><polygon fill="#A80036" points="928.5,442.2422,938.5,446.2422,928.5,450.2422,932.5,446.2422" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="573.5" x2="934.5" y1="446.2422" y2="446.2422"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="580.5" y="441.1763">REQUEST-CONSENT-3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="156" x="738.5" y="441.1763">model.requestConsent()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="950.5" x2="992.5" y1="475.375" y2="475.375"/><line style="stroke:#A80036;stroke-width:1.0;" x1="992.5" x2="992.5" y1="475.375" y2="488.375"/><line style="stroke:#A80036;stroke-width:1.0;" x1="951.5" x2="992.5" y1="488.375" y2="488.375"/><polygon fill="#A80036" points="961.5,484.375,951.5,488.375,961.5,492.375,957.5,488.375" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="957.5" y="470.3091">REQUEST-CONSENT-4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="277" x="1115.5" y="470.3091">ThirdpartyRequests.postConsentRequests()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="950.5" x2="992.5" y1="517.5078" y2="517.5078"/><line style="stroke:#A80036;stroke-width:1.0;" x1="992.5" x2="992.5" y1="517.5078" y2="530.5078"/><line style="stroke:#A80036;stroke-width:1.0;" x1="951.5" x2="992.5" y1="530.5078" y2="530.5078"/><polygon fill="#A80036" points="961.5,526.5078,951.5,530.5078,961.5,534.5078,957.5,530.5078" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="957.5" y="512.4419">REQUEST-CONSENT-5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="209" x="1115.5" y="512.4419">const consentRequestId = uuid()</text><polygon fill="#A80036" points="1808.5,555.6406,1818.5,559.6406,1808.5,563.6406,1812.5,559.6406" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="950.5" x2="1814.5" y1="559.6406" y2="559.6406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="957.5" y="554.5747">REQUEST-CONSENT-6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="152" x="1115.5" y="554.5747">POST /consentRequests</text><rect fill="#ADD8E6" filter="url(#far92kq3b1i0b)" height="234" style="stroke:#A80036;stroke-width:1.0;" width="358" x="955" y="572.6406"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="152" x="959" y="588.7075">POST /consentRequests</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="959" y="603.8403">FSIOP-Source: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="959" y="618.9731">FSIOP-Destination: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="959" y="634.106">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154" x="967" y="649.2388">consentRequestId: 6789</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66" x="967" y="664.3716">scopes: [{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="975" y="679.5044">accountId: 'dfspa.username.1234',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="975" y="694.6372">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="975" y="709.77">accountId: 'dfspa.username.5678',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="975" y="724.9028">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="17" x="967" y="740.0356">}],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="208" x="967" y="755.1685">// model will add `authChannels`</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="967" y="770.3013">authChannels: ["WEB", "OTP"],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="216" x="967" y="785.4341">callbackURI: 'pisp-app://callback...'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="959" y="800.5669">}</text><polygon fill="#A80036" points="961.5,829.7656,951.5,833.7656,961.5,837.7656,957.5,833.7656" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="955.5" x2="1814.5" y1="833.7656" y2="833.7656"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="967.5" y="828.6997">REQUEST-CONSENT-7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="1125.5" y="828.6997">202 Accepted</text><polygon fill="#A80036" points="2214.5,858.8984,2224.5,862.8984,2214.5,866.8984,2218.5,862.8984" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1825.5" x2="2220.5" y1="862.8984" y2="862.8984"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="1832.5" y="857.8325">REQUEST-CONSENT-8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="152" x="1990.5" y="857.8325">POST /consentRequests</text><polygon fill="#A80036" points="1836.5,888.0313,1826.5,892.0313,1836.5,896.0313,1832.5,892.0313" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1830.5" x2="2225.5" y1="892.0313" y2="892.0313"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="1842.5" y="886.9653">REQUEST-CONSENT-9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2000.5" y="886.9653">202 Accepted</text><line style="stroke:#A80036;stroke-width:1.0;" x1="2236.5" x2="2278.5" y1="921.1641" y2="921.1641"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2278.5" x2="2278.5" y1="921.1641" y2="934.1641"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2237.5" x2="2278.5" y1="934.1641" y2="934.1641"/><polygon fill="#A80036" points="2247.5,930.1641,2237.5,934.1641,2247.5,938.1641,2243.5,934.1641" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="2243.5" y="916.0981">REQUEST-CONSENT-10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="186" x="2410.5" y="916.0981">const model = await create()</text><rect fill="#FBFB77" filter="url(#far92kq3b1i0b)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="79" x="2241" y="947.1641"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="2245" y="963.231">state: start</text><polygon fill="#A80036" points="2591.5,992.4297,2601.5,996.4297,2591.5,1000.4297,2595.5,996.4297" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2236.5" x2="2597.5" y1="996.4297" y2="996.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="2243.5" y="991.3638">REQUEST-CONSENT-11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="156" x="2410.5" y="991.3638">model.requestConsent()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="2613.5" x2="2655.5" y1="1055.5625" y2="1055.5625"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2655.5" x2="2655.5" y1="1055.5625" y2="1068.5625"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2614.5" x2="2655.5" y1="1068.5625" y2="1068.5625"/><polygon fill="#A80036" points="2624.5,1064.5625,2614.5,1068.5625,2624.5,1072.5625,2620.5,1068.5625" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="2620.5" y="1050.4966">REQUEST-CONSENT-12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="317" x="2787.5" y="1050.4966">DFSPBackendRequests.validateConsentRequest()</text><rect fill="#FBFB77" filter="url(#far92kq3b1i0b)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="96" x="2618" y="1081.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2622" y="1097.6294">state: errored</text><polygon fill="#A80036" points="1836.5,1126.8281,1826.5,1130.8281,1836.5,1134.8281,1832.5,1130.8281" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1830.5" x2="2602.5" y1="1130.8281" y2="1130.8281"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1842.5" y="1125.7622">REQUEST-CONSENT-13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="214" x="2009.5" y="1125.7622">PUT /consentRequests/6789/error</text><rect fill="#F08080" filter="url(#far92kq3b1i0b)" height="386" style="stroke:#A80036;stroke-width:1.0;" width="531" x="2067" y="1143.8281"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="214" x="2071" y="1159.895">PUT /consentRequests/6789/error</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="130" x="2071" y="1175.0278">FSIOP-Source: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="157" x="2071" y="1190.1606">FSIOP-Destination: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2071" y="1205.2935">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="120" x="2079" y="1220.4263">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="2087" y="1235.5591">errorCode: '7200',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="368" x="2087" y="1250.6919">errorDescription: 'Generic Thirdparty account linking error'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="30" x="2079" y="1265.8247">} OR</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="120" x="2079" y="1280.9575">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="2087" y="1296.0903">errorCode: '7203',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="507" x="2087" y="1311.2231">errorDescription: 'FSP does not support any requested authentication channels'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="30" x="2079" y="1326.356">} OR</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="120" x="2079" y="1341.4888">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="2087" y="1356.6216">errorCode: '7204',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="442" x="2087" y="1371.7544">errorDescription: 'FSP does not support any requested scope actions'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="30" x="2079" y="1386.8872">} OR</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="120" x="2079" y="1402.02">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="2087" y="1417.1528">errorCode: '7209',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="331" x="2087" y="1432.2856">errorDescription: 'FSP does not find scopes suitable'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="30" x="2079" y="1447.4185">} OR</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="120" x="2079" y="1462.5513">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="2087" y="1477.6841">errorCode: '7210',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="347" x="2087" y="1492.8169">errorDescription: 'FSP does not trust PISP callback URI'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2079" y="1507.9497">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2071" y="1523.0825">}</text><polygon fill="#A80036" points="2596.5,1552.2813,2606.5,1556.2813,2596.5,1560.2813,2600.5,1556.2813" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1825.5" x2="2602.5" y1="1556.2813" y2="1556.2813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1832.5" y="1551.2153">REQUEST-CONSENT-14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="1999.5" y="1551.2153">200 OK</text><polygon fill="#A80036" points="1421.5,1581.4141,1411.5,1585.4141,1421.5,1589.4141,1417.5,1585.4141" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1415.5" x2="1814.5" y1="1585.4141" y2="1585.4141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1427.5" y="1580.3481">REQUEST-CONSENT-15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="214" x="1594.5" y="1580.3481">PUT /consentRequests/6789/error</text><polygon fill="#A80036" points="1808.5,1610.5469,1818.5,1614.5469,1808.5,1618.5469,1812.5,1614.5469" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1410.5" x2="1814.5" y1="1614.5469" y2="1614.5469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1417.5" y="1609.481">REQUEST-CONSENT-16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="1584.5" y="1609.481">200 OK</text><polygon fill="#A80036" points="966.5,1639.6797,956.5,1643.6797,966.5,1647.6797,962.5,1643.6797" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="960.5" x2="1404.5" y1="1643.6797" y2="1643.6797"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="972.5" y="1638.6138">REQUEST-CONSENT-17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="254" x="1139.5" y="1638.6138">MojaloopFSPIOPError response recieved</text><rect fill="#FBFB77" filter="url(#far92kq3b1i0b)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="96" x="960" y="1656.6797"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="964" y="1672.7466">state: errored</text><polygon fill="#A80036" points="584.5,1701.9453,574.5,1705.9453,584.5,1709.9453,580.5,1705.9453" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="578.5" x2="939.5" y1="1705.9453" y2="1705.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="590.5" y="1700.8794">REQUEST-CONSENT-18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="176" x="757.5" y="1700.8794">return MojaloopFSPIOPError</text><polygon fill="#A80036" points="72.5,1731.0781,62.5,1735.0781,72.5,1739.0781,68.5,1735.0781" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="66.5" x2="567.5" y1="1735.0781" y2="1735.0781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="78.5" y="1730.0122">REQUEST-CONSENT-19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="306" x="245.5" y="1730.0122">500 Internal Server Error ErrorInformationObject</text><!--MD5=[802c3dbfeadbab8873633955867f542e]
@startuml

title PISP Linking Web Error Scenarios (Request Consent Phase)

participant "PISP Backend" as PISP
box "PISP tp-scheme-adapter"
  participant "outbound-server" as PISP_TP_OUT
  participant "PISPLinkingModel" as PISP_LM
  participant "inbound-server" as PISP_TP_IN
end box
box "Mojaloop"
    participant Switch
    participant "Auth Service" as AUTH
    participant "Account Lookup Service" as ALS
end box
box "DFSP tp-scheme-adapter"
  participant "inbound-server" as DFSP_TP_IN
  participant "DFSPLinkingModel" as DFSP_LM
end box

== Request Consent - Web ==
autonumber 1 "<b>REQUEST-CONSENT-#</b>"
rnote right of PISP
PISP presents accounts to user. User selects one or more accounts to link.
end note
PISP -> PISP_TP_OUT: POST /linking/request-consent
rnote right of PISP #LightBlue
POST /linking/request-consent
{
  accounts: [
    { accountNickname: "XXXXXXnt", id: "dfspa.username.1234", currency: "ZAR" },
    { accountNickname: "SpeXXXXXXXXnt", id: "dfspa.username.5678", currency: "USD" }
  ],
  callbackURI: 'pisp-app://callback'
}
end note


activate PISP
activate PISP_TP_OUT

PISP_TP_OUT -> PISP_TP_OUT: const model = await create()
rnote right of PISP_TP_OUT: state: start
PISP_TP_OUT -> PISP_LM: model.requestConsent()

activate PISP_LM

PISP_LM -> PISP_LM: ThirdpartyRequests.postConsentRequests()
PISP_LM -> PISP_LM: const consentRequestId = uuid()
PISP_LM -> Switch: POST /consentRequests
rnote right of PISP_LM #LightBlue
POST /consentRequests
FSIOP-Source: pispa
FSIOP-Destination: dfspa
{
  consentRequestId: 6789
  scopes: [{
    accountId: 'dfspa.username.1234',
    actions: ['accounts.getBalance', 'accounts.transfer'],
    accountId: 'dfspa.username.5678',
    actions: ['accounts.getBalance', 'accounts.transfer'],
  }],
  // model will add `authChannels`
  authChannels: ["WEB", "OTP"],
  callbackURI: 'pisp-app://callback...'
}
end note

Switch - -> PISP_LM: 202 Accepted
activate Switch
Switch -> DFSP_TP_IN: POST /consentRequests
activate DFSP_TP_IN

DFSP_TP_IN - -> Switch: 202 Accepted
DFSP_TP_IN -> DFSP_TP_IN: const model = await create()
rnote right of DFSP_TP_IN: state: start
DFSP_TP_IN -> DFSP_LM: model.requestConsent()
activate DFSP_LM
deactivate Switch
deactivate DFSP_TP_IN
DFSP_LM -> DFSP_LM: DFSPBackendRequests.validateConsentRequest()
rnote right of DFSP_LM: state: errored
DFSP_LM -> Switch: PUT /consentRequests/6789/error
activate Switch

rnote left of DFSP_LM #LightCoral
PUT /consentRequests/6789/error
FSIOP-Source: dfspa
FSIOP-Destination: pispa
{
  errorInformation: {
    errorCode: '7200',
    errorDescription: 'Generic Thirdparty account linking error'
  } OR
  errorInformation: {
    errorCode: '7203',
    errorDescription: 'FSP does not support any requested authentication channels'
  } OR
  errorInformation: {
    errorCode: '7204',
    errorDescription: 'FSP does not support any requested scope actions'
  } OR
  errorInformation: {
    errorCode: '7209',
    errorDescription: 'FSP does not find scopes suitable'
  } OR
  errorInformation: {
    errorCode: '7210',
    errorDescription: 'FSP does not trust PISP callback URI'
  }
}
end note
Switch - -> DFSP_LM: 200 OK
deactivate DFSP_LM
activate PISP_TP_IN
deactivate DFSP_LM
Switch ->  PISP_TP_IN: PUT /consentRequests/6789/error
PISP_TP_IN - -> Switch: 200 OK
deactivate Switch
activate PISP_LM
PISP_TP_IN - -> PISP_LM: MojaloopFSPIOPError response recieved
rnote right of PISP_LM: state: errored
deactivate PISP_TP_IN
PISP_LM -> PISP_TP_OUT: return MojaloopFSPIOPError
deactivate PISP_LM
PISP_TP_OUT - -> PISP: 500 Internal Server Error ErrorInformationObject
deactivate PISP_TP_OUT
deactivate PISP

@enduml

PlantUML version 1.2021.00(Sun Jan 10 05:25:05 EST 2021)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>