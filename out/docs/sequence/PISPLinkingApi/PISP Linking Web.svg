<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="6865px" preserveAspectRatio="none" style="width:4691px;height:6865px;" version="1.1" viewBox="0 0 4691 6865" width="4691px" zoomAndPan="magnify"><defs><filter height="300%" id="fbd4m1bjrz3h2" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="155" x="2264.75" y="28.708">PISP Linking Web</text><rect fill="#DDDDDD" height="6818.1172" style="stroke:#A80036;stroke-width:1.0;" width="1127.5" x="484.5" y="40.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="180" x="958.25" y="53.02">PISP tp-scheme-adapter</text><rect fill="#DDDDDD" height="6818.1172" style="stroke:#A80036;stroke-width:1.0;" width="920.5" x="2027" y="40.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="67" x="2453.75" y="53.02">Mojaloop</text><rect fill="#DDDDDD" height="6818.1172" style="stroke:#A80036;stroke-width:1.0;" width="658" x="3218" y="40.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="186" x="3454" y="53.02">DFSP tp-scheme-adapter</text><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="1553.7656" style="stroke:#A80036;stroke-width:1.0;" width="10" x="71.5" y="202.7813"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="4650.5703" style="stroke:#A80036;stroke-width:1.0;" width="10" x="71.5" y="2161.2031"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="1553.7656" style="stroke:#A80036;stroke-width:1.0;" width="10" x="550.5" y="202.7813"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="4650.5703" style="stroke:#A80036;stroke-width:1.0;" width="10" x="550.5" y="2161.2031"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="6365.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1026.5" y="446.2422"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="133.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1031.5" y="1593.8828"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="209.1953" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1031.5" y="2344.1328"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="652.8516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1031.5" y="3534.375"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="125.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1031.5" y="6539.3125"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="58.2656" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1541.5" y="1564.75"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="129.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1541.5" y="3468.1094"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="100.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1541.5" y="6502.1797"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="497.0547" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2057.5" y="517.5078"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="374.5234" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2057.5" y="1219.3594"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="330.5938" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2057.5" y="2415.3984"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="331.8594" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2057.5" y="3265.7813"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="552.3203" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2057.5" y="3830.7031"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="989.1094" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2057.5" y="4528.5547"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="297.7266" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2057.5" y="6304.8516"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="652.7188" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2405.5" y="4923.2109"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="233.9297" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2846.5" y="5546.7969"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="163.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3278.5" y="851.0313"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="163.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3278.5" y="2582.4609"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="166.6641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3278.5" y="4216.3594"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="204.7969" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3278.5" y="5312.8672"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="175.6641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3278.5" y="5605.0625"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="544.0547" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3794.5" y="984.5625"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="752.1172" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3794.5" y="2715.9922"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="633.5859" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3794.5" y="4253.4922"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="984.5156" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3794.5" y="5488.5313"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="71.2656" style="stroke:#A80036;stroke-width:1.0;" width="10" x="4302.5" y="1085.8281"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="279.3281" style="stroke:#000000;stroke-width:2.0;" width="1861" x="2021" y="5870.9922"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="76" x2="76" y1="95.3828" y2="6820.7734"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="555.5" x2="555.5" y1="95.3828" y2="6820.7734"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1031.5" x2="1031.5" y1="95.3828" y2="6820.7734"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1546" x2="1546" y1="95.3828" y2="6820.7734"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="2062" x2="2062" y1="95.3828" y2="6820.7734"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="2410.5" x2="2410.5" y1="95.3828" y2="6820.7734"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="2851.5" x2="2851.5" y1="95.3828" y2="6820.7734"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="3283" x2="3283" y1="95.3828" y2="6820.7734"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="3799" x2="3799" y1="95.3828" y2="6820.7734"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="4307" x2="4307" y1="95.3828" y2="6820.7734"/><rect fill="#FEFECE" filter="url(#fbd4m1bjrz3h2)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="109" x="20" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="95" x="27" y="80.0811">PISP Backend</text><rect fill="#FEFECE" filter="url(#fbd4m1bjrz3h2)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="109" x="20" y="6819.7734"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="95" x="27" y="6839.7686">PISP Backend</text><rect fill="#FEFECE" filter="url(#fbd4m1bjrz3h2)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="130" x="488.5" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="116" x="495.5" y="80.0811">outbound-server</text><rect fill="#FEFECE" filter="url(#fbd4m1bjrz3h2)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="130" x="488.5" y="6819.7734"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="116" x="495.5" y="6839.7686">outbound-server</text><rect fill="#FEFECE" filter="url(#fbd4m1bjrz3h2)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="134" x="962.5" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="120" x="969.5" y="80.0811">PISPLinkingModel</text><rect fill="#FEFECE" filter="url(#fbd4m1bjrz3h2)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="134" x="962.5" y="6819.7734"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="120" x="969.5" y="6839.7686">PISPLinkingModel</text><rect fill="#FEFECE" filter="url(#fbd4m1bjrz3h2)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="119" x="1485" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="105" x="1492" y="80.0811">inbound-server</text><rect fill="#FEFECE" filter="url(#fbd4m1bjrz3h2)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="119" x="1485" y="6819.7734"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="105" x="1492" y="6839.7686">inbound-server</text><rect fill="#FEFECE" filter="url(#fbd4m1bjrz3h2)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="59" x="2031" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="45" x="2038" y="80.0811">Switch</text><rect fill="#FEFECE" filter="url(#fbd4m1bjrz3h2)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="59" x="2031" y="6819.7734"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="45" x="2038" y="6839.7686">Switch</text><rect fill="#FEFECE" filter="url(#fbd4m1bjrz3h2)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="100" x="2358.5" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="86" x="2365.5" y="80.0811">Auth Service</text><rect fill="#FEFECE" filter="url(#fbd4m1bjrz3h2)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="100" x="2358.5" y="6819.7734"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="86" x="2365.5" y="6839.7686">Auth Service</text><rect fill="#FEFECE" filter="url(#fbd4m1bjrz3h2)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="180" x="2759.5" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="166" x="2766.5" y="80.0811">Account Lookup Service</text><rect fill="#FEFECE" filter="url(#fbd4m1bjrz3h2)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="180" x="2759.5" y="6819.7734"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="166" x="2766.5" y="6839.7686">Account Lookup Service</text><rect fill="#FEFECE" filter="url(#fbd4m1bjrz3h2)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="119" x="3222" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="105" x="3229" y="80.0811">inbound-server</text><rect fill="#FEFECE" filter="url(#fbd4m1bjrz3h2)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="119" x="3222" y="6819.7734"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="105" x="3229" y="6839.7686">inbound-server</text><rect fill="#FEFECE" filter="url(#fbd4m1bjrz3h2)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="141" x="3727" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="127" x="3734" y="80.0811">DFSPLinkingModel</text><rect fill="#FEFECE" filter="url(#fbd4m1bjrz3h2)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="141" x="3727" y="6819.7734"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="127" x="3734" y="6839.7686">DFSPLinkingModel</text><rect fill="#FEFECE" filter="url(#fbd4m1bjrz3h2)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="181" x="4215" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="167" x="4222" y="80.0811">DFSPAuthorizeSimulator</text><rect fill="#FEFECE" filter="url(#fbd4m1bjrz3h2)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="181" x="4215" y="6819.7734"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="167" x="4222" y="6839.7686">DFSPAuthorizeSimulator</text><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="1553.7656" style="stroke:#A80036;stroke-width:1.0;" width="10" x="71.5" y="202.7813"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="4650.5703" style="stroke:#A80036;stroke-width:1.0;" width="10" x="71.5" y="2161.2031"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="1553.7656" style="stroke:#A80036;stroke-width:1.0;" width="10" x="550.5" y="202.7813"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="4650.5703" style="stroke:#A80036;stroke-width:1.0;" width="10" x="550.5" y="2161.2031"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="6365.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1026.5" y="446.2422"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="133.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1031.5" y="1593.8828"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="209.1953" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1031.5" y="2344.1328"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="652.8516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1031.5" y="3534.375"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="125.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1031.5" y="6539.3125"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="58.2656" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1541.5" y="1564.75"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="129.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1541.5" y="3468.1094"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="100.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1541.5" y="6502.1797"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="497.0547" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2057.5" y="517.5078"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="374.5234" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2057.5" y="1219.3594"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="330.5938" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2057.5" y="2415.3984"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="331.8594" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2057.5" y="3265.7813"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="552.3203" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2057.5" y="3830.7031"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="989.1094" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2057.5" y="4528.5547"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="297.7266" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2057.5" y="6304.8516"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="652.7188" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2405.5" y="4923.2109"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="233.9297" style="stroke:#A80036;stroke-width:1.0;" width="10" x="2846.5" y="5546.7969"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="163.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3278.5" y="851.0313"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="163.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3278.5" y="2582.4609"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="166.6641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3278.5" y="4216.3594"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="204.7969" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3278.5" y="5312.8672"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="175.6641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3278.5" y="5605.0625"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="544.0547" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3794.5" y="984.5625"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="752.1172" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3794.5" y="2715.9922"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="633.5859" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3794.5" y="4253.4922"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="984.5156" style="stroke:#A80036;stroke-width:1.0;" width="10" x="3794.5" y="5488.5313"/><rect fill="#FFFFFF" filter="url(#fbd4m1bjrz3h2)" height="71.2656" style="stroke:#A80036;stroke-width:1.0;" width="10" x="4302.5" y="1085.8281"/><rect fill="#EEEEEE" filter="url(#fbd4m1bjrz3h2)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="4684.5" x="0" y="125.9492"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="4684.5" y1="125.9492" y2="125.9492"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="4684.5" y1="128.9492" y2="128.9492"/><rect fill="#EEEEEE" filter="url(#fbd4m1bjrz3h2)" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="193" x="2245.75" y="115.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="174" x="2251.75" y="131.4497">Request Consent - Web</text><rect fill="#FBFB77" filter="url(#fbd4m1bjrz3h2)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="485" x="81" y="153.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="477" x="85" y="169.5825">PISP presents accounts to user. User selects one or more accounts to link.</text><polygon fill="#A80036" points="538.5,198.7813,548.5,202.7813,538.5,206.7813,542.5,202.7813" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="81.5" x2="544.5" y1="202.7813" y2="202.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="88.5" y="197.7153">REQUEST-CONSENT-1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="246.5" y="197.7153">POST /linking/request-consent</text><rect fill="#ADD8E6" filter="url(#fbd4m1bjrz3h2)" height="129" style="stroke:#A80036;stroke-width:1.0;" width="570" x="86" y="215.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="90" y="231.8481">POST /linking/request-consent</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="90" y="246.981">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="81" x="98" y="262.1138">"accounts": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="507" x="106" y="277.2466">{ accountNickname: "XXXXXXnt", id: "dfspa.username.1234", currency: "ZAR" },</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="546" x="106" y="292.3794">{ accountNickname: "SpeXXXXXXXXnt", id: "dfspa.username.5678", currency: "USD" }</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="9" x="98" y="307.5122">],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="204" x="98" y="322.645">callbackURI: 'pisp-app://callback'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="90" y="337.7778">}</text><line style="stroke:#A80036;stroke-width:1.0;" x1="560.5" x2="602.5" y1="370.9766" y2="370.9766"/><line style="stroke:#A80036;stroke-width:1.0;" x1="602.5" x2="602.5" y1="370.9766" y2="383.9766"/><line style="stroke:#A80036;stroke-width:1.0;" x1="561.5" x2="602.5" y1="383.9766" y2="383.9766"/><polygon fill="#A80036" points="571.5,379.9766,561.5,383.9766,571.5,387.9766,567.5,383.9766" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="567.5" y="365.9106">REQUEST-CONSENT-2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="186" x="725.5" y="365.9106">const model = await create()</text><rect fill="#FBFB77" filter="url(#fbd4m1bjrz3h2)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="79" x="565" y="396.9766"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="569" y="413.0435">state: start</text><polygon fill="#A80036" points="1014.5,442.2422,1024.5,446.2422,1014.5,450.2422,1018.5,446.2422" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="560.5" x2="1020.5" y1="446.2422" y2="446.2422"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="567.5" y="441.1763">REQUEST-CONSENT-3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="156" x="725.5" y="441.1763">model.requestConsent()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1036.5" x2="1078.5" y1="475.375" y2="475.375"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1078.5" x2="1078.5" y1="475.375" y2="488.375"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1037.5" x2="1078.5" y1="488.375" y2="488.375"/><polygon fill="#A80036" points="1047.5,484.375,1037.5,488.375,1047.5,492.375,1043.5,488.375" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="1043.5" y="470.3091">REQUEST-CONSENT-4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="277" x="1201.5" y="470.3091">ThirdpartyRequests.postConsentRequests()</text><polygon fill="#A80036" points="2045.5,513.5078,2055.5,517.5078,2045.5,521.5078,2049.5,517.5078" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1036.5" x2="2051.5" y1="517.5078" y2="517.5078"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="1043.5" y="512.4419">REQUEST-CONSENT-5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="152" x="1201.5" y="512.4419">POST /consentRequests</text><rect fill="#ADD8E6" filter="url(#fbd4m1bjrz3h2)" height="265" style="stroke:#A80036;stroke-width:1.0;" width="358" x="1041" y="530.5078"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="152" x="1045" y="546.5747">POST /consentRequests</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="1045" y="561.7075">FSIOP-Source: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="1045" y="576.8403">FSIOP-Destination: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1045" y="591.9731">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="277" x="1053" y="607.106">// consentRequestId will be the uuid created</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="142" x="1053" y="622.2388">// at the PRELINKING-2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154" x="1053" y="637.3716">consentRequestId: 6789</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66" x="1053" y="652.5044">scopes: [{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="1061" y="667.6372">accountId: 'dfspa.username.1234',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="1061" y="682.77">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="1061" y="697.9028">accountId: 'dfspa.username.5678',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="1061" y="713.0356">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="17" x="1053" y="728.1685">}],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="208" x="1053" y="743.3013">// model will add `authChannels`</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="1053" y="758.4341">authChannels: ["WEB", "OTP"],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="216" x="1053" y="773.5669">callbackURI: 'pisp-app://callback...'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1045" y="788.6997">}</text><polygon fill="#A80036" points="1047.5,817.8984,1037.5,821.8984,1047.5,825.8984,1043.5,821.8984" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1041.5" x2="2056.5" y1="821.8984" y2="821.8984"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="1053.5" y="816.8325">REQUEST-CONSENT-6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="1211.5" y="816.8325">202 Accepted</text><polygon fill="#A80036" points="3266.5,847.0313,3276.5,851.0313,3266.5,855.0313,3270.5,851.0313" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2067.5" x2="3272.5" y1="851.0313" y2="851.0313"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="2074.5" y="845.9653">REQUEST-CONSENT-7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="152" x="2232.5" y="845.9653">POST /consentRequests</text><polygon fill="#A80036" points="2078.5,876.1641,2068.5,880.1641,2078.5,884.1641,2074.5,880.1641" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2072.5" x2="3277.5" y1="880.1641" y2="880.1641"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="2084.5" y="875.0981">REQUEST-CONSENT-8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2242.5" y="875.0981">202 Accepted</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3288.5" x2="3330.5" y1="909.2969" y2="909.2969"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3330.5" x2="3330.5" y1="909.2969" y2="922.2969"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3289.5" x2="3330.5" y1="922.2969" y2="922.2969"/><polygon fill="#A80036" points="3299.5,918.2969,3289.5,922.2969,3299.5,926.2969,3295.5,922.2969" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="154" x="3295.5" y="904.231">REQUEST-CONSENT-9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="186" x="3453.5" y="904.231">const model = await create()</text><rect fill="#FBFB77" filter="url(#fbd4m1bjrz3h2)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="79" x="3293" y="935.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="3297" y="951.3638">state: start</text><polygon fill="#A80036" points="3782.5,980.5625,3792.5,984.5625,3782.5,988.5625,3786.5,984.5625" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3288.5" x2="3788.5" y1="984.5625" y2="984.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="3295.5" y="979.4966">REQUEST-CONSENT-10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="156" x="3462.5" y="979.4966">model.requestConsent()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3804.5" x2="3846.5" y1="1043.6953" y2="1043.6953"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3846.5" x2="3846.5" y1="1043.6953" y2="1056.6953"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3805.5" x2="3846.5" y1="1056.6953" y2="1056.6953"/><polygon fill="#A80036" points="3815.5,1052.6953,3805.5,1056.6953,3815.5,1060.6953,3811.5,1056.6953" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="3811.5" y="1038.6294">REQUEST-CONSENT-11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="317" x="3978.5" y="1038.6294">DFSPBackendRequests.validateConsentRequest()</text><polygon fill="#A80036" points="4290.5,1081.8281,4300.5,1085.8281,4290.5,1089.8281,4294.5,1085.8281" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3804.5" x2="4296.5" y1="1085.8281" y2="1085.8281"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="3811.5" y="1080.7622">REQUEST-CONSENT-12</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="256" x="3978.5" y="1080.7622">POST /store/consentRequests/6789</text><line style="stroke:#A80036;stroke-width:1.0;" x1="4312.5" x2="4354.5" y1="1114.9609" y2="1114.9609"/><line style="stroke:#A80036;stroke-width:1.0;" x1="4354.5" x2="4354.5" y1="1114.9609" y2="1127.9609"/><line style="stroke:#A80036;stroke-width:1.0;" x1="4313.5" x2="4354.5" y1="1127.9609" y2="1127.9609"/><polygon fill="#A80036" points="4323.5,1123.9609,4313.5,1127.9609,4323.5,1131.9609,4319.5,1127.9609" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="4319.5" y="1109.895">REQUEST-CONSENT-13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="186" x="4486.5" y="1109.895">store consentRequest details</text><polygon fill="#A80036" points="3815.5,1153.0938,3805.5,1157.0938,3815.5,1161.0938,3811.5,1157.0938" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3809.5" x2="4306.5" y1="1157.0938" y2="1157.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="3821.5" y="1152.0278">REQUEST-CONSENT-14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="3988.5" y="1152.0278">201 Created</text><rect fill="#FBFB77" filter="url(#fbd4m1bjrz3h2)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="280" x="3809" y="1170.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="272" x="3813" y="1186.1606">state: consentRequestValidatedAndStored</text><polygon fill="#A80036" points="2078.5,1215.3594,2068.5,1219.3594,2078.5,1223.3594,2074.5,1219.3594" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2072.5" x2="3793.5" y1="1219.3594" y2="1219.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="2084.5" y="1214.2935">REQUEST-CONSENT-15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="179" x="2251.5" y="1214.2935">PUT /consentRequests/6789</text><rect fill="#ADD8E6" filter="url(#fbd4m1bjrz3h2)" height="234" style="stroke:#A80036;stroke-width:1.0;" width="457" x="3332" y="1232.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="179" x="3336" y="1248.4263">PUT /consentRequests/6789</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="3336" y="1263.5591">FSIOP-Source: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="3336" y="1278.6919">FSIOP-Destination: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3336" y="1293.8247">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154" x="3344" y="1308.9575">consentRequestId: 6789</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66" x="3344" y="1324.0903">scopes: [{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="3352" y="1339.2231">accountId: 'dfspa.username.1234',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="3352" y="1354.356">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="3352" y="1369.4888">accountId: 'dfspa.username.5678',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="3352" y="1384.6216">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="17" x="3344" y="1399.7544">}],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="148" x="3344" y="1414.8872">authChannels: ["WEB"],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="3344" y="1430.02">callbackURI: 'pisp-app://callback...',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="441" x="3344" y="1445.1528">authURI: 'dfspa.com/authorize?consentRequestId=6789' // this is new</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3336" y="1460.2856">}</text><polygon fill="#A80036" points="3782.5,1489.4844,3792.5,1493.4844,3782.5,1497.4844,3786.5,1493.4844" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2067.5" x2="3788.5" y1="1493.4844" y2="1493.4844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="2074.5" y="1488.4185">REQUEST-CONSENT-16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="96" x="2241.5" y="1488.4185">202 ACCEPTED</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3804.5" x2="3846.5" y1="1527.6172" y2="1527.6172"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3846.5" x2="3846.5" y1="1527.6172" y2="1540.6172"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3846.5" y1="1540.6172" y2="1540.6172"/><polygon fill="#A80036" points="3809.5,1536.6172,3799.5,1540.6172,3809.5,1544.6172,3805.5,1540.6172" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="3811.5" y="1522.5513">REQUEST-CONSENT-17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="108" x="3978.5" y="1522.5513">this.saveToKVS()</text><polygon fill="#A80036" points="1562.5,1560.75,1552.5,1564.75,1562.5,1568.75,1558.5,1564.75" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1556.5" x2="2056.5" y1="1564.75" y2="1564.75"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1568.5" y="1559.6841">REQUEST-CONSENT-18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="179" x="1735.5" y="1559.6841">PUT /consentRequests/6789</text><polygon fill="#A80036" points="2050.5,1589.8828,2060.5,1593.8828,2050.5,1597.8828,2054.5,1593.8828" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1551.5" x2="2056.5" y1="1593.8828" y2="1593.8828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1558.5" y="1588.8169">REQUEST-CONSENT-19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="1725.5" y="1588.8169">200 OK</text><polygon fill="#A80036" points="1052.5,1619.0156,1042.5,1623.0156,1052.5,1627.0156,1048.5,1623.0156" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1046.5" x2="1545.5" y1="1623.0156" y2="1623.0156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1058.5" y="1617.9497">REQUEST-CONSENT-20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="230" x="1225.5" y="1617.9497">Consent Request response recieved</text><rect fill="#FBFB77" filter="url(#fbd4m1bjrz3h2)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="338" x="1046" y="1636.0156"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="330" x="1050" y="1652.0825">state: webAuthenticationChannelResponseRecieved</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1041.5" x2="1083.5" y1="1685.2813" y2="1685.2813"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1083.5" x2="1083.5" y1="1685.2813" y2="1698.2813"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1042.5" x2="1083.5" y1="1698.2813" y2="1698.2813"/><polygon fill="#A80036" points="1052.5,1694.2813,1042.5,1698.2813,1052.5,1702.2813,1048.5,1698.2813" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="1048.5" y="1680.2153">REQUEST-CONSENT-21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="108" x="1215.5" y="1680.2153">this.saveToKVS()</text><polygon fill="#A80036" points="571.5,1723.4141,561.5,1727.4141,571.5,1731.4141,567.5,1727.4141" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="565.5" x2="1025.5" y1="1727.4141" y2="1727.4141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="577.5" y="1722.3481">REQUEST-CONSENT-22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="202" x="744.5" y="1722.3481">return Authentication Response</text><polygon fill="#A80036" points="87.5,1752.5469,77.5,1756.5469,87.5,1760.5469,83.5,1756.5469" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="81.5" x2="554.5" y1="1756.5469" y2="1756.5469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="93.5" y="1751.481">REQUEST-CONSENT-23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="201" x="260.5" y="1751.481">200 OK Autentication Response</text><rect fill="#ADD8E6" filter="url(#fbd4m1bjrz3h2)" height="234" style="stroke:#A80036;stroke-width:1.0;" width="465" x="85" y="1769.5469"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="89" y="1785.6138">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="128" x="97" y="1800.7466">channelResponse: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154" x="105" y="1815.8794">consentRequestId: 6789</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66" x="105" y="1831.0122">scopes: [{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="113" y="1846.145">accountId: 'dfspa.username.1234',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="113" y="1861.2778">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="113" y="1876.4106">accountId: 'dfspa.username.5678',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="113" y="1891.5435">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="17" x="105" y="1906.6763">}],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="148" x="105" y="1921.8091">authChannels: ["WEB"],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="105" y="1936.9419">callbackURI: 'pisp-app://callback...',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="441" x="105" y="1952.0747">authURI: 'dfspa.com/authorize?consentRequestId=6789' // this is new</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="12" x="97" y="1967.2075">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="391" x="97" y="1982.3403">currentState="OTPAuthenticationChannelResponseRecieved"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="89" y="1997.4731">}</text><path d="M5,2014.5391 L5,2054.5391 L4380,2054.5391 L4380,2024.5391 L4370,2014.5391 L5,2014.5391 " fill="#FBFB77" filter="url(#fbd4m1bjrz3h2)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M4370,2014.5391 L4370,2024.5391 L4380,2024.5391 L4370,2014.5391 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="784" x="1794" y="2031.606">The PISP is expected to redirect to the DFSP's `authUri` in their application to let the end user complete the web login flow.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="580" x="1794" y="2046.7388">Logging in successfully should provide the PISP with a secret to use in the next linking step.</text><rect fill="#EEEEEE" filter="url(#fbd4m1bjrz3h2)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="4684.5" x="0" y="2084.3711"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="4684.5" y1="2084.3711" y2="2084.3711"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="4684.5" y1="2087.3711" y2="2087.3711"/><rect fill="#EEEEEE" filter="url(#fbd4m1bjrz3h2)" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="397" x="2143.75" y="2073.8047"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="378" x="2149.75" y="2089.8716">Authentication+Grant Consent+Register Credential</text><rect fill="#FBFB77" filter="url(#fbd4m1bjrz3h2)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="503" x="81" y="2111.9375"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="495" x="85" y="2128.0044">PISP has obtained authToken from end-user(OTP) or through a callback(Web).</text><polygon fill="#A80036" points="538.5,2157.2031,548.5,2161.2031,538.5,2165.2031,542.5,2161.2031" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="81.5" x2="544.5" y1="2161.2031" y2="2161.2031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="88.5" y="2156.1372">AUTHENTICATION-1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="312" x="231.5" y="2156.1372">POST /linking/request-consent/6789/authenticate</text><rect fill="#ADD8E6" filter="url(#fbd4m1bjrz3h2)" height="68" style="stroke:#A80036;stroke-width:1.0;" width="320" x="86" y="2174.2031"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="312" x="90" y="2190.27">POST /linking/request-consent/6789/authenticate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="90" y="2205.4028">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="98" y="2220.5356">authToken: '123456'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="90" y="2235.6685">}</text><line style="stroke:#A80036;stroke-width:1.0;" x1="560.5" x2="602.5" y1="2268.8672" y2="2268.8672"/><line style="stroke:#A80036;stroke-width:1.0;" x1="602.5" x2="602.5" y1="2268.8672" y2="2281.8672"/><line style="stroke:#A80036;stroke-width:1.0;" x1="561.5" x2="602.5" y1="2281.8672" y2="2281.8672"/><polygon fill="#A80036" points="571.5,2277.8672,561.5,2281.8672,571.5,2285.8672,567.5,2281.8672" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="567.5" y="2263.8013">AUTHENTICATION-2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="309" x="710.5" y="2263.8013">const model = await loadFromKVS({key: 6789})</text><rect fill="#FBFB77" filter="url(#fbd4m1bjrz3h2)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="648" x="565" y="2294.8672"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="640" x="569" y="2310.9341">state: webAuthenticationChannelResponseRecieved or OTPAuthenticationChannelResponseRecieved</text><polygon fill="#A80036" points="1019.5,2340.1328,1029.5,2344.1328,1019.5,2348.1328,1023.5,2344.1328" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="560.5" x2="1025.5" y1="2344.1328" y2="2344.1328"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="567.5" y="2339.0669">AUTHENTICATION-3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="710.5" y="2339.0669">model.authenticate()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1041.5" x2="1083.5" y1="2373.2656" y2="2373.2656"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1083.5" x2="1083.5" y1="2373.2656" y2="2386.2656"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1042.5" x2="1083.5" y1="2386.2656" y2="2386.2656"/><polygon fill="#A80036" points="1052.5,2382.2656,1042.5,2386.2656,1052.5,2390.2656,1048.5,2386.2656" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="1048.5" y="2368.1997">AUTHENTICATION-4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="285" x="1191.5" y="2368.1997">ThirdpartyRequests.patchConsentRequests()</text><polygon fill="#A80036" points="2045.5,2411.3984,2055.5,2415.3984,2045.5,2419.3984,2049.5,2415.3984" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1041.5" x2="2051.5" y1="2415.3984" y2="2415.3984"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="1048.5" y="2410.3325">AUTHENTICATION-5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="197" x="1191.5" y="2410.3325">PATCH /consentRequests/6789</text><rect fill="#ADD8E6" filter="url(#fbd4m1bjrz3h2)" height="98" style="stroke:#A80036;stroke-width:1.0;" width="205" x="1046" y="2428.3984"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="197" x="1050" y="2444.4653">PATCH /consentRequests/6789</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="1050" y="2459.5981">FSIOP-Source: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="1050" y="2474.731">FSIOP-Destination: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1050" y="2489.8638">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="1058" y="2504.9966">authToken: '124356'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1050" y="2520.1294">}</text><polygon fill="#A80036" points="1047.5,2549.3281,1037.5,2553.3281,1047.5,2557.3281,1043.5,2553.3281" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1041.5" x2="2056.5" y1="2553.3281" y2="2553.3281"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="1053.5" y="2548.2622">AUTHENTICATION-6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="1196.5" y="2548.2622">202 Accepted</text><polygon fill="#A80036" points="3266.5,2578.4609,3276.5,2582.4609,3266.5,2586.4609,3270.5,2582.4609" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2067.5" x2="3272.5" y1="2582.4609" y2="2582.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="2074.5" y="2577.395">AUTHENTICATION-7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="197" x="2217.5" y="2577.395">PATCH /consentRequests/6789</text><polygon fill="#A80036" points="2078.5,2607.5938,2068.5,2611.5938,2078.5,2615.5938,2074.5,2611.5938" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2072.5" x2="3277.5" y1="2611.5938" y2="2611.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="2084.5" y="2606.5278">AUTHENTICATION-8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2227.5" y="2606.5278">202 Accepted</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3288.5" x2="3330.5" y1="2640.7266" y2="2640.7266"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3330.5" x2="3330.5" y1="2640.7266" y2="2653.7266"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3289.5" x2="3330.5" y1="2653.7266" y2="2653.7266"/><polygon fill="#A80036" points="3299.5,2649.7266,3289.5,2653.7266,3299.5,2657.7266,3295.5,2653.7266" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="139" x="3295.5" y="2635.6606">AUTHENTICATION-9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="309" x="3438.5" y="2635.6606">const model = await loadFromKVS({key: 6789})</text><rect fill="#FBFB77" filter="url(#fbd4m1bjrz3h2)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="280" x="3293" y="2666.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="272" x="3297" y="2682.7935">state: consentRequestValidatedAndStored</text><polygon fill="#A80036" points="3782.5,2711.9922,3792.5,2715.9922,3782.5,2719.9922,3786.5,2715.9922" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3288.5" x2="3788.5" y1="2715.9922" y2="2715.9922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3295.5" y="2710.9263">AUTHENTICATION-10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="172" x="3447.5" y="2710.9263">model.validateAuthToken()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3804.5" x2="3846.5" y1="2775.125" y2="2775.125"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3846.5" x2="3846.5" y1="2775.125" y2="2788.125"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3805.5" x2="3846.5" y1="2788.125" y2="2788.125"/><polygon fill="#A80036" points="3815.5,2784.125,3805.5,2788.125,3815.5,2792.125,3811.5,2788.125" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3811.5" y="2770.0591">AUTHENTICATION-11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="280" x="3963.5" y="2770.0591">DFSPBackendRequests.validateAuthToken()</text><rect fill="#ADD8E6" filter="url(#fbd4m1bjrz3h2)" height="159" style="stroke:#A80036;stroke-width:1.0;" width="416" x="3809" y="2801.125"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="312" x="3813" y="2817.1919">Do we need two backend endpoints for validating</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="408" x="3813" y="2832.3247">web authTokens and OTP authTokens? Or is a DFSP expected to</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="248" x="3813" y="2847.4575">validate both cases with one endpoint?</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="0" x="3817" y="2862.5903"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="160" x="3813" y="2877.7231">POST /validateAuthToken</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3813" y="2892.856">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="160" x="3821" y="2907.9888">consentRequestId: '6789'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="251" x="3821" y="2923.1216">authChannel: model.data.authChannel,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="3821" y="2938.2544">authToken: '124356'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3813" y="2953.3872">}</text><rect fill="#FBFB77" filter="url(#fbd4m1bjrz3h2)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="176" x="3809" y="2970.4531"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="168" x="3813" y="2986.52">state: authTokenValidated</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3804.5" x2="3846.5" y1="3019.7188" y2="3019.7188"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3846.5" x2="3846.5" y1="3019.7188" y2="3032.7188"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3805.5" x2="3846.5" y1="3032.7188" y2="3032.7188"/><polygon fill="#A80036" points="3815.5,3028.7188,3805.5,3032.7188,3815.5,3036.7188,3811.5,3032.7188" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3811.5" y="3014.6528">AUTHENTICATION-12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="157" x="3963.5" y="3014.6528">const consentId = uuid()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3804.5" x2="3846.5" y1="3061.8516" y2="3061.8516"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3846.5" x2="3846.5" y1="3061.8516" y2="3074.8516"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3805.5" x2="3846.5" y1="3074.8516" y2="3074.8516"/><polygon fill="#A80036" points="3815.5,3070.8516,3805.5,3074.8516,3815.5,3078.8516,3811.5,3074.8516" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3811.5" y="3056.7856">AUTHENTICATION-13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="141" x="3963.5" y="3056.7856">model.grantConsent()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3804.5" x2="3846.5" y1="3103.9844" y2="3103.9844"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3846.5" x2="3846.5" y1="3103.9844" y2="3116.9844"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3805.5" x2="3846.5" y1="3116.9844" y2="3116.9844"/><polygon fill="#A80036" points="3815.5,3112.9844,3805.5,3116.9844,3815.5,3120.9844,3811.5,3116.9844" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3811.5" y="3098.9185">AUTHENTICATION-14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="225" x="3963.5" y="3098.9185">ThirdpartyRequests.postConsents()</text><rect fill="#FBFB77" filter="url(#fbd4m1bjrz3h2)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="152" x="3809" y="3129.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="144" x="3813" y="3146.0513">state: consentGranted</text><rect fill="#ADD8E6" filter="url(#fbd4m1bjrz3h2)" height="68" style="stroke:#A80036;stroke-width:1.0;" width="495" x="3809" y="3163.1172"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="484" x="3813" y="3179.1841">It's important to save the model with the consentId from this point onwards!</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="458" x="3813" y="3194.3169">Requests will not contain a consentRequestId in the upcoming requests.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="487" x="3813" y="3209.4497">This may require changing `PersistentModel` to have a secondary key it can</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="3813" y="3224.5825">store the model with.</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3804.5" x2="3851.5" y1="3252.7813" y2="3252.7813"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3851.5" x2="3851.5" y1="3252.7813" y2="3265.7813"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3810.5" x2="3851.5" y1="3265.7813" y2="3265.7813"/><polygon fill="#A80036" points="3820.5,3261.7813,3810.5,3265.7813,3820.5,3269.7813,3816.5,3265.7813" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3816.5" y="3247.7153">AUTHENTICATION-15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="223" x="3968.5" y="3247.7153">this.saveToKVS({key: '1a2b3c4d'})</text><polygon fill="#A80036" points="2078.5,3295.9141,2068.5,3299.9141,2078.5,3303.9141,2074.5,3299.9141" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2072.5" x2="3793.5" y1="3299.9141" y2="3299.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2084.5" y="3294.8481">AUTHENTICATION-16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100" x="2236.5" y="3294.8481">POST /consents</text><rect fill="#ADD8E6" filter="url(#fbd4m1bjrz3h2)" height="129" style="stroke:#A80036;stroke-width:1.0;" width="191" x="3598" y="3312.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100" x="3602" y="3328.981">POST /consents</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="130" x="3602" y="3344.1138">FSIOP-Source: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="157" x="3602" y="3359.2466">FSIOP-Destination: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3602" y="3374.3794">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="133" x="3610" y="3389.5122">consentId: 1a2b3c4d</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154" x="3610" y="3404.645">consentRequestId: 6789</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="175" x="3610" y="3419.7778">scopes: model.data.scopes</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3602" y="3434.9106">}</text><polygon fill="#A80036" points="3787.5,3464.1094,3797.5,3468.1094,3787.5,3472.1094,3791.5,3468.1094" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2067.5" x2="3793.5" y1="3468.1094" y2="3468.1094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2074.5" y="3463.0435">AUTHENTICATION-17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="96" x="2226.5" y="3463.0435">202 ACCEPTED</text><polygon fill="#A80036" points="1562.5,3493.2422,1552.5,3497.2422,1562.5,3501.2422,1558.5,3497.2422" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1556.5" x2="2056.5" y1="3497.2422" y2="3497.2422"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1568.5" y="3492.1763">AUTHENTICATION-18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100" x="1720.5" y="3492.1763">POST /consents</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1551.5" x2="1598.5" y1="3521.375" y2="3521.375"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1598.5" x2="1598.5" y1="3521.375" y2="3534.375"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1557.5" x2="1598.5" y1="3534.375" y2="3534.375"/><polygon fill="#A80036" points="1567.5,3530.375,1557.5,3534.375,1567.5,3538.375,1563.5,3534.375" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1563.5" y="3516.3091">AUTHENTICATION-19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="309" x="1715.5" y="3516.3091">const model = await loadFromKVS({key: 6789})</text><polygon fill="#A80036" points="1052.5,3564.5078,1042.5,3568.5078,1052.5,3572.5078,1048.5,3568.5078" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1046.5" x2="1540.5" y1="3568.5078" y2="3568.5078"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1058.5" y="3563.4419">AUTHENTICATION-20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="168" x="1210.5" y="3563.4419">model.registerCredential()</text><polygon fill="#A80036" points="2050.5,3593.6406,2060.5,3597.6406,2050.5,3601.6406,2054.5,3597.6406" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1546.5" x2="2056.5" y1="3597.6406" y2="3597.6406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1553.5" y="3592.5747">AUTHENTICATION-21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="1705.5" y="3592.5747">202 Accepted</text><rect fill="#FBFB77" filter="url(#fbd4m1bjrz3h2)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="157" x="1046" y="3610.6406"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="149" x="1050" y="3626.7075">state: consentRecieved</text><rect fill="#ADD8E6" filter="url(#fbd4m1bjrz3h2)" height="68" style="stroke:#A80036;stroke-width:1.0;" width="495" x="1046" y="3643.7734"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="484" x="1050" y="3659.8403">It's important to save the model with the consentId from this point onwards!</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="458" x="1050" y="3674.9731">Requests will not contain a consentRequestId in the upcoming requests.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="487" x="1050" y="3690.106">This may require changing `PersistentModel` to have a secondary key it can</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="1050" y="3705.2388">store the model with.</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1041.5" x2="1083.5" y1="3738.4375" y2="3738.4375"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1083.5" x2="1083.5" y1="3738.4375" y2="3751.4375"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1042.5" x2="1083.5" y1="3751.4375" y2="3751.4375"/><polygon fill="#A80036" points="1052.5,3747.4375,1042.5,3751.4375,1052.5,3755.4375,1048.5,3751.4375" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1048.5" y="3733.3716">AUTHENTICATION-22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="1200.5" y="3733.3716">const challenge = deriveChallenge(consentRequest)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1041.5" x2="1083.5" y1="3780.5703" y2="3780.5703"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1083.5" x2="1083.5" y1="3780.5703" y2="3793.5703"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1042.5" x2="1083.5" y1="3793.5703" y2="3793.5703"/><polygon fill="#A80036" points="1052.5,3789.5703,1042.5,3793.5703,1052.5,3797.5703,1048.5,3793.5703" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1048.5" y="3775.5044">AUTHENTICATION-23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="223" x="1200.5" y="3775.5044">this.saveToKVS({key: '1a2b3c4d'})</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1041.5" x2="1088.5" y1="3817.7031" y2="3817.7031"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1088.5" x2="1088.5" y1="3817.7031" y2="3830.7031"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1047.5" x2="1088.5" y1="3830.7031" y2="3830.7031"/><polygon fill="#A80036" points="1057.5,3826.7031,1047.5,3830.7031,1057.5,3834.7031,1053.5,3830.7031" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1053.5" y="3812.6372">AUTHENTICATION-24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="218" x="1205.5" y="3812.6372">ThirdpartyRequests.putConsents()</text><rect fill="#FBFB77" filter="url(#fbd4m1bjrz3h2)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="174" x="1046" y="3848.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="166" x="1050" y="3864.77">state: signedConsentSent</text><polygon fill="#A80036" points="2045.5,3893.9688,2055.5,3897.9688,2045.5,3901.9688,2049.5,3897.9688" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1041.5" x2="2051.5" y1="3897.9688" y2="3897.9688"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1048.5" y="3892.9028">AUTHENTICATION-25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="1200.5" y="3892.9028">PUT /consents/1a2b3c4d</text><rect fill="#ADD8E6" filter="url(#fbd4m1bjrz3h2)" height="250" style="stroke:#A80036;stroke-width:1.0;" width="358" x="1046" y="3910.9688"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="1050" y="3927.0356">PUT /consents/1a2b3c4d</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="1050" y="3942.1685">FSIOP-Source: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="1050" y="3957.3013">FSIOP-Destination: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1050" y="3972.4341">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66" x="1058" y="3987.5669">scopes: [{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="1066" y="4002.6997">accountId: 'dfspa.username.1234',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="1066" y="4017.8325">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="1066" y="4032.9653">accountId: 'dfspa.username.5678',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="1066" y="4048.0981">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="17" x="1058" y="4063.231">}],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="1058" y="4078.3638">credential: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="145" x="1066" y="4093.4966">credentialType: "FIDO",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="121" x="1066" y="4108.6294">status: "PENDING",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="183" x="1066" y="4123.7622">payload: PublicKeyCredential</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1058" y="4138.895">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1050" y="4154.0278">}</text><polygon fill="#A80036" points="1047.5,4183.2266,1037.5,4187.2266,1047.5,4191.2266,1043.5,4187.2266" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1041.5" x2="2056.5" y1="4187.2266" y2="4187.2266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1053.5" y="4182.1606">AUTHENTICATION-26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="1205.5" y="4182.1606">202 Accepted</text><polygon fill="#A80036" points="3266.5,4212.3594,3276.5,4216.3594,3266.5,4220.3594,3270.5,4216.3594" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2067.5" x2="3272.5" y1="4216.3594" y2="4216.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2074.5" y="4211.2935">AUTHENTICATION-27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="2226.5" y="4211.2935">PUT /consents/1a2b3c4d</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3288.5" x2="3335.5" y1="4240.4922" y2="4240.4922"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3335.5" x2="3335.5" y1="4240.4922" y2="4253.4922"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3294.5" x2="3335.5" y1="4253.4922" y2="4253.4922"/><polygon fill="#A80036" points="3304.5,4249.4922,3294.5,4253.4922,3304.5,4257.4922,3300.5,4253.4922" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3300.5" y="4235.4263">AUTHENTICATION-28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="340" x="3452.5" y="4235.4263">const model = await loadFromKVS({key: 1a2b3c4d})</text><rect fill="#FBFB77" filter="url(#fbd4m1bjrz3h2)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="201" x="3293" y="4271.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="193" x="3297" y="4287.5591">state: signedConsentRecieved</text><polygon fill="#A80036" points="3782.5,4316.7578,3792.5,4320.7578,3782.5,4324.7578,3786.5,4320.7578" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3288.5" x2="3788.5" y1="4320.7578" y2="4320.7578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3295.5" y="4315.6919">AUTHENTICATION-29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="201" x="3447.5" y="4315.6919">model.validateSignedConsent()</text><rect fill="#FBFB77" filter="url(#fbd4m1bjrz3h2)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="264" x="3293" y="4333.7578"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="256" x="3297" y="4349.8247">state: pendingRegistrationAndValidation</text><polygon fill="#A80036" points="2073.5,4379.0234,2063.5,4383.0234,2073.5,4387.0234,2069.5,4383.0234" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2067.5" x2="3282.5" y1="4383.0234" y2="4383.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2079.5" y="4377.9575">AUTHENTICATION-30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2231.5" y="4377.9575">202 Accepted</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3804.5" x2="3846.5" y1="4412.1563" y2="4412.1563"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3846.5" x2="3846.5" y1="4412.1563" y2="4425.1563"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3805.5" x2="3846.5" y1="4425.1563" y2="4425.1563"/><polygon fill="#A80036" points="3815.5,4421.1563,3805.5,4425.1563,3815.5,4429.1563,3811.5,4425.1563" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3811.5" y="4407.0903">AUTHENTICATION-31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="144" x="3963.5" y="4407.0903">Check signed consent.</text><rect fill="#ADD8E6" filter="url(#fbd4m1bjrz3h2)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="530" x="3809" y="4438.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="522" x="3813" y="4454.2231">Does this need a backend request or can the scheme adapter check the consent.</text><rect fill="#FBFB77" filter="url(#fbd4m1bjrz3h2)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="199" x="3809" y="4471.2891"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="3813" y="4487.356">state: signedConsentChecked</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3804.5" x2="3851.5" y1="4515.5547" y2="4515.5547"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3851.5" x2="3851.5" y1="4515.5547" y2="4528.5547"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3810.5" x2="3851.5" y1="4528.5547" y2="4528.5547"/><polygon fill="#A80036" points="3820.5,4524.5547,3810.5,4528.5547,3820.5,4532.5547,3816.5,4528.5547" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3816.5" y="4510.4888">AUTHENTICATION-32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="208" x="3968.5" y="4510.4888">model.validateWithAuthService()</text><polygon fill="#A80036" points="2078.5,4558.6875,2068.5,4562.6875,2078.5,4566.6875,2074.5,4562.6875" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2072.5" x2="3793.5" y1="4562.6875" y2="4562.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2084.5" y="4557.6216">AUTHENTICATION-33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="167" x="2236.5" y="4557.6216">POST /consents/1a2b3c4d</text><rect fill="#ADD8E6" filter="url(#fbd4m1bjrz3h2)" height="250" style="stroke:#A80036;stroke-width:1.0;" width="358" x="3431" y="4575.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="167" x="3435" y="4591.7544">POST /consents/1a2b3c4d</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="130" x="3435" y="4606.8872">FSIOP-Source: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="201" x="3435" y="4622.02">FSIOP-Destination: central-auth</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3435" y="4637.1528">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66" x="3443" y="4652.2856">scopes: [{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="3451" y="4667.4185">accountId: 'dfspa.username.1234',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="3451" y="4682.5513">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="3451" y="4697.6841">accountId: 'dfspa.username.5678',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="3451" y="4712.8169">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="17" x="3443" y="4727.9497">}],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="3443" y="4743.0825">credential: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="145" x="3451" y="4758.2153">credentialType: "FIDO",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="121" x="3451" y="4773.3481">status: "PENDING",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="183" x="3451" y="4788.481">payload: PublicKeyCredential</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3443" y="4803.6138">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3435" y="4818.7466">}</text><polygon fill="#A80036" points="3782.5,4847.9453,3792.5,4851.9453,3782.5,4855.9453,3786.5,4851.9453" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2067.5" x2="3788.5" y1="4851.9453" y2="4851.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2074.5" y="4846.8794">AUTHENTICATION-34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2226.5" y="4846.8794">202 Accepted</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3804.5" x2="3846.5" y1="4886.0781" y2="4886.0781"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3846.5" x2="3846.5" y1="4886.0781" y2="4899.0781"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3799.5" x2="3846.5" y1="4899.0781" y2="4899.0781"/><polygon fill="#A80036" points="3809.5,4895.0781,3799.5,4899.0781,3809.5,4903.0781,3805.5,4899.0781" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3811.5" y="4881.0122">AUTHENTICATION-35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="108" x="3963.5" y="4881.0122">this.saveToKVS()</text><polygon fill="#A80036" points="2393.5,4919.2109,2403.5,4923.2109,2393.5,4927.2109,2397.5,4923.2109" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2067.5" x2="2399.5" y1="4923.2109" y2="4923.2109"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2074.5" y="4918.145">AUTHENTICATION-36</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="167" x="2226.5" y="4918.145">POST /consents/1a2b3c4d</text><polygon fill="#A80036" points="2078.5,4948.3438,2068.5,4952.3438,2078.5,4956.3438,2074.5,4952.3438" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2072.5" x2="2404.5" y1="4952.3438" y2="4952.3438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2084.5" y="4947.2778">AUTHENTICATION-37</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2236.5" y="4947.2778">202 Accepted</text><line style="stroke:#A80036;stroke-width:1.0;" x1="2415.5" x2="2457.5" y1="4981.4766" y2="4981.4766"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2457.5" x2="2457.5" y1="4981.4766" y2="4994.4766"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2416.5" x2="2457.5" y1="4994.4766" y2="4994.4766"/><polygon fill="#A80036" points="2426.5,4990.4766,2416.5,4994.4766,2426.5,4998.4766,2422.5,4994.4766" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2422.5" y="4976.4106">AUTHENTICATION-38</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="98" x="2574.5" y="4976.4106">Check consent.</text><polygon fill="#A80036" points="2078.5,5019.6094,2068.5,5023.6094,2078.5,5027.6094,2074.5,5023.6094" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2072.5" x2="2404.5" y1="5023.6094" y2="5023.6094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2084.5" y="5018.5435">AUTHENTICATION-39</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="2236.5" y="5018.5435">PUT /consents/1a2b3c4d</text><rect fill="#ADD8E6" filter="url(#fbd4m1bjrz3h2)" height="250" style="stroke:#A80036;stroke-width:1.0;" width="358" x="2042" y="5036.6094"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="2046" y="5052.6763">PUT /consents/1a2b3c4d</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="173" x="2046" y="5067.8091">FSIOP-Source: central-auth</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="2046" y="5082.9419">FSIOP-Destination: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2046" y="5098.0747">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66" x="2054" y="5113.2075">scopes: [{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="2062" y="5128.3403">accountId: 'dfspa.username.1234',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="2062" y="5143.4731">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="2062" y="5158.606">accountId: 'dfspa.username.5678',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="2062" y="5173.7388">actions: ['accounts.getBalance', 'accounts.transfer'],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="17" x="2054" y="5188.8716">}],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="2054" y="5204.0044">credential: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="145" x="2062" y="5219.1372">credentialType: "FIDO",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="118" x="2062" y="5234.27">status: "VERIFIED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="183" x="2062" y="5249.4028">payload: PublicKeyCredential</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2054" y="5264.5356">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2046" y="5279.6685">}</text><polygon fill="#A80036" points="2393.5,5308.8672,2403.5,5312.8672,2393.5,5316.8672,2397.5,5312.8672" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2067.5" x2="2399.5" y1="5312.8672" y2="5312.8672"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2074.5" y="5307.8013">AUTHENTICATION-40</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="2226.5" y="5307.8013">200 OK</text><polygon fill="#A80036" points="3266.5,5338,3276.5,5342,3266.5,5346,3270.5,5342" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2067.5" x2="3272.5" y1="5342" y2="5342"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2074.5" y="5336.9341">AUTHENTICATION-41</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="2226.5" y="5336.9341">PUT /consents/1a2b3c4d</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3288.5" x2="3330.5" y1="5371.1328" y2="5371.1328"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3330.5" x2="3330.5" y1="5371.1328" y2="5384.1328"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3289.5" x2="3330.5" y1="5384.1328" y2="5384.1328"/><polygon fill="#A80036" points="3299.5,5380.1328,3289.5,5384.1328,3299.5,5388.1328,3295.5,5384.1328" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3295.5" y="5366.0669">AUTHENTICATION-42</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="340" x="3447.5" y="5366.0669">const model = await loadFromKVS({key: 1a2b3c4d})</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3288.5" x2="3330.5" y1="5413.2656" y2="5413.2656"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3330.5" x2="3330.5" y1="5413.2656" y2="5426.2656"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3289.5" x2="3330.5" y1="5426.2656" y2="5426.2656"/><polygon fill="#A80036" points="3299.5,5422.2656,3289.5,5426.2656,3299.5,5430.2656,3295.5,5426.2656" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3295.5" y="5408.1997">AUTHENTICATION-43</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="180" x="3447.5" y="5408.1997">consentResponseRecieved()</text><rect fill="#FBFB77" filter="url(#fbd4m1bjrz3h2)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="219" x="3293" y="5439.2656"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="211" x="3297" y="5455.3325">state: consentResponseRecieved</text><polygon fill="#A80036" points="3782.5,5484.5313,3792.5,5488.5313,3782.5,5492.5313,3786.5,5488.5313" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3288.5" x2="3788.5" y1="5488.5313" y2="5488.5313"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3295.5" y="5483.4653">AUTHENTICATION-44</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="202" x="3447.5" y="5483.4653">Auth Service response recieved</text><polygon fill="#A80036" points="2073.5,5513.6641,2063.5,5517.6641,2073.5,5521.6641,2069.5,5517.6641" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2067.5" x2="3282.5" y1="5517.6641" y2="5517.6641"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2079.5" y="5512.5981">AUTHENTICATION-45</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="2231.5" y="5512.5981">200 OK</text><polygon fill="#A80036" points="2834.5,5542.7969,2844.5,5546.7969,2834.5,5550.7969,2838.5,5546.7969" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2415.5" x2="2840.5" y1="5546.7969" y2="5546.7969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2422.5" y="5541.731">AUTHENTICATION-46</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="260" x="2574.5" y="5541.731">POST /participants/CONSENTS/1a2b3c4d</text><polygon fill="#A80036" points="2421.5,5571.9297,2411.5,5575.9297,2421.5,5579.9297,2417.5,5575.9297" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2415.5" x2="2845.5" y1="5575.9297" y2="5575.9297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2427.5" y="5570.8638">AUTHENTICATION-47</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2579.5" y="5570.8638">202 Accepted</text><polygon fill="#A80036" points="3266.5,5601.0625,3276.5,5605.0625,3266.5,5609.0625,3270.5,5605.0625" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2856.5" x2="3272.5" y1="5605.0625" y2="5605.0625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2863.5" y="5599.9966">AUTHENTICATION-48</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="251" x="3015.5" y="5599.9966">PUT /participants/CONSENTS/1a2b3c4d</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3288.5" x2="3330.5" y1="5634.1953" y2="5634.1953"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3330.5" x2="3330.5" y1="5634.1953" y2="5647.1953"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3289.5" x2="3330.5" y1="5647.1953" y2="5647.1953"/><polygon fill="#A80036" points="3299.5,5643.1953,3289.5,5647.1953,3299.5,5651.1953,3295.5,5647.1953" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3295.5" y="5629.1294">AUTHENTICATION-49</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="340" x="3447.5" y="5629.1294">const model = await loadFromKVS({key: 1a2b3c4d})</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3288.5" x2="3330.5" y1="5676.3281" y2="5676.3281"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3330.5" x2="3330.5" y1="5676.3281" y2="5689.3281"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3289.5" x2="3330.5" y1="5689.3281" y2="5689.3281"/><polygon fill="#A80036" points="3299.5,5685.3281,3289.5,5689.3281,3299.5,5693.3281,3295.5,5689.3281" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3295.5" y="5671.2622">AUTHENTICATION-50</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="197" x="3447.5" y="5671.2622">participantResponseRecieved()</text><rect fill="#FBFB77" filter="url(#fbd4m1bjrz3h2)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="243" x="3293" y="5702.3281"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="235" x="3297" y="5718.395">state: participantsResponseRecieved</text><polygon fill="#A80036" points="3782.5,5747.5938,3792.5,5751.5938,3782.5,5755.5938,3786.5,5751.5938" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3288.5" x2="3788.5" y1="5751.5938" y2="5751.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3295.5" y="5746.5278">AUTHENTICATION-51</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="189" x="3447.5" y="5746.5278">Participant response recieved</text><polygon fill="#A80036" points="2862.5,5776.7266,2852.5,5780.7266,2862.5,5784.7266,2858.5,5780.7266" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2856.5" x2="3282.5" y1="5780.7266" y2="5780.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2868.5" y="5775.6606">AUTHENTICATION-52</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="3020.5" y="5775.6606">200 Accepted</text><rect fill="#FBFB77" filter="url(#fbd4m1bjrz3h2)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="253" x="3809" y="5793.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="245" x="3813" y="5809.7935">state: consentRegisteredAndValidated</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3804.5" x2="3846.5" y1="5842.9922" y2="5842.9922"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3846.5" x2="3846.5" y1="5842.9922" y2="5855.9922"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3805.5" x2="3846.5" y1="5855.9922" y2="5855.9922"/><polygon fill="#A80036" points="3815.5,5851.9922,3805.5,5855.9922,3815.5,5859.9922,3811.5,5855.9922" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3811.5" y="5837.9263">AUTHENTICATION-53</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="151" x="3963.5" y="5837.9263">model.finalizeConsent()</text><path d="M2021,5870.9922 L2098,5870.9922 L2098,5877.9922 L2088,5887.9922 L2021,5887.9922 L2021,5870.9922 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="279.3281" style="stroke:#000000;stroke-width:2.0;" width="1861" x="2021" y="5870.9922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="32" x="2036" y="5884.0591">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="116" x="2113" y="5883.2026">[for each scope in</text><text fill="#000000" font-family="monospace" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="105" x="2233" y="5883.2026">Consents.scopes</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="5" x="2338" y="5883.2026">]</text><polygon fill="#A80036" points="2073.5,5905.2578,2063.5,5909.2578,2073.5,5913.2578,2069.5,5909.2578" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2067.5" x2="3793.5" y1="5909.2578" y2="5909.2578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2079.5" y="5904.1919">AUTHENTICATION-54</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="376" x="2231.5" y="5904.1919">POST /participants/THIRD_PARTY_LINK/dfsp.username.5678</text><polygon fill="#A80036" points="3782.5,5934.3906,3792.5,5938.3906,3782.5,5942.3906,3786.5,5938.3906" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2062.5" x2="3788.5" y1="5938.3906" y2="5938.3906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2069.5" y="5933.3247">AUTHENTICATION-55</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2221.5" y="5933.3247">202 Accepted</text><polygon fill="#A80036" points="2839.5,5963.5234,2849.5,5967.5234,2839.5,5971.5234,2843.5,5967.5234" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2062.5" x2="2845.5" y1="5967.5234" y2="5967.5234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2069.5" y="5962.4575">AUTHENTICATION-56</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="376" x="2221.5" y="5962.4575">POST /participants/THIRD_PARTY_LINK/dfsp.username.5678</text><polygon fill="#A80036" points="2073.5,5992.6563,2063.5,5996.6563,2073.5,6000.6563,2069.5,5996.6563" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2067.5" x2="2850.5" y1="5996.6563" y2="5996.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2079.5" y="5991.5903">AUTHENTICATION-57</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="2231.5" y="5991.5903">202 Accepted</text><polygon fill="#A80036" points="2073.5,6021.7891,2063.5,6025.7891,2073.5,6029.7891,2069.5,6025.7891" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2067.5" x2="2850.5" y1="6025.7891" y2="6025.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2079.5" y="6020.7231">AUTHENTICATION-58</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="367" x="2231.5" y="6020.7231">PUT /participants/THIRD_PARTY_LINK/dfsp.username.5678</text><polygon fill="#A80036" points="2839.5,6050.9219,2849.5,6054.9219,2839.5,6058.9219,2843.5,6054.9219" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2062.5" x2="2845.5" y1="6054.9219" y2="6054.9219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2069.5" y="6049.856">AUTHENTICATION-59</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="2221.5" y="6049.856">200 OK</text><polygon fill="#A80036" points="3271.5,6080.0547,3281.5,6084.0547,3271.5,6088.0547,3275.5,6084.0547" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2062.5" x2="3277.5" y1="6084.0547" y2="6084.0547"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2069.5" y="6078.9888">AUTHENTICATION-60</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="367" x="2221.5" y="6078.9888">PUT /participants/THIRD_PARTY_LINK/dfsp.username.5678</text><polygon fill="#A80036" points="2073.5,6109.1875,2063.5,6113.1875,2073.5,6117.1875,2069.5,6113.1875" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2067.5" x2="3282.5" y1="6113.1875" y2="6113.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2079.5" y="6108.1216">AUTHENTICATION-61</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="2231.5" y="6108.1216">200 OK</text><polygon fill="#A80036" points="3782.5,6138.3203,3792.5,6142.3203,3782.5,6146.3203,3786.5,6142.3203" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3283.5" x2="3788.5" y1="6142.3203" y2="6142.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3290.5" y="6137.2544">AUTHENTICATION-62</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="189" x="3442.5" y="6137.2544">Participant response recieved</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3804.5" x2="3846.5" y1="6178.4531" y2="6178.4531"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3846.5" x2="3846.5" y1="6178.4531" y2="6191.4531"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3805.5" x2="3846.5" y1="6191.4531" y2="6191.4531"/><polygon fill="#A80036" points="3815.5,6187.4531,3805.5,6191.4531,3815.5,6195.4531,3811.5,6191.4531" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3811.5" y="6173.3872">AUTHENTICATION-63</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="3963.5" y="6173.3872">await Promise.all()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3804.5" x2="3846.5" y1="6220.5859" y2="6220.5859"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3846.5" x2="3846.5" y1="6220.5859" y2="6233.5859"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3805.5" x2="3846.5" y1="6233.5859" y2="6233.5859"/><polygon fill="#A80036" points="3815.5,6229.5859,3805.5,6233.5859,3815.5,6237.5859,3811.5,6233.5859" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3811.5" y="6215.52">AUTHENTICATION-64</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="201" x="3963.5" y="6215.52">state: PISPDFSPLinkEstablished</text><line style="stroke:#A80036;stroke-width:1.0;" x1="3804.5" x2="3846.5" y1="6262.7188" y2="6262.7188"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3846.5" x2="3846.5" y1="6262.7188" y2="6275.7188"/><line style="stroke:#A80036;stroke-width:1.0;" x1="3805.5" x2="3846.5" y1="6275.7188" y2="6275.7188"/><polygon fill="#A80036" points="3815.5,6271.7188,3805.5,6275.7188,3815.5,6279.7188,3811.5,6275.7188" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="3811.5" y="6257.6528">AUTHENTICATION-65</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="203" x="3963.5" y="6257.6528">model.notifyVerificationToPISP()</text><polygon fill="#A80036" points="2078.5,6300.8516,2068.5,6304.8516,2078.5,6308.8516,2074.5,6304.8516" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="2072.5" x2="3793.5" y1="6304.8516" y2="6304.8516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2084.5" y="6299.7856">AUTHENTICATION-66</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="176" x="2236.5" y="6299.7856">PATCH /consents/1a2b3c4d</text><rect fill="#ADD8E6" filter="url(#fbd4m1bjrz3h2)" height="129" style="stroke:#A80036;stroke-width:1.0;" width="184" x="3605" y="6317.8516"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="176" x="3609" y="6333.9185">PATCH /consents/1a2b3c4d</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="130" x="3609" y="6349.0513">FSIOP-Source: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="157" x="3609" y="6364.1841">FSIOP-Destination: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3609" y="6379.3169">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="3617" y="6394.4497">credential: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="3625" y="6409.5825">status: "VERIFIED"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3617" y="6424.7153">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="3609" y="6439.8481">}</text><polygon fill="#A80036" points="3787.5,6469.0469,3797.5,6473.0469,3787.5,6477.0469,3791.5,6473.0469" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="2067.5" x2="3793.5" y1="6473.0469" y2="6473.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="2074.5" y="6467.981">AUTHENTICATION-67</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="2226.5" y="6467.981">200 OK</text><polygon fill="#A80036" points="1562.5,6498.1797,1552.5,6502.1797,1562.5,6506.1797,1558.5,6502.1797" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1556.5" x2="2056.5" y1="6502.1797" y2="6502.1797"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1568.5" y="6497.1138">AUTHENTICATION-68</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="176" x="1720.5" y="6497.1138">PATCH /consents/1a2b3c4d</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1551.5" x2="1598.5" y1="6526.3125" y2="6526.3125"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1598.5" x2="1598.5" y1="6526.3125" y2="6539.3125"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1557.5" x2="1598.5" y1="6539.3125" y2="6539.3125"/><polygon fill="#A80036" points="1567.5,6535.3125,1557.5,6539.3125,1567.5,6543.3125,1563.5,6539.3125" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1563.5" y="6521.2466">AUTHENTICATION-69</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="340" x="1715.5" y="6521.2466">const model = await loadFromKVS({key: 1a2b3c4d})</text><polygon fill="#A80036" points="1052.5,6569.4453,1042.5,6573.4453,1052.5,6577.4453,1048.5,6573.4453" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1046.5" x2="1540.5" y1="6573.4453" y2="6573.4453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1058.5" y="6568.3794">AUTHENTICATION-70</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="172" x="1210.5" y="6568.3794">Verified Response recieved</text><polygon fill="#A80036" points="2050.5,6598.5781,2060.5,6602.5781,2050.5,6606.5781,2054.5,6602.5781" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1546.5" x2="2056.5" y1="6602.5781" y2="6602.5781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="1553.5" y="6597.5122">AUTHENTICATION-71</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="1705.5" y="6597.5122">200 OK</text><rect fill="#FBFB77" filter="url(#fbd4m1bjrz3h2)" height="23" style="stroke:#A80036;stroke-width:1.0;" width="148" x="1046" y="6615.5781"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="140" x="1050" y="6631.645">state: accountsLinked</text><polygon fill="#A80036" points="571.5,6660.8438,561.5,6664.8438,571.5,6668.8438,567.5,6664.8438" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="565.5" x2="1025.5" y1="6664.8438" y2="6664.8438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="577.5" y="6659.7778">AUTHENTICATION-72</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="206" x="729.5" y="6659.7778">return Accounts linked response</text><polygon fill="#A80036" points="92.5,6689.9766,82.5,6693.9766,92.5,6697.9766,88.5,6693.9766" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="86.5" x2="549.5" y1="6693.9766" y2="6693.9766"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="98.5" y="6688.9106">AUTHENTICATION-73</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154" x="250.5" y="6688.9106">200 OK Accounts Linked</text><rect fill="#ADD8E6" filter="url(#fbd4m1bjrz3h2)" height="98" style="stroke:#A80036;stroke-width:1.0;" width="217" x="328" y="6706.9766"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="332" y="6723.0435">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="340" y="6738.1763">credential: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="348" y="6753.3091">status: "VERIFIED"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="340" y="6768.4419">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="201" x="340" y="6783.5747">currentState="accountsLinked"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="332" y="6798.7075">}</text><!--MD5=[15080d0188aae81fa684a4bd6721203c]
@startuml

title PISP Linking Web

participant "PISP Backend" as PISP
box "PISP tp-scheme-adapter"
  participant "outbound-server" as PISP_TP_OUT
  participant "PISPLinkingModel" as PISP_LM
  participant "inbound-server" as PISP_TP_IN
end box
box "Mojaloop"
    participant Switch
    participant "Auth Service" as AUTH
    participant "Account Lookup Service" as ALS
end box
box "DFSP tp-scheme-adapter"
  participant "inbound-server" as DFSP_TP_IN
  participant "DFSPLinkingModel" as DFSP_LM
end box
participant DFSPAuthorizeSimulator

== Request Consent - Web ==
autonumber 1 "<b>REQUEST-CONSENT-#</b>"
rnote right of PISP
PISP presents accounts to user. User selects one or more accounts to link.
end note
PISP -> PISP_TP_OUT: POST /linking/request-consent
rnote right of PISP #LightBlue
POST /linking/request-consent
{
  "accounts": [
    { accountNickname: "XXXXXXnt", id: "dfspa.username.1234", currency: "ZAR" },
    { accountNickname: "SpeXXXXXXXXnt", id: "dfspa.username.5678", currency: "USD" }
  ],
  callbackURI: 'pisp-app://callback'
}
end note


activate PISP
activate PISP_TP_OUT

PISP_TP_OUT -> PISP_TP_OUT: const model = await create()
rnote right of PISP_TP_OUT: state: start
PISP_TP_OUT -> PISP_LM: model.requestConsent()

activate PISP_LM

PISP_LM -> PISP_LM: ThirdpartyRequests.postConsentRequests()
PISP_LM -> Switch: POST /consentRequests
rnote right of PISP_LM #LightBlue
POST /consentRequests
FSIOP-Source: pispa
FSIOP-Destination: dfspa
{
  // consentRequestId will be the uuid created
  // at the PRELINKING-2
  consentRequestId: 6789
  scopes: [{
    accountId: 'dfspa.username.1234',
    actions: ['accounts.getBalance', 'accounts.transfer'],
    accountId: 'dfspa.username.5678',
    actions: ['accounts.getBalance', 'accounts.transfer'],
  }],
  // model will add `authChannels`
  authChannels: ["WEB", "OTP"],
  callbackURI: 'pisp-app://callback...'
}
end note

activate Switch
Switch - -> PISP_LM: 202 Accepted
Switch -> DFSP_TP_IN: POST /consentRequests
activate DFSP_TP_IN

DFSP_TP_IN - -> Switch: 202 Accepted
DFSP_TP_IN -> DFSP_TP_IN: const model = await create()
rnote right of DFSP_TP_IN: state: start
DFSP_TP_IN -> DFSP_LM: model.requestConsent()
activate DFSP_LM
deactivate Switch
deactivate DFSP_TP_IN
DFSP_LM -> DFSP_LM: DFSPBackendRequests.validateConsentRequest()
DFSP_LM -> DFSPAuthorizeSimulator: ""POST /store/consentRequests/6789""
activate DFSPAuthorizeSimulator
DFSPAuthorizeSimulator -> DFSPAuthorizeSimulator: store consentRequest details
DFSPAuthorizeSimulator -> DFSP_LM: 201 Created
rnote right of DFSP_LM: state: consentRequestValidatedAndStored
deactivate DFSPAuthorizeSimulator

DFSP_LM -> Switch: PUT /consentRequests/6789
activate Switch

rnote left of DFSP_LM #LightBlue
PUT /consentRequests/6789
FSIOP-Source: pispa
FSIOP-Destination: dfspa
{
  consentRequestId: 6789
  scopes: [{
    accountId: 'dfspa.username.1234',
    actions: ['accounts.getBalance', 'accounts.transfer'],
    accountId: 'dfspa.username.5678',
    actions: ['accounts.getBalance', 'accounts.transfer'],
  }],
  authChannels: ["WEB"],
  callbackURI: 'pisp-app://callback...',
  authURI: 'dfspa.com/authorize?consentRequestId=6789' // this is new
}
end note
Switch - -> DFSP_LM: 202 ACCEPTED
DFSP_LM -> DFSP_LM: this.saveToKVS()
deactivate DFSP_LM
Switch ->  PISP_TP_IN: PUT /consentRequests/6789
activate PISP_TP_IN
PISP_TP_IN - -> Switch: 200 OK
deactivate Switch
activate PISP_LM
PISP_TP_IN - -> PISP_LM: Consent Request response recieved
deactivate PISP_TP_IN
rnote right of PISP_LM: state: webAuthenticationChannelResponseRecieved
PISP_LM - -> PISP_LM: this.saveToKVS()
PISP_LM -> PISP_TP_OUT: return Authentication Response
deactivate PISP_LM
PISP_TP_OUT - -> PISP: 200 OK Autentication Response
rnote left of PISP_TP_OUT #LightBlue
{
  channelResponse: {
    consentRequestId: 6789
    scopes: [{
      accountId: 'dfspa.username.1234',
      actions: ['accounts.getBalance', 'accounts.transfer'],
      accountId: 'dfspa.username.5678',
      actions: ['accounts.getBalance', 'accounts.transfer'],
    }],
    authChannels: ["WEB"],
    callbackURI: 'pisp-app://callback...',
    authURI: 'dfspa.com/authorize?consentRequestId=6789' // this is new
  },
  currentState="OTPAuthenticationChannelResponseRecieved"
}
end note
deactivate PISP_TP_OUT
deactivate PISP

note over PISP, DFSPAuthorizeSimulator
  The PISP is expected to redirect to the DFSP's `authUri` in their application to let the end user complete the web login flow.
  Logging in successfully should provide the PISP with a secret to use in the next linking step.
end note

== Authentication+Grant Consent+Register Credential ==
autonumber 1 "<b>AUTHENTICATION-#</b>"
rnote right of PISP
PISP has obtained authToken from end-user(OTP) or through a callback(Web).
end note
PISP -> PISP_TP_OUT: POST /linking/request-consent/6789/authenticate
rnote right of PISP #LightBlue
POST /linking/request-consent/6789/authenticate
{
  authToken: '123456'
}
end note

activate PISP
activate PISP_TP_OUT

PISP_TP_OUT -> PISP_TP_OUT: const model = await loadFromKVS({key: 6789})
rnote right of PISP_TP_OUT: state: webAuthenticationChannelResponseRecieved or OTPAuthenticationChannelResponseRecieved
PISP_TP_OUT -> PISP_LM: model.authenticate()

activate PISP_LM

PISP_LM -> PISP_LM: ThirdpartyRequests.patchConsentRequests()
PISP_LM -> Switch: PATCH /consentRequests/6789
rnote right of PISP_LM #LightBlue
PATCH /consentRequests/6789
FSIOP-Source: pispa
FSIOP-Destination: dfspa
{
  authToken: '124356'
}
end note

activate Switch
Switch - -> PISP_LM: 202 Accepted
deactivate PISP_LM
Switch -> DFSP_TP_IN: PATCH /consentRequests/6789
activate DFSP_TP_IN
DFSP_TP_IN - -> Switch: 202 Accepted
DFSP_TP_IN -> DFSP_TP_IN: const model = await loadFromKVS({key: 6789})
rnote right of DFSP_TP_IN: state: consentRequestValidatedAndStored
DFSP_TP_IN -> DFSP_LM: model.validateAuthToken()
activate DFSP_LM
deactivate Switch
deactivate DFSP_TP_IN

DFSP_LM -> DFSP_LM: DFSPBackendRequests.validateAuthToken()
rnote right of DFSP_LM #LightBlue
Do we need two backend endpoints for validating
web authTokens and OTP authTokens? Or is a DFSP expected to
validate both cases with one endpoint?

POST /validateAuthToken
{
  consentRequestId: '6789'
  authChannel: model.data.authChannel,
  authToken: '124356'
}
end note
rnote right of DFSP_LM: state: authTokenValidated

DFSP_LM -> DFSP_LM: const consentId = uuid()
DFSP_LM -> DFSP_LM: model.grantConsent()
DFSP_LM -> DFSP_LM: ThirdpartyRequests.postConsents()
rnote right of DFSP_LM: state: consentGranted
rnote right of DFSP_LM #LightBlue
It's important to save the model with the consentId from this point onwards!
Requests will not contain a consentRequestId in the upcoming requests.
This may require changing `PersistentModel` to have a secondary key it can
store the model with.
end note
DFSP_LM -> DFSP_LM: this.saveToKVS({key: '1a2b3c4d'})

activate Switch
DFSP_LM -> Switch: POST /consents

rnote left of DFSP_LM #LightBlue
POST /consents
FSIOP-Source: dfspa
FSIOP-Destination: pispa
{
  consentId: 1a2b3c4d
  consentRequestId: 6789
  scopes: model.data.scopes
}
end note
Switch - -> DFSP_LM: 202 ACCEPTED
deactivate DFSP_LM
activate PISP_TP_IN
Switch ->  PISP_TP_IN: POST /consents
PISP_TP_IN -> PISP_TP_IN: const model = await loadFromKVS({key: 6789})
activate PISP_LM
PISP_TP_IN -> PISP_LM: model.registerCredential()
PISP_TP_IN - -> Switch: 202 Accepted
deactivate PISP_TP_IN
deactivate Switch
rnote right of PISP_LM: state: consentRecieved
rnote right of PISP_LM #LightBlue
It's important to save the model with the consentId from this point onwards!
Requests will not contain a consentRequestId in the upcoming requests.
This may require changing `PersistentModel` to have a secondary key it can
store the model with.
end note
PISP_LM - -> PISP_LM: const challenge = deriveChallenge(consentRequest)
PISP_LM - -> PISP_LM: this.saveToKVS({key: '1a2b3c4d'})

PISP_LM -> PISP_LM: ThirdpartyRequests.putConsents()
rnote right of PISP_LM: state: signedConsentSent
activate Switch
PISP_LM -> Switch: PUT /consents/1a2b3c4d

rnote right of PISP_LM #LightBlue
PUT /consents/1a2b3c4d
FSIOP-Source: pispa
FSIOP-Destination: dfspa
{
  scopes: [{
    accountId: 'dfspa.username.1234',
    actions: ['accounts.getBalance', 'accounts.transfer'],
    accountId: 'dfspa.username.5678',
    actions: ['accounts.getBalance', 'accounts.transfer'],
  }],
  credential: {
    credentialType: "FIDO",
    status: "PENDING",
    payload: PublicKeyCredential
  }
}
end note

Switch - -> PISP_LM: 202 Accepted
deactivate PISP_LM
Switch -> DFSP_TP_IN: PUT /consents/1a2b3c4d
activate DFSP_TP_IN

DFSP_TP_IN -> DFSP_TP_IN: const model = await loadFromKVS({key: 1a2b3c4d})
activate DFSP_LM
rnote right of DFSP_TP_IN: state: signedConsentRecieved
DFSP_TP_IN -> DFSP_LM: model.validateSignedConsent()
rnote right of DFSP_TP_IN: state: pendingRegistrationAndValidation
DFSP_TP_IN - -> Switch: 202 Accepted
deactivate Switch
deactivate DFSP_TP_IN
DFSP_LM -> DFSP_LM: Check signed consent.
rnote right of DFSP_LM #LightBlue
Does this need a backend request or can the scheme adapter check the consent.
end note
rnote right of DFSP_LM: state: signedConsentChecked
DFSP_LM-> DFSP_LM: model.validateWithAuthService()
activate Switch
DFSP_LM -> Switch: POST /consents/1a2b3c4d

rnote left of DFSP_LM #LightBlue
POST /consents/1a2b3c4d
FSIOP-Source: dfspa
FSIOP-Destination: central-auth
{
  scopes: [{
    accountId: 'dfspa.username.1234',
    actions: ['accounts.getBalance', 'accounts.transfer'],
    accountId: 'dfspa.username.5678',
    actions: ['accounts.getBalance', 'accounts.transfer'],
  }],
  credential: {
    credentialType: "FIDO",
    status: "PENDING",
    payload: PublicKeyCredential
  }
}
end note
Switch - -> DFSP_LM: 202 Accepted
DFSP_LM -> DFSP_LM: this.saveToKVS()
deactivate DFSP_LM

Switch -> AUTH: POST /consents/1a2b3c4d
activate AUTH
AUTH - -> Switch: 202 Accepted
AUTH -> AUTH: Check consent.
AUTH -> Switch: PUT /consents/1a2b3c4d

rnote left of AUTH #LightBlue
PUT /consents/1a2b3c4d
FSIOP-Source: central-auth
FSIOP-Destination: dfspa
{
  scopes: [{
    accountId: 'dfspa.username.1234',
    actions: ['accounts.getBalance', 'accounts.transfer'],
    accountId: 'dfspa.username.5678',
    actions: ['accounts.getBalance', 'accounts.transfer'],
  }],
  credential: {
    credentialType: "FIDO",
    status: "VERIFIED",
    payload: PublicKeyCredential
  }
}
end note

Switch - -> AUTH: 200 OK
activate DFSP_TP_IN
Switch -> DFSP_TP_IN: PUT /consents/1a2b3c4d
DFSP_TP_IN -> DFSP_TP_IN: const model = await loadFromKVS({key: 1a2b3c4d})
DFSP_TP_IN -> DFSP_TP_IN: consentResponseRecieved()
rnote right of DFSP_TP_IN: state: consentResponseRecieved
DFSP_TP_IN -> DFSP_LM: Auth Service response recieved
activate DFSP_LM
DFSP_TP_IN - -> Switch: 200 OK
deactivate Switch
deactivate DFSP_TP_IN

AUTH -> ALS: POST /participants/CONSENTS/1a2b3c4d
activate ALS
ALS - -> AUTH: 202 Accepted
deactivate AUTH

ALS -> DFSP_TP_IN: PUT /participants/CONSENTS/1a2b3c4d
activate DFSP_TP_IN
DFSP_TP_IN -> DFSP_TP_IN: const model = await loadFromKVS({key: 1a2b3c4d})
DFSP_TP_IN -> DFSP_TP_IN: participantResponseRecieved()
rnote right of DFSP_TP_IN: state: participantsResponseRecieved
DFSP_TP_IN -> DFSP_LM: Participant response recieved
DFSP_TP_IN - -> ALS: 200 Accepted
deactivate ALS
deactivate DFSP_TP_IN
rnote right of DFSP_LM: state: consentRegisteredAndValidated
DFSP_LM -> DFSP_LM: model.finalizeConsent()

loop for each scope in ""Consents.scopes""
DFSP_LM -> Switch: POST /participants/THIRD_PARTY_LINK/dfsp.username.5678
Switch - -> DFSP_LM: 202 Accepted
Switch -> ALS: POST /participants/THIRD_PARTY_LINK/dfsp.username.5678
ALS - -> Switch: 202 Accepted
ALS -> Switch: PUT /participants/THIRD_PARTY_LINK/dfsp.username.5678
Switch - -> ALS: 200 OK
Switch -> DFSP_TP_IN: PUT /participants/THIRD_PARTY_LINK/dfsp.username.5678
DFSP_TP_IN - -> Switch: 200 OK
DFSP_TP_IN -> DFSP_LM: Participant response recieved
end

DFSP_LM -> DFSP_LM: await Promise.all()
DFSP_LM -> DFSP_LM: state: PISPDFSPLinkEstablished
DFSP_LM -> DFSP_LM: model.notifyVerificationToPISP()
DFSP_LM -> Switch: PATCH /consents/1a2b3c4d
rnote left of DFSP_LM #LightBlue
PATCH /consents/1a2b3c4d
FSIOP-Source: dfspa
FSIOP-Destination: pispa
{
  credential: {
    status: "VERIFIED"
  }
}
end note
activate Switch
Switch - -> DFSP_LM: 200 OK
deactivate DFSP_LM
Switch -> PISP_TP_IN: PATCH /consents/1a2b3c4d
activate PISP_TP_IN
PISP_TP_IN -> PISP_TP_IN: const model = await loadFromKVS({key: 1a2b3c4d})

activate PISP_LM
PISP_TP_IN -> PISP_LM: Verified Response recieved
PISP_TP_IN - -> Switch: 200 OK
deactivate PISP_TP_IN
deactivate Switch
rnote right of PISP_LM: state: accountsLinked
PISP_LM - -> PISP_TP_OUT: return Accounts linked response
deactivate PISP_LM
PISP_TP_OUT - -> PISP: 200 OK Accounts Linked
rnote left of PISP_TP_OUT #LightBlue
{
  credential: {
    status: "VERIFIED"
  }
  currentState="accountsLinked"
}
end note
@enduml

PlantUML version 1.2021.00(Sun Jan 10 05:25:05 EST 2021)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>